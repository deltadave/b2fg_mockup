var Ut=Object.freeze,Tr=Object.defineProperty;var Xt=(n,e)=>Ut(Tr(n,"raw",{value:Ut(e||n.slice())}));(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();var nt=!1,rt=!1,ee=[],st=-1;function Pr(n){Rr(n)}function Rr(n){ee.includes(n)||ee.push(n),Nr()}function Dr(n){let e=ee.indexOf(n);e!==-1&&e>st&&ee.splice(e,1)}function Nr(){!rt&&!nt&&(nt=!0,queueMicrotask(Or))}function Or(){nt=!1,rt=!0;for(let n=0;n<ee.length;n++)ee[n](),st=n;ee.length=0,st=-1,rt=!1}var fe,ae,pe,mn,it=!0;function Br(n){it=!1,n(),it=!0}function zr(n){fe=n.reactive,pe=n.release,ae=e=>n.effect(e,{scheduler:t=>{it?Pr(t):t()}}),mn=n.raw}function Wt(n){ae=n}function jr(n){let e=()=>{};return[r=>{let s=ae(r);return n._x_effects||(n._x_effects=new Set,n._x_runEffects=()=>{n._x_effects.forEach(i=>i())}),n._x_effects.add(s),e=()=>{s!==void 0&&(n._x_effects.delete(s),pe(s))},s},()=>{e()}]}function yn(n,e){let t=!0,r,s=ae(()=>{let i=n();JSON.stringify(i),t?r=i:queueMicrotask(()=>{e(i,r),r=i}),t=!1});return()=>pe(s)}var bn=[],vn=[],wn=[];function Ur(n){wn.push(n)}function wt(n,e){typeof e=="function"?(n._x_cleanups||(n._x_cleanups=[]),n._x_cleanups.push(e)):(e=n,vn.push(e))}function Sn(n){bn.push(n)}function Cn(n,e,t){n._x_attributeCleanups||(n._x_attributeCleanups={}),n._x_attributeCleanups[e]||(n._x_attributeCleanups[e]=[]),n._x_attributeCleanups[e].push(t)}function xn(n,e){n._x_attributeCleanups&&Object.entries(n._x_attributeCleanups).forEach(([t,r])=>{(e===void 0||e.includes(t))&&(r.forEach(s=>s()),delete n._x_attributeCleanups[t])})}function Xr(n){var e,t;for((e=n._x_effects)==null||e.forEach(Dr);(t=n._x_cleanups)!=null&&t.length;)n._x_cleanups.pop()()}var St=new MutationObserver(Et),Ct=!1;function xt(){St.observe(document,{subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0}),Ct=!0}function _n(){Wr(),St.disconnect(),Ct=!1}var ye=[];function Wr(){let n=St.takeRecords();ye.push(()=>n.length>0&&Et(n));let e=ye.length;queueMicrotask(()=>{if(ye.length===e)for(;ye.length>0;)ye.shift()()})}function $(n){if(!Ct)return n();_n();let e=n();return xt(),e}var _t=!1,Re=[];function Vr(){_t=!0}function qr(){_t=!1,Et(Re),Re=[]}function Et(n){if(_t){Re=Re.concat(n);return}let e=[],t=new Set,r=new Map,s=new Map;for(let i=0;i<n.length;i++)if(!n[i].target._x_ignoreMutationObserver&&(n[i].type==="childList"&&(n[i].removedNodes.forEach(a=>{a.nodeType===1&&a._x_marker&&t.add(a)}),n[i].addedNodes.forEach(a=>{if(a.nodeType===1){if(t.has(a)){t.delete(a);return}a._x_marker||e.push(a)}})),n[i].type==="attributes")){let a=n[i].target,o=n[i].attributeName,l=n[i].oldValue,c=()=>{r.has(a)||r.set(a,[]),r.get(a).push({name:o,value:a.getAttribute(o)})},u=()=>{s.has(a)||s.set(a,[]),s.get(a).push(o)};a.hasAttribute(o)&&l===null?c():a.hasAttribute(o)?(u(),c()):u()}s.forEach((i,a)=>{xn(a,i)}),r.forEach((i,a)=>{bn.forEach(o=>o(a,i))});for(let i of t)e.some(a=>a.contains(i))||vn.forEach(a=>a(i));for(let i of e)i.isConnected&&wn.forEach(a=>a(i));e=null,t=null,r=null,s=null}function En(n){return Ee(ue(n))}function _e(n,e,t){return n._x_dataStack=[e,...ue(t||n)],()=>{n._x_dataStack=n._x_dataStack.filter(r=>r!==e)}}function ue(n){return n._x_dataStack?n._x_dataStack:typeof ShadowRoot=="function"&&n instanceof ShadowRoot?ue(n.host):n.parentNode?ue(n.parentNode):[]}function Ee(n){return new Proxy({objects:n},Hr)}var Hr={ownKeys({objects:n}){return Array.from(new Set(n.flatMap(e=>Object.keys(e))))},has({objects:n},e){return e==Symbol.unscopables?!1:n.some(t=>Object.prototype.hasOwnProperty.call(t,e)||Reflect.has(t,e))},get({objects:n},e,t){return e=="toJSON"?Gr:Reflect.get(n.find(r=>Reflect.has(r,e))||{},e,t)},set({objects:n},e,t,r){const s=n.find(a=>Object.prototype.hasOwnProperty.call(a,e))||n[n.length-1],i=Object.getOwnPropertyDescriptor(s,e);return i!=null&&i.set&&(i!=null&&i.get)?i.set.call(r,t)||!0:Reflect.set(s,e,t)}};function Gr(){return Reflect.ownKeys(this).reduce((e,t)=>(e[t]=Reflect.get(this,t),e),{})}function Fn(n){let e=r=>typeof r=="object"&&!Array.isArray(r)&&r!==null,t=(r,s="")=>{Object.entries(Object.getOwnPropertyDescriptors(r)).forEach(([i,{value:a,enumerable:o}])=>{if(o===!1||a===void 0||typeof a=="object"&&a!==null&&a.__v_skip)return;let l=s===""?i:"".concat(s,".").concat(i);typeof a=="object"&&a!==null&&a._x_interceptor?r[i]=a.initialize(n,l,i):e(a)&&a!==r&&!(a instanceof Element)&&t(a,l)})};return t(n)}function An(n,e=()=>{}){let t={initialValue:void 0,_x_interceptor:!0,initialize(r,s,i){return n(this.initialValue,()=>Kr(r,s),a=>at(r,s,a),s,i)}};return e(t),r=>{if(typeof r=="object"&&r!==null&&r._x_interceptor){let s=t.initialize.bind(t);t.initialize=(i,a,o)=>{let l=r.initialize(i,a,o);return t.initialValue=l,s(i,a,o)}}else t.initialValue=r;return t}}function Kr(n,e){return e.split(".").reduce((t,r)=>t[r],n)}function at(n,e,t){if(typeof e=="string"&&(e=e.split(".")),e.length===1)n[e[0]]=t;else{if(e.length===0)throw error;return n[e[0]]||(n[e[0]]={}),at(n[e[0]],e.slice(1),t)}}var $n={};function z(n,e){$n[n]=e}function ot(n,e){let t=Yr(e);return Object.entries($n).forEach(([r,s])=>{Object.defineProperty(n,"$".concat(r),{get(){return s(e,t)},enumerable:!1})}),n}function Yr(n){let[e,t]=Pn(n),r={interceptor:An,...e};return wt(n,t),r}function Jr(n,e,t,...r){try{return t(...r)}catch(s){xe(s,n,e)}}function xe(n,e,t=void 0){n=Object.assign(n!=null?n:{message:"No error message given."},{el:e,expression:t}),console.warn("Alpine Expression Error: ".concat(n.message,"\n\n").concat(t?'Expression: "'+t+'"\n\n':""),e),setTimeout(()=>{throw n},0)}var Te=!0;function Mn(n){let e=Te;Te=!1;let t=n();return Te=e,t}function te(n,e,t={}){let r;return T(n,e)(s=>r=s,t),r}function T(...n){return Ln(...n)}var Ln=kn;function Qr(n){Ln=n}function kn(n,e){let t={};ot(t,n);let r=[t,...ue(n)],s=typeof e=="function"?Zr(r,e):ts(r,e,n);return Jr.bind(null,n,e,s)}function Zr(n,e){return(t=()=>{},{scope:r={},params:s=[]}={})=>{let i=e.apply(Ee([r,...n]),s);De(t,i)}}var He={};function es(n,e){if(He[n])return He[n];let t=Object.getPrototypeOf(async function(){}).constructor,r=/^[\n\s]*if.*\(.*\)/.test(n.trim())||/^(let|const)\s/.test(n.trim())?"(async()=>{ ".concat(n," })()"):n,i=(()=>{try{let a=new t(["__self","scope"],"with (scope) { __self.result = ".concat(r," }; __self.finished = true; return __self.result;"));return Object.defineProperty(a,"name",{value:"[Alpine] ".concat(n)}),a}catch(a){return xe(a,e,n),Promise.resolve()}})();return He[n]=i,i}function ts(n,e,t){let r=es(e,t);return(s=()=>{},{scope:i={},params:a=[]}={})=>{r.result=void 0,r.finished=!1;let o=Ee([i,...n]);if(typeof r=="function"){let l=r(r,o).catch(c=>xe(c,t,e));r.finished?(De(s,r.result,o,a,t),r.result=void 0):l.then(c=>{De(s,c,o,a,t)}).catch(c=>xe(c,t,e)).finally(()=>r.result=void 0)}}}function De(n,e,t,r,s){if(Te&&typeof e=="function"){let i=e.apply(t,r);i instanceof Promise?i.then(a=>De(n,a,t,r)).catch(a=>xe(a,s,e)):n(i)}else typeof e=="object"&&e instanceof Promise?e.then(i=>n(i)):n(e)}var Ft="x-";function ge(n=""){return Ft+n}function ns(n){Ft=n}var Ne={},hn;function L(n,e){return Ne[n]=e,{before(t){if(!Ne[t]){console.warn(String.raw(hn||(hn=Xt(["Cannot find directive `","`. `","` will use the default order of execution"],["Cannot find directive \\`","\\`. \\`","\\` will use the default order of execution"])),t,n));return}const r=Z.indexOf(t);Z.splice(r>=0?r:Z.indexOf("DEFAULT"),0,n)}}}function rs(n){return Object.keys(Ne).includes(n)}function At(n,e,t){if(e=Array.from(e),n._x_virtualDirectives){let i=Object.entries(n._x_virtualDirectives).map(([o,l])=>({name:o,value:l})),a=In(i);i=i.map(o=>a.find(l=>l.name===o.name)?{name:"x-bind:".concat(o.name),value:'"'.concat(o.value,'"')}:o),e=e.concat(i)}let r={};return e.map(Nn((i,a)=>r[i]=a)).filter(Bn).map(as(r,t)).sort(os).map(i=>is(n,i))}function In(n){return Array.from(n).map(Nn()).filter(e=>!Bn(e))}var lt=!1,we=new Map,Tn=Symbol();function ss(n){lt=!0;let e=Symbol();Tn=e,we.set(e,[]);let t=()=>{for(;we.get(e).length;)we.get(e).shift()();we.delete(e)},r=()=>{lt=!1,t()};n(t),r()}function Pn(n){let e=[],t=o=>e.push(o),[r,s]=jr(n);return e.push(s),[{Alpine:Fe,effect:r,cleanup:t,evaluateLater:T.bind(T,n),evaluate:te.bind(te,n)},()=>e.forEach(o=>o())]}function is(n,e){let t=()=>{},r=Ne[e.type]||t,[s,i]=Pn(n);Cn(n,e.original,i);let a=()=>{n._x_ignore||n._x_ignoreSelf||(r.inline&&r.inline(n,e,s),r=r.bind(r,n,e,s),lt?we.get(Tn).push(r):r())};return a.runCleanups=i,a}var Rn=(n,e)=>({name:t,value:r})=>(t.startsWith(n)&&(t=t.replace(n,e)),{name:t,value:r}),Dn=n=>n;function Nn(n=()=>{}){return({name:e,value:t})=>{let{name:r,value:s}=On.reduce((i,a)=>a(i),{name:e,value:t});return r!==e&&n(r,e),{name:r,value:s}}}var On=[];function $t(n){On.push(n)}function Bn({name:n}){return zn().test(n)}var zn=()=>new RegExp("^".concat(Ft,"([^:^.]+)\\b"));function as(n,e){return({name:t,value:r})=>{let s=t.match(zn()),i=t.match(/:([a-zA-Z0-9\-_:]+)/),a=t.match(/\.[^.\]]+(?=[^\]]*$)/g)||[],o=e||n[t]||t;return{type:s?s[1]:null,value:i?i[1]:null,modifiers:a.map(l=>l.replace(".","")),expression:r,original:o}}}var ct="DEFAULT",Z=["ignore","ref","data","id","anchor","bind","init","for","model","modelable","transition","show","if",ct,"teleport"];function os(n,e){let t=Z.indexOf(n.type)===-1?ct:n.type,r=Z.indexOf(e.type)===-1?ct:e.type;return Z.indexOf(t)-Z.indexOf(r)}function Se(n,e,t={}){n.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0,cancelable:!0}))}function se(n,e){if(typeof ShadowRoot=="function"&&n instanceof ShadowRoot){Array.from(n.children).forEach(s=>se(s,e));return}let t=!1;if(e(n,()=>t=!0),t)return;let r=n.firstElementChild;for(;r;)se(r,e),r=r.nextElementSibling}function D(n,...e){console.warn("Alpine Warning: ".concat(n),...e)}var Vt=!1;function ls(){Vt&&D("Alpine has already been initialized on this page. Calling Alpine.start() more than once can cause problems."),Vt=!0,document.body||D("Unable to initialize. Trying to load Alpine before `<body>` is available. Did you forget to add `defer` in Alpine's `<script>` tag?"),Se(document,"alpine:init"),Se(document,"alpine:initializing"),xt(),Ur(e=>V(e,se)),wt(e=>me(e)),Sn((e,t)=>{At(e,t).forEach(r=>r())});let n=e=>!ze(e.parentElement,!0);Array.from(document.querySelectorAll(Xn().join(","))).filter(n).forEach(e=>{V(e)}),Se(document,"alpine:initialized"),setTimeout(()=>{fs()})}var Mt=[],jn=[];function Un(){return Mt.map(n=>n())}function Xn(){return Mt.concat(jn).map(n=>n())}function Wn(n){Mt.push(n)}function Vn(n){jn.push(n)}function ze(n,e=!1){return he(n,t=>{if((e?Xn():Un()).some(s=>t.matches(s)))return!0})}function he(n,e){if(n){if(e(n))return n;if(n._x_teleportBack&&(n=n._x_teleportBack),!!n.parentElement)return he(n.parentElement,e)}}function cs(n){return Un().some(e=>n.matches(e))}var qn=[];function us(n){qn.push(n)}var ds=1;function V(n,e=se,t=()=>{}){he(n,r=>r._x_ignore)||ss(()=>{e(n,(r,s)=>{r._x_marker||(t(r,s),qn.forEach(i=>i(r,s)),At(r,r.attributes).forEach(i=>i()),r._x_ignore||(r._x_marker=ds++),r._x_ignore&&s())})})}function me(n,e=se){e(n,t=>{Xr(t),xn(t),delete t._x_marker})}function fs(){[["ui","dialog",["[x-dialog], [x-popover]"]],["anchor","anchor",["[x-anchor]"]],["sort","sort",["[x-sort]"]]].forEach(([e,t,r])=>{rs(t)||r.some(s=>{if(document.querySelector(s))return D('found "'.concat(s,'", but missing ').concat(e," plugin")),!0})})}var ut=[],Lt=!1;function kt(n=()=>{}){return queueMicrotask(()=>{Lt||setTimeout(()=>{dt()})}),new Promise(e=>{ut.push(()=>{n(),e()})})}function dt(){for(Lt=!1;ut.length;)ut.shift()()}function ps(){Lt=!0}function It(n,e){return Array.isArray(e)?qt(n,e.join(" ")):typeof e=="object"&&e!==null?gs(n,e):typeof e=="function"?It(n,e()):qt(n,e)}function qt(n,e){let t=s=>s.split(" ").filter(i=>!n.classList.contains(i)).filter(Boolean),r=s=>(n.classList.add(...s),()=>{n.classList.remove(...s)});return e=e===!0?e="":e||"",r(t(e))}function gs(n,e){let t=o=>o.split(" ").filter(Boolean),r=Object.entries(e).flatMap(([o,l])=>l?t(o):!1).filter(Boolean),s=Object.entries(e).flatMap(([o,l])=>l?!1:t(o)).filter(Boolean),i=[],a=[];return s.forEach(o=>{n.classList.contains(o)&&(n.classList.remove(o),a.push(o))}),r.forEach(o=>{n.classList.contains(o)||(n.classList.add(o),i.push(o))}),()=>{a.forEach(o=>n.classList.add(o)),i.forEach(o=>n.classList.remove(o))}}function je(n,e){return typeof e=="object"&&e!==null?hs(n,e):ms(n,e)}function hs(n,e){let t={};return Object.entries(e).forEach(([r,s])=>{t[r]=n.style[r],r.startsWith("--")||(r=ys(r)),n.style.setProperty(r,s)}),setTimeout(()=>{n.style.length===0&&n.removeAttribute("style")}),()=>{je(n,t)}}function ms(n,e){let t=n.getAttribute("style",e);return n.setAttribute("style",e),()=>{n.setAttribute("style",t||"")}}function ys(n){return n.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function ft(n,e=()=>{}){let t=!1;return function(){t?e.apply(this,arguments):(t=!0,n.apply(this,arguments))}}L("transition",(n,{value:e,modifiers:t,expression:r},{evaluate:s})=>{typeof r=="function"&&(r=s(r)),r!==!1&&(!r||typeof r=="boolean"?vs(n,t,e):bs(n,r,e))});function bs(n,e,t){Hn(n,It,""),{enter:s=>{n._x_transition.enter.during=s},"enter-start":s=>{n._x_transition.enter.start=s},"enter-end":s=>{n._x_transition.enter.end=s},leave:s=>{n._x_transition.leave.during=s},"leave-start":s=>{n._x_transition.leave.start=s},"leave-end":s=>{n._x_transition.leave.end=s}}[t](e)}function vs(n,e,t){Hn(n,je);let r=!e.includes("in")&&!e.includes("out")&&!t,s=r||e.includes("in")||["enter"].includes(t),i=r||e.includes("out")||["leave"].includes(t);e.includes("in")&&!r&&(e=e.filter((y,w)=>w<e.indexOf("out"))),e.includes("out")&&!r&&(e=e.filter((y,w)=>w>e.indexOf("out")));let a=!e.includes("opacity")&&!e.includes("scale"),o=a||e.includes("opacity"),l=a||e.includes("scale"),c=o?0:1,u=l?be(e,"scale",95)/100:1,d=be(e,"delay",0)/1e3,f=be(e,"origin","center"),g="opacity, transform",p=be(e,"duration",150)/1e3,b=be(e,"duration",75)/1e3,m="cubic-bezier(0.4, 0.0, 0.2, 1)";s&&(n._x_transition.enter.during={transformOrigin:f,transitionDelay:"".concat(d,"s"),transitionProperty:g,transitionDuration:"".concat(p,"s"),transitionTimingFunction:m},n._x_transition.enter.start={opacity:c,transform:"scale(".concat(u,")")},n._x_transition.enter.end={opacity:1,transform:"scale(1)"}),i&&(n._x_transition.leave.during={transformOrigin:f,transitionDelay:"".concat(d,"s"),transitionProperty:g,transitionDuration:"".concat(b,"s"),transitionTimingFunction:m},n._x_transition.leave.start={opacity:1,transform:"scale(1)"},n._x_transition.leave.end={opacity:c,transform:"scale(".concat(u,")")})}function Hn(n,e,t={}){n._x_transition||(n._x_transition={enter:{during:t,start:t,end:t},leave:{during:t,start:t,end:t},in(r=()=>{},s=()=>{}){pt(n,e,{during:this.enter.during,start:this.enter.start,end:this.enter.end},r,s)},out(r=()=>{},s=()=>{}){pt(n,e,{during:this.leave.during,start:this.leave.start,end:this.leave.end},r,s)}})}window.Element.prototype._x_toggleAndCascadeWithTransitions=function(n,e,t,r){const s=document.visibilityState==="visible"?requestAnimationFrame:setTimeout;let i=()=>s(t);if(e){n._x_transition&&(n._x_transition.enter||n._x_transition.leave)?n._x_transition.enter&&(Object.entries(n._x_transition.enter.during).length||Object.entries(n._x_transition.enter.start).length||Object.entries(n._x_transition.enter.end).length)?n._x_transition.in(t):i():n._x_transition?n._x_transition.in(t):i();return}n._x_hidePromise=n._x_transition?new Promise((a,o)=>{n._x_transition.out(()=>{},()=>a(r)),n._x_transitioning&&n._x_transitioning.beforeCancel(()=>o({isFromCancelledTransition:!0}))}):Promise.resolve(r),queueMicrotask(()=>{let a=Gn(n);a?(a._x_hideChildren||(a._x_hideChildren=[]),a._x_hideChildren.push(n)):s(()=>{let o=l=>{let c=Promise.all([l._x_hidePromise,...(l._x_hideChildren||[]).map(o)]).then(([u])=>u==null?void 0:u());return delete l._x_hidePromise,delete l._x_hideChildren,c};o(n).catch(l=>{if(!l.isFromCancelledTransition)throw l})})})};function Gn(n){let e=n.parentNode;if(e)return e._x_hidePromise?e:Gn(e)}function pt(n,e,{during:t,start:r,end:s}={},i=()=>{},a=()=>{}){if(n._x_transitioning&&n._x_transitioning.cancel(),Object.keys(t).length===0&&Object.keys(r).length===0&&Object.keys(s).length===0){i(),a();return}let o,l,c;ws(n,{start(){o=e(n,r)},during(){l=e(n,t)},before:i,end(){o(),c=e(n,s)},after:a,cleanup(){l(),c()}})}function ws(n,e){let t,r,s,i=ft(()=>{$(()=>{t=!0,r||e.before(),s||(e.end(),dt()),e.after(),n.isConnected&&e.cleanup(),delete n._x_transitioning})});n._x_transitioning={beforeCancels:[],beforeCancel(a){this.beforeCancels.push(a)},cancel:ft(function(){for(;this.beforeCancels.length;)this.beforeCancels.shift()();i()}),finish:i},$(()=>{e.start(),e.during()}),ps(),requestAnimationFrame(()=>{if(t)return;let a=Number(getComputedStyle(n).transitionDuration.replace(/,.*/,"").replace("s",""))*1e3,o=Number(getComputedStyle(n).transitionDelay.replace(/,.*/,"").replace("s",""))*1e3;a===0&&(a=Number(getComputedStyle(n).animationDuration.replace("s",""))*1e3),$(()=>{e.before()}),r=!0,requestAnimationFrame(()=>{t||($(()=>{e.end()}),dt(),setTimeout(n._x_transitioning.finish,a+o),s=!0)})})}function be(n,e,t){if(n.indexOf(e)===-1)return t;const r=n[n.indexOf(e)+1];if(!r||e==="scale"&&isNaN(r))return t;if(e==="duration"||e==="delay"){let s=r.match(/([0-9]+)ms/);if(s)return s[1]}return e==="origin"&&["top","right","left","center","bottom"].includes(n[n.indexOf(e)+2])?[r,n[n.indexOf(e)+2]].join(" "):r}var G=!1;function Y(n,e=()=>{}){return(...t)=>G?e(...t):n(...t)}function Ss(n){return(...e)=>G&&n(...e)}var Kn=[];function Ue(n){Kn.push(n)}function Cs(n,e){Kn.forEach(t=>t(n,e)),G=!0,Yn(()=>{V(e,(t,r)=>{r(t,()=>{})})}),G=!1}var gt=!1;function xs(n,e){e._x_dataStack||(e._x_dataStack=n._x_dataStack),G=!0,gt=!0,Yn(()=>{_s(e)}),G=!1,gt=!1}function _s(n){let e=!1;V(n,(r,s)=>{se(r,(i,a)=>{if(e&&cs(i))return a();e=!0,s(i,a)})})}function Yn(n){let e=ae;Wt((t,r)=>{let s=e(t);return pe(s),()=>{}}),n(),Wt(e)}function Jn(n,e,t,r=[]){switch(n._x_bindings||(n._x_bindings=fe({})),n._x_bindings[e]=t,e=r.includes("camel")?Is(e):e,e){case"value":Es(n,t);break;case"style":As(n,t);break;case"class":Fs(n,t);break;case"selected":case"checked":$s(n,e,t);break;default:Qn(n,e,t);break}}function Es(n,e){if(tr(n))n.attributes.value===void 0&&(n.value=e),window.fromModel&&(typeof e=="boolean"?n.checked=Pe(n.value)===e:n.checked=Ht(n.value,e));else if(Tt(n))Number.isInteger(e)?n.value=e:!Array.isArray(e)&&typeof e!="boolean"&&![null,void 0].includes(e)?n.value=String(e):Array.isArray(e)?n.checked=e.some(t=>Ht(t,n.value)):n.checked=!!e;else if(n.tagName==="SELECT")ks(n,e);else{if(n.value===e)return;n.value=e===void 0?"":e}}function Fs(n,e){n._x_undoAddedClasses&&n._x_undoAddedClasses(),n._x_undoAddedClasses=It(n,e)}function As(n,e){n._x_undoAddedStyles&&n._x_undoAddedStyles(),n._x_undoAddedStyles=je(n,e)}function $s(n,e,t){Qn(n,e,t),Ls(n,e,t)}function Qn(n,e,t){[null,void 0,!1].includes(t)&&Ps(e)?n.removeAttribute(e):(Zn(e)&&(t=e),Ms(n,e,t))}function Ms(n,e,t){n.getAttribute(e)!=t&&n.setAttribute(e,t)}function Ls(n,e,t){n[e]!==t&&(n[e]=t)}function ks(n,e){const t=[].concat(e).map(r=>r+"");Array.from(n.options).forEach(r=>{r.selected=t.includes(r.value)})}function Is(n){return n.toLowerCase().replace(/-(\w)/g,(e,t)=>t.toUpperCase())}function Ht(n,e){return n==e}function Pe(n){return[1,"1","true","on","yes",!0].includes(n)?!0:[0,"0","false","off","no",!1].includes(n)?!1:n?!!n:null}var Ts=new Set(["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected","shadowrootclonable","shadowrootdelegatesfocus","shadowrootserializable"]);function Zn(n){return Ts.has(n)}function Ps(n){return!["aria-pressed","aria-checked","aria-expanded","aria-selected"].includes(n)}function Rs(n,e,t){return n._x_bindings&&n._x_bindings[e]!==void 0?n._x_bindings[e]:er(n,e,t)}function Ds(n,e,t,r=!0){if(n._x_bindings&&n._x_bindings[e]!==void 0)return n._x_bindings[e];if(n._x_inlineBindings&&n._x_inlineBindings[e]!==void 0){let s=n._x_inlineBindings[e];return s.extract=r,Mn(()=>te(n,s.expression))}return er(n,e,t)}function er(n,e,t){let r=n.getAttribute(e);return r===null?typeof t=="function"?t():t:r===""?!0:Zn(e)?!![e,"true"].includes(r):r}function Tt(n){return n.type==="checkbox"||n.localName==="ui-checkbox"||n.localName==="ui-switch"}function tr(n){return n.type==="radio"||n.localName==="ui-radio"}function nr(n,e){var t;return function(){var r=this,s=arguments,i=function(){t=null,n.apply(r,s)};clearTimeout(t),t=setTimeout(i,e)}}function rr(n,e){let t;return function(){let r=this,s=arguments;t||(n.apply(r,s),t=!0,setTimeout(()=>t=!1,e))}}function sr({get:n,set:e},{get:t,set:r}){let s=!0,i,a=ae(()=>{let o=n(),l=t();if(s)r(Ge(o)),s=!1;else{let c=JSON.stringify(o),u=JSON.stringify(l);c!==i?r(Ge(o)):c!==u&&e(Ge(l))}i=JSON.stringify(n()),JSON.stringify(t())});return()=>{pe(a)}}function Ge(n){return typeof n=="object"?JSON.parse(JSON.stringify(n)):n}function Ns(n){(Array.isArray(n)?n:[n]).forEach(t=>t(Fe))}var Q={},Gt=!1;function Os(n,e){if(Gt||(Q=fe(Q),Gt=!0),e===void 0)return Q[n];Q[n]=e,Fn(Q[n]),typeof e=="object"&&e!==null&&e.hasOwnProperty("init")&&typeof e.init=="function"&&Q[n].init()}function Bs(){return Q}var ir={};function zs(n,e){let t=typeof e!="function"?()=>e:e;return n instanceof Element?ar(n,t()):(ir[n]=t,()=>{})}function js(n){return Object.entries(ir).forEach(([e,t])=>{Object.defineProperty(n,e,{get(){return(...r)=>t(...r)}})}),n}function ar(n,e,t){let r=[];for(;r.length;)r.pop()();let s=Object.entries(e).map(([a,o])=>({name:a,value:o})),i=In(s);return s=s.map(a=>i.find(o=>o.name===a.name)?{name:"x-bind:".concat(a.name),value:'"'.concat(a.value,'"')}:a),At(n,s,t).map(a=>{r.push(a.runCleanups),a()}),()=>{for(;r.length;)r.pop()()}}var or={};function Us(n,e){or[n]=e}function Xs(n,e){return Object.entries(or).forEach(([t,r])=>{Object.defineProperty(n,t,{get(){return(...s)=>r.bind(e)(...s)},enumerable:!1})}),n}var Ws={get reactive(){return fe},get release(){return pe},get effect(){return ae},get raw(){return mn},version:"3.14.9",flushAndStopDeferringMutations:qr,dontAutoEvaluateFunctions:Mn,disableEffectScheduling:Br,startObservingMutations:xt,stopObservingMutations:_n,setReactivityEngine:zr,onAttributeRemoved:Cn,onAttributesAdded:Sn,closestDataStack:ue,skipDuringClone:Y,onlyDuringClone:Ss,addRootSelector:Wn,addInitSelector:Vn,interceptClone:Ue,addScopeToNode:_e,deferMutations:Vr,mapAttributes:$t,evaluateLater:T,interceptInit:us,setEvaluator:Qr,mergeProxies:Ee,extractProp:Ds,findClosest:he,onElRemoved:wt,closestRoot:ze,destroyTree:me,interceptor:An,transition:pt,setStyles:je,mutateDom:$,directive:L,entangle:sr,throttle:rr,debounce:nr,evaluate:te,initTree:V,nextTick:kt,prefixed:ge,prefix:ns,plugin:Ns,magic:z,store:Os,start:ls,clone:xs,cloneNode:Cs,bound:Rs,$data:En,watch:yn,walk:se,data:Us,bind:zs},Fe=Ws;function Vs(n,e){const t=Object.create(null),r=n.split(",");for(let s=0;s<r.length;s++)t[r[s]]=!0;return s=>!!t[s]}var qs=Object.freeze({}),Hs=Object.prototype.hasOwnProperty,Xe=(n,e)=>Hs.call(n,e),ne=Array.isArray,Ce=n=>lr(n)==="[object Map]",Gs=n=>typeof n=="string",Pt=n=>typeof n=="symbol",We=n=>n!==null&&typeof n=="object",Ks=Object.prototype.toString,lr=n=>Ks.call(n),cr=n=>lr(n).slice(8,-1),Rt=n=>Gs(n)&&n!=="NaN"&&n[0]!=="-"&&""+parseInt(n,10)===n,Ys=n=>{const e=Object.create(null);return t=>e[t]||(e[t]=n(t))},Js=Ys(n=>n.charAt(0).toUpperCase()+n.slice(1)),ur=(n,e)=>n!==e&&(n===n||e===e),ht=new WeakMap,ve=[],U,re=Symbol("iterate"),mt=Symbol("Map key iterate");function Qs(n){return n&&n._isEffect===!0}function Zs(n,e=qs){Qs(n)&&(n=n.raw);const t=ni(n,e);return e.lazy||t(),t}function ei(n){n.active&&(dr(n),n.options.onStop&&n.options.onStop(),n.active=!1)}var ti=0;function ni(n,e){const t=function(){if(!t.active)return n();if(!ve.includes(t)){dr(t);try{return si(),ve.push(t),U=t,n()}finally{ve.pop(),fr(),U=ve[ve.length-1]}}};return t.id=ti++,t.allowRecurse=!!e.allowRecurse,t._isEffect=!0,t.active=!0,t.raw=n,t.deps=[],t.options=e,t}function dr(n){const{deps:e}=n;if(e.length){for(let t=0;t<e.length;t++)e[t].delete(n);e.length=0}}var de=!0,Dt=[];function ri(){Dt.push(de),de=!1}function si(){Dt.push(de),de=!0}function fr(){const n=Dt.pop();de=n===void 0?!0:n}function B(n,e,t){if(!de||U===void 0)return;let r=ht.get(n);r||ht.set(n,r=new Map);let s=r.get(t);s||r.set(t,s=new Set),s.has(U)||(s.add(U),U.deps.push(s),U.options.onTrack&&U.options.onTrack({effect:U,target:n,type:e,key:t}))}function K(n,e,t,r,s,i){const a=ht.get(n);if(!a)return;const o=new Set,l=u=>{u&&u.forEach(d=>{(d!==U||d.allowRecurse)&&o.add(d)})};if(e==="clear")a.forEach(l);else if(t==="length"&&ne(n))a.forEach((u,d)=>{(d==="length"||d>=r)&&l(u)});else switch(t!==void 0&&l(a.get(t)),e){case"add":ne(n)?Rt(t)&&l(a.get("length")):(l(a.get(re)),Ce(n)&&l(a.get(mt)));break;case"delete":ne(n)||(l(a.get(re)),Ce(n)&&l(a.get(mt)));break;case"set":Ce(n)&&l(a.get(re));break}const c=u=>{u.options.onTrigger&&u.options.onTrigger({effect:u,target:n,key:t,type:e,newValue:r,oldValue:s,oldTarget:i}),u.options.scheduler?u.options.scheduler(u):u()};o.forEach(c)}var ii=Vs("__proto__,__v_isRef,__isVue"),pr=new Set(Object.getOwnPropertyNames(Symbol).map(n=>Symbol[n]).filter(Pt)),ai=gr(),oi=gr(!0),Kt=li();function li(){const n={};return["includes","indexOf","lastIndexOf"].forEach(e=>{n[e]=function(...t){const r=F(this);for(let i=0,a=this.length;i<a;i++)B(r,"get",i+"");const s=r[e](...t);return s===-1||s===!1?r[e](...t.map(F)):s}}),["push","pop","shift","unshift","splice"].forEach(e=>{n[e]=function(...t){ri();const r=F(this)[e].apply(this,t);return fr(),r}}),n}function gr(n=!1,e=!1){return function(r,s,i){if(s==="__v_isReactive")return!n;if(s==="__v_isReadonly")return n;if(s==="__v_raw"&&i===(n?e?Ci:br:e?Si:yr).get(r))return r;const a=ne(r);if(!n&&a&&Xe(Kt,s))return Reflect.get(Kt,s,i);const o=Reflect.get(r,s,i);return(Pt(s)?pr.has(s):ii(s))||(n||B(r,"get",s),e)?o:yt(o)?!a||!Rt(s)?o.value:o:We(o)?n?vr(o):zt(o):o}}var ci=ui();function ui(n=!1){return function(t,r,s,i){let a=t[r];if(!n&&(s=F(s),a=F(a),!ne(t)&&yt(a)&&!yt(s)))return a.value=s,!0;const o=ne(t)&&Rt(r)?Number(r)<t.length:Xe(t,r),l=Reflect.set(t,r,s,i);return t===F(i)&&(o?ur(s,a)&&K(t,"set",r,s,a):K(t,"add",r,s)),l}}function di(n,e){const t=Xe(n,e),r=n[e],s=Reflect.deleteProperty(n,e);return s&&t&&K(n,"delete",e,void 0,r),s}function fi(n,e){const t=Reflect.has(n,e);return(!Pt(e)||!pr.has(e))&&B(n,"has",e),t}function pi(n){return B(n,"iterate",ne(n)?"length":re),Reflect.ownKeys(n)}var gi={get:ai,set:ci,deleteProperty:di,has:fi,ownKeys:pi},hi={get:oi,set(n,e){return console.warn('Set operation on key "'.concat(String(e),'" failed: target is readonly.'),n),!0},deleteProperty(n,e){return console.warn('Delete operation on key "'.concat(String(e),'" failed: target is readonly.'),n),!0}},Nt=n=>We(n)?zt(n):n,Ot=n=>We(n)?vr(n):n,Bt=n=>n,Ve=n=>Reflect.getPrototypeOf(n);function $e(n,e,t=!1,r=!1){n=n.__v_raw;const s=F(n),i=F(e);e!==i&&!t&&B(s,"get",e),!t&&B(s,"get",i);const{has:a}=Ve(s),o=r?Bt:t?Ot:Nt;if(a.call(s,e))return o(n.get(e));if(a.call(s,i))return o(n.get(i));n!==s&&n.get(e)}function Me(n,e=!1){const t=this.__v_raw,r=F(t),s=F(n);return n!==s&&!e&&B(r,"has",n),!e&&B(r,"has",s),n===s?t.has(n):t.has(n)||t.has(s)}function Le(n,e=!1){return n=n.__v_raw,!e&&B(F(n),"iterate",re),Reflect.get(n,"size",n)}function Yt(n){n=F(n);const e=F(this);return Ve(e).has.call(e,n)||(e.add(n),K(e,"add",n,n)),this}function Jt(n,e){e=F(e);const t=F(this),{has:r,get:s}=Ve(t);let i=r.call(t,n);i?mr(t,r,n):(n=F(n),i=r.call(t,n));const a=s.call(t,n);return t.set(n,e),i?ur(e,a)&&K(t,"set",n,e,a):K(t,"add",n,e),this}function Qt(n){const e=F(this),{has:t,get:r}=Ve(e);let s=t.call(e,n);s?mr(e,t,n):(n=F(n),s=t.call(e,n));const i=r?r.call(e,n):void 0,a=e.delete(n);return s&&K(e,"delete",n,void 0,i),a}function Zt(){const n=F(this),e=n.size!==0,t=Ce(n)?new Map(n):new Set(n),r=n.clear();return e&&K(n,"clear",void 0,void 0,t),r}function ke(n,e){return function(r,s){const i=this,a=i.__v_raw,o=F(a),l=e?Bt:n?Ot:Nt;return!n&&B(o,"iterate",re),a.forEach((c,u)=>r.call(s,l(c),l(u),i))}}function Ie(n,e,t){return function(...r){const s=this.__v_raw,i=F(s),a=Ce(i),o=n==="entries"||n===Symbol.iterator&&a,l=n==="keys"&&a,c=s[n](...r),u=t?Bt:e?Ot:Nt;return!e&&B(i,"iterate",l?mt:re),{next(){const{value:d,done:f}=c.next();return f?{value:d,done:f}:{value:o?[u(d[0]),u(d[1])]:u(d),done:f}},[Symbol.iterator](){return this}}}}function q(n){return function(...e){{const t=e[0]?'on key "'.concat(e[0],'" '):"";console.warn("".concat(Js(n)," operation ").concat(t,"failed: target is readonly."),F(this))}return n==="delete"?!1:this}}function mi(){const n={get(i){return $e(this,i)},get size(){return Le(this)},has:Me,add:Yt,set:Jt,delete:Qt,clear:Zt,forEach:ke(!1,!1)},e={get(i){return $e(this,i,!1,!0)},get size(){return Le(this)},has:Me,add:Yt,set:Jt,delete:Qt,clear:Zt,forEach:ke(!1,!0)},t={get(i){return $e(this,i,!0)},get size(){return Le(this,!0)},has(i){return Me.call(this,i,!0)},add:q("add"),set:q("set"),delete:q("delete"),clear:q("clear"),forEach:ke(!0,!1)},r={get(i){return $e(this,i,!0,!0)},get size(){return Le(this,!0)},has(i){return Me.call(this,i,!0)},add:q("add"),set:q("set"),delete:q("delete"),clear:q("clear"),forEach:ke(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach(i=>{n[i]=Ie(i,!1,!1),t[i]=Ie(i,!0,!1),e[i]=Ie(i,!1,!0),r[i]=Ie(i,!0,!0)}),[n,t,e,r]}var[yi,bi,wa,Sa]=mi();function hr(n,e){const t=n?bi:yi;return(r,s,i)=>s==="__v_isReactive"?!n:s==="__v_isReadonly"?n:s==="__v_raw"?r:Reflect.get(Xe(t,s)&&s in r?t:r,s,i)}var vi={get:hr(!1)},wi={get:hr(!0)};function mr(n,e,t){const r=F(t);if(r!==t&&e.call(n,r)){const s=cr(n);console.warn("Reactive ".concat(s," contains both the raw and reactive versions of the same object").concat(s==="Map"?" as keys":"",", which can lead to inconsistencies. Avoid differentiating between the raw and reactive versions of an object and only use the reactive version if possible."))}}var yr=new WeakMap,Si=new WeakMap,br=new WeakMap,Ci=new WeakMap;function xi(n){switch(n){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function _i(n){return n.__v_skip||!Object.isExtensible(n)?0:xi(cr(n))}function zt(n){return n&&n.__v_isReadonly?n:wr(n,!1,gi,vi,yr)}function vr(n){return wr(n,!0,hi,wi,br)}function wr(n,e,t,r,s){if(!We(n))return console.warn("value cannot be made reactive: ".concat(String(n))),n;if(n.__v_raw&&!(e&&n.__v_isReactive))return n;const i=s.get(n);if(i)return i;const a=_i(n);if(a===0)return n;const o=new Proxy(n,a===2?r:t);return s.set(n,o),o}function F(n){return n&&F(n.__v_raw)||n}function yt(n){return!!(n&&n.__v_isRef===!0)}z("nextTick",()=>kt);z("dispatch",n=>Se.bind(Se,n));z("watch",(n,{evaluateLater:e,cleanup:t})=>(r,s)=>{let i=e(r),o=yn(()=>{let l;return i(c=>l=c),l},s);t(o)});z("store",Bs);z("data",n=>En(n));z("root",n=>ze(n));z("refs",n=>(n._x_refs_proxy||(n._x_refs_proxy=Ee(Ei(n))),n._x_refs_proxy));function Ei(n){let e=[];return he(n,t=>{t._x_refs&&e.push(t._x_refs)}),e}var Ke={};function Sr(n){return Ke[n]||(Ke[n]=0),++Ke[n]}function Fi(n,e){return he(n,t=>{if(t._x_ids&&t._x_ids[e])return!0})}function Ai(n,e){n._x_ids||(n._x_ids={}),n._x_ids[e]||(n._x_ids[e]=Sr(e))}z("id",(n,{cleanup:e})=>(t,r=null)=>{let s="".concat(t).concat(r?"-".concat(r):"");return $i(n,s,e,()=>{let i=Fi(n,t),a=i?i._x_ids[t]:Sr(t);return r?"".concat(t,"-").concat(a,"-").concat(r):"".concat(t,"-").concat(a)})});Ue((n,e)=>{n._x_id&&(e._x_id=n._x_id)});function $i(n,e,t,r){if(n._x_id||(n._x_id={}),n._x_id[e])return n._x_id[e];let s=r();return n._x_id[e]=s,t(()=>{delete n._x_id[e]}),s}z("el",n=>n);Cr("Focus","focus","focus");Cr("Persist","persist","persist");function Cr(n,e,t){z(e,r=>D("You can't use [$".concat(e,'] without first installing the "').concat(n,'" plugin here: https://alpinejs.dev/plugins/').concat(t),r))}L("modelable",(n,{expression:e},{effect:t,evaluateLater:r,cleanup:s})=>{let i=r(e),a=()=>{let u;return i(d=>u=d),u},o=r("".concat(e," = __placeholder")),l=u=>o(()=>{},{scope:{__placeholder:u}}),c=a();l(c),queueMicrotask(()=>{if(!n._x_model)return;n._x_removeModelListeners.default();let u=n._x_model.get,d=n._x_model.set,f=sr({get(){return u()},set(g){d(g)}},{get(){return a()},set(g){l(g)}});s(f)})});L("teleport",(n,{modifiers:e,expression:t},{cleanup:r})=>{n.tagName.toLowerCase()!=="template"&&D("x-teleport can only be used on a <template> tag",n);let s=en(t),i=n.content.cloneNode(!0).firstElementChild;n._x_teleport=i,i._x_teleportBack=n,n.setAttribute("data-teleport-template",!0),i.setAttribute("data-teleport-target",!0),n._x_forwardEvents&&n._x_forwardEvents.forEach(o=>{i.addEventListener(o,l=>{l.stopPropagation(),n.dispatchEvent(new l.constructor(l.type,l))})}),_e(i,{},n);let a=(o,l,c)=>{c.includes("prepend")?l.parentNode.insertBefore(o,l):c.includes("append")?l.parentNode.insertBefore(o,l.nextSibling):l.appendChild(o)};$(()=>{a(i,s,e),Y(()=>{V(i)})()}),n._x_teleportPutBack=()=>{let o=en(t);$(()=>{a(n._x_teleport,o,e)})},r(()=>$(()=>{i.remove(),me(i)}))});var Mi=document.createElement("div");function en(n){let e=Y(()=>document.querySelector(n),()=>Mi)();return e||D('Cannot find x-teleport element for selector: "'.concat(n,'"')),e}var xr=()=>{};xr.inline=(n,{modifiers:e},{cleanup:t})=>{e.includes("self")?n._x_ignoreSelf=!0:n._x_ignore=!0,t(()=>{e.includes("self")?delete n._x_ignoreSelf:delete n._x_ignore})};L("ignore",xr);L("effect",Y((n,{expression:e},{effect:t})=>{t(T(n,e))}));function bt(n,e,t,r){let s=n,i=l=>r(l),a={},o=(l,c)=>u=>c(l,u);if(t.includes("dot")&&(e=Li(e)),t.includes("camel")&&(e=ki(e)),t.includes("passive")&&(a.passive=!0),t.includes("capture")&&(a.capture=!0),t.includes("window")&&(s=window),t.includes("document")&&(s=document),t.includes("debounce")){let l=t[t.indexOf("debounce")+1]||"invalid-wait",c=Oe(l.split("ms")[0])?Number(l.split("ms")[0]):250;i=nr(i,c)}if(t.includes("throttle")){let l=t[t.indexOf("throttle")+1]||"invalid-wait",c=Oe(l.split("ms")[0])?Number(l.split("ms")[0]):250;i=rr(i,c)}return t.includes("prevent")&&(i=o(i,(l,c)=>{c.preventDefault(),l(c)})),t.includes("stop")&&(i=o(i,(l,c)=>{c.stopPropagation(),l(c)})),t.includes("once")&&(i=o(i,(l,c)=>{l(c),s.removeEventListener(e,i,a)})),(t.includes("away")||t.includes("outside"))&&(s=document,i=o(i,(l,c)=>{n.contains(c.target)||c.target.isConnected!==!1&&(n.offsetWidth<1&&n.offsetHeight<1||n._x_isShown!==!1&&l(c))})),t.includes("self")&&(i=o(i,(l,c)=>{c.target===n&&l(c)})),(Ti(e)||_r(e))&&(i=o(i,(l,c)=>{Pi(c,t)||l(c)})),s.addEventListener(e,i,a),()=>{s.removeEventListener(e,i,a)}}function Li(n){return n.replace(/-/g,".")}function ki(n){return n.toLowerCase().replace(/-(\w)/g,(e,t)=>t.toUpperCase())}function Oe(n){return!Array.isArray(n)&&!isNaN(n)}function Ii(n){return[" ","_"].includes(n)?n:n.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/[_\s]/,"-").toLowerCase()}function Ti(n){return["keydown","keyup"].includes(n)}function _r(n){return["contextmenu","click","mouse"].some(e=>n.includes(e))}function Pi(n,e){let t=e.filter(i=>!["window","document","prevent","stop","once","capture","self","away","outside","passive"].includes(i));if(t.includes("debounce")){let i=t.indexOf("debounce");t.splice(i,Oe((t[i+1]||"invalid-wait").split("ms")[0])?2:1)}if(t.includes("throttle")){let i=t.indexOf("throttle");t.splice(i,Oe((t[i+1]||"invalid-wait").split("ms")[0])?2:1)}if(t.length===0||t.length===1&&tn(n.key).includes(t[0]))return!1;const s=["ctrl","shift","alt","meta","cmd","super"].filter(i=>t.includes(i));return t=t.filter(i=>!s.includes(i)),!(s.length>0&&s.filter(a=>((a==="cmd"||a==="super")&&(a="meta"),n["".concat(a,"Key")])).length===s.length&&(_r(n.type)||tn(n.key).includes(t[0])))}function tn(n){if(!n)return[];n=Ii(n);let e={ctrl:"control",slash:"/",space:" ",spacebar:" ",cmd:"meta",esc:"escape",up:"arrow-up",down:"arrow-down",left:"arrow-left",right:"arrow-right",period:".",comma:",",equal:"=",minus:"-",underscore:"_"};return e[n]=n,Object.keys(e).map(t=>{if(e[t]===n)return t}).filter(t=>t)}L("model",(n,{modifiers:e,expression:t},{effect:r,cleanup:s})=>{let i=n;e.includes("parent")&&(i=n.parentNode);let a=T(i,t),o;typeof t=="string"?o=T(i,"".concat(t," = __placeholder")):typeof t=="function"&&typeof t()=="string"?o=T(i,"".concat(t()," = __placeholder")):o=()=>{};let l=()=>{let f;return a(g=>f=g),nn(f)?f.get():f},c=f=>{let g;a(p=>g=p),nn(g)?g.set(f):o(()=>{},{scope:{__placeholder:f}})};typeof t=="string"&&n.type==="radio"&&$(()=>{n.hasAttribute("name")||n.setAttribute("name",t)});var u=n.tagName.toLowerCase()==="select"||["checkbox","radio"].includes(n.type)||e.includes("lazy")?"change":"input";let d=G?()=>{}:bt(n,u,e,f=>{c(Ye(n,e,f,l()))});if(e.includes("fill")&&([void 0,null,""].includes(l())||Tt(n)&&Array.isArray(l())||n.tagName.toLowerCase()==="select"&&n.multiple)&&c(Ye(n,e,{target:n},l())),n._x_removeModelListeners||(n._x_removeModelListeners={}),n._x_removeModelListeners.default=d,s(()=>n._x_removeModelListeners.default()),n.form){let f=bt(n.form,"reset",[],g=>{kt(()=>n._x_model&&n._x_model.set(Ye(n,e,{target:n},l())))});s(()=>f())}n._x_model={get(){return l()},set(f){c(f)}},n._x_forceModelUpdate=f=>{f===void 0&&typeof t=="string"&&t.match(/\./)&&(f=""),window.fromModel=!0,$(()=>Jn(n,"value",f)),delete window.fromModel},r(()=>{let f=l();e.includes("unintrusive")&&document.activeElement.isSameNode(n)||n._x_forceModelUpdate(f)})});function Ye(n,e,t,r){return $(()=>{if(t instanceof CustomEvent&&t.detail!==void 0)return t.detail!==null&&t.detail!==void 0?t.detail:t.target.value;if(Tt(n))if(Array.isArray(r)){let s=null;return e.includes("number")?s=Je(t.target.value):e.includes("boolean")?s=Pe(t.target.value):s=t.target.value,t.target.checked?r.includes(s)?r:r.concat([s]):r.filter(i=>!Ri(i,s))}else return t.target.checked;else{if(n.tagName.toLowerCase()==="select"&&n.multiple)return e.includes("number")?Array.from(t.target.selectedOptions).map(s=>{let i=s.value||s.text;return Je(i)}):e.includes("boolean")?Array.from(t.target.selectedOptions).map(s=>{let i=s.value||s.text;return Pe(i)}):Array.from(t.target.selectedOptions).map(s=>s.value||s.text);{let s;return tr(n)?t.target.checked?s=t.target.value:s=r:s=t.target.value,e.includes("number")?Je(s):e.includes("boolean")?Pe(s):e.includes("trim")?s.trim():s}}})}function Je(n){let e=n?parseFloat(n):null;return Di(e)?e:n}function Ri(n,e){return n==e}function Di(n){return!Array.isArray(n)&&!isNaN(n)}function nn(n){return n!==null&&typeof n=="object"&&typeof n.get=="function"&&typeof n.set=="function"}L("cloak",n=>queueMicrotask(()=>$(()=>n.removeAttribute(ge("cloak")))));Vn(()=>"[".concat(ge("init"),"]"));L("init",Y((n,{expression:e},{evaluate:t})=>typeof e=="string"?!!e.trim()&&t(e,{},!1):t(e,{},!1)));L("text",(n,{expression:e},{effect:t,evaluateLater:r})=>{let s=r(e);t(()=>{s(i=>{$(()=>{n.textContent=i})})})});L("html",(n,{expression:e},{effect:t,evaluateLater:r})=>{let s=r(e);t(()=>{s(i=>{$(()=>{n.innerHTML=i,n._x_ignoreSelf=!0,V(n),delete n._x_ignoreSelf})})})});$t(Rn(":",Dn(ge("bind:"))));var Er=(n,{value:e,modifiers:t,expression:r,original:s},{effect:i,cleanup:a})=>{if(!e){let l={};js(l),T(n,r)(u=>{ar(n,u,s)},{scope:l});return}if(e==="key")return Ni(n,r);if(n._x_inlineBindings&&n._x_inlineBindings[e]&&n._x_inlineBindings[e].extract)return;let o=T(n,r);i(()=>o(l=>{l===void 0&&typeof r=="string"&&r.match(/\./)&&(l=""),$(()=>Jn(n,e,l,t))})),a(()=>{n._x_undoAddedClasses&&n._x_undoAddedClasses(),n._x_undoAddedStyles&&n._x_undoAddedStyles()})};Er.inline=(n,{value:e,modifiers:t,expression:r})=>{e&&(n._x_inlineBindings||(n._x_inlineBindings={}),n._x_inlineBindings[e]={expression:r,extract:!1})};L("bind",Er);function Ni(n,e){n._x_keyExpression=e}Wn(()=>"[".concat(ge("data"),"]"));L("data",(n,{expression:e},{cleanup:t})=>{if(Oi(n))return;e=e===""?"{}":e;let r={};ot(r,n);let s={};Xs(s,r);let i=te(n,e,{scope:s});(i===void 0||i===!0)&&(i={}),ot(i,n);let a=fe(i);Fn(a);let o=_e(n,a);a.init&&te(n,a.init),t(()=>{a.destroy&&te(n,a.destroy),o()})});Ue((n,e)=>{n._x_dataStack&&(e._x_dataStack=n._x_dataStack,e.setAttribute("data-has-alpine-state",!0))});function Oi(n){return G?gt?!0:n.hasAttribute("data-has-alpine-state"):!1}L("show",(n,{modifiers:e,expression:t},{effect:r})=>{let s=T(n,t);n._x_doHide||(n._x_doHide=()=>{$(()=>{n.style.setProperty("display","none",e.includes("important")?"important":void 0)})}),n._x_doShow||(n._x_doShow=()=>{$(()=>{n.style.length===1&&n.style.display==="none"?n.removeAttribute("style"):n.style.removeProperty("display")})});let i=()=>{n._x_doHide(),n._x_isShown=!1},a=()=>{n._x_doShow(),n._x_isShown=!0},o=()=>setTimeout(a),l=ft(d=>d?a():i(),d=>{typeof n._x_toggleAndCascadeWithTransitions=="function"?n._x_toggleAndCascadeWithTransitions(n,d,a,i):d?o():i()}),c,u=!0;r(()=>s(d=>{!u&&d===c||(e.includes("immediate")&&(d?o():i()),l(d),c=d,u=!1)}))});L("for",(n,{expression:e},{effect:t,cleanup:r})=>{let s=zi(e),i=T(n,s.items),a=T(n,n._x_keyExpression||"index");n._x_prevKeys=[],n._x_lookup={},t(()=>Bi(n,s,i,a)),r(()=>{Object.values(n._x_lookup).forEach(o=>$(()=>{me(o),o.remove()})),delete n._x_prevKeys,delete n._x_lookup})});function Bi(n,e,t,r){let s=a=>typeof a=="object"&&!Array.isArray(a),i=n;t(a=>{ji(a)&&a>=0&&(a=Array.from(Array(a).keys(),m=>m+1)),a===void 0&&(a=[]);let o=n._x_lookup,l=n._x_prevKeys,c=[],u=[];if(s(a))a=Object.entries(a).map(([m,y])=>{let w=rn(e,y,m,a);r(_=>{u.includes(_)&&D("Duplicate key on x-for",n),u.push(_)},{scope:{index:m,...w}}),c.push(w)});else for(let m=0;m<a.length;m++){let y=rn(e,a[m],m,a);r(w=>{u.includes(w)&&D("Duplicate key on x-for",n),u.push(w)},{scope:{index:m,...y}}),c.push(y)}let d=[],f=[],g=[],p=[];for(let m=0;m<l.length;m++){let y=l[m];u.indexOf(y)===-1&&g.push(y)}l=l.filter(m=>!g.includes(m));let b="template";for(let m=0;m<u.length;m++){let y=u[m],w=l.indexOf(y);if(w===-1)l.splice(m,0,y),d.push([b,m]);else if(w!==m){let _=l.splice(m,1)[0],S=l.splice(w-1,1)[0];l.splice(m,0,S),l.splice(w,0,_),f.push([_,S])}else p.push(y);b=y}for(let m=0;m<g.length;m++){let y=g[m];y in o&&($(()=>{me(o[y]),o[y].remove()}),delete o[y])}for(let m=0;m<f.length;m++){let[y,w]=f[m],_=o[y],S=o[w],v=document.createElement("div");$(()=>{S||D('x-for ":key" is undefined or invalid',i,w,o),S.after(v),_.after(S),S._x_currentIfEl&&S.after(S._x_currentIfEl),v.before(_),_._x_currentIfEl&&_.after(_._x_currentIfEl),v.remove()}),S._x_refreshXForScope(c[u.indexOf(w)])}for(let m=0;m<d.length;m++){let[y,w]=d[m],_=y==="template"?i:o[y];_._x_currentIfEl&&(_=_._x_currentIfEl);let S=c[w],v=u[w],x=document.importNode(i.content,!0).firstElementChild,A=fe(S);_e(x,A,i),x._x_refreshXForScope=N=>{Object.entries(N).forEach(([J,Ae])=>{A[J]=Ae})},$(()=>{_.after(x),Y(()=>V(x))()}),typeof v=="object"&&D("x-for key cannot be an object, it must be a string or an integer",i),o[v]=x}for(let m=0;m<p.length;m++)o[p[m]]._x_refreshXForScope(c[u.indexOf(p[m])]);i._x_prevKeys=u})}function zi(n){let e=/,([^,\}\]]*)(?:,([^,\}\]]*))?$/,t=/^\s*\(|\)\s*$/g,r=/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/,s=n.match(r);if(!s)return;let i={};i.items=s[2].trim();let a=s[1].replace(t,"").trim(),o=a.match(e);return o?(i.item=a.replace(e,"").trim(),i.index=o[1].trim(),o[2]&&(i.collection=o[2].trim())):i.item=a,i}function rn(n,e,t,r){let s={};return/^\[.*\]$/.test(n.item)&&Array.isArray(e)?n.item.replace("[","").replace("]","").split(",").map(a=>a.trim()).forEach((a,o)=>{s[a]=e[o]}):/^\{.*\}$/.test(n.item)&&!Array.isArray(e)&&typeof e=="object"?n.item.replace("{","").replace("}","").split(",").map(a=>a.trim()).forEach(a=>{s[a]=e[a]}):s[n.item]=e,n.index&&(s[n.index]=t),n.collection&&(s[n.collection]=r),s}function ji(n){return!Array.isArray(n)&&!isNaN(n)}function Fr(){}Fr.inline=(n,{expression:e},{cleanup:t})=>{let r=ze(n);r._x_refs||(r._x_refs={}),r._x_refs[e]=n,t(()=>delete r._x_refs[e])};L("ref",Fr);L("if",(n,{expression:e},{effect:t,cleanup:r})=>{n.tagName.toLowerCase()!=="template"&&D("x-if can only be used on a <template> tag",n);let s=T(n,e),i=()=>{if(n._x_currentIfEl)return n._x_currentIfEl;let o=n.content.cloneNode(!0).firstElementChild;return _e(o,{},n),$(()=>{n.after(o),Y(()=>V(o))()}),n._x_currentIfEl=o,n._x_undoIf=()=>{$(()=>{me(o),o.remove()}),delete n._x_currentIfEl},o},a=()=>{n._x_undoIf&&(n._x_undoIf(),delete n._x_undoIf)};t(()=>s(o=>{o?i():a()})),r(()=>n._x_undoIf&&n._x_undoIf())});L("id",(n,{expression:e},{evaluate:t})=>{t(e).forEach(s=>Ai(n,s))});Ue((n,e)=>{n._x_ids&&(e._x_ids=n._x_ids)});$t(Rn("@",Dn(ge("on:"))));L("on",Y((n,{value:e,modifiers:t,expression:r},{cleanup:s})=>{let i=r?T(n,r):()=>{};n.tagName.toLowerCase()==="template"&&(n._x_forwardEvents||(n._x_forwardEvents=[]),n._x_forwardEvents.includes(e)||n._x_forwardEvents.push(e));let a=bt(n,e,t,o=>{i(()=>{},{scope:{$event:o},params:[o]})});s(()=>a())}));qe("Collapse","collapse","collapse");qe("Intersect","intersect","intersect");qe("Focus","trap","focus");qe("Mask","mask","mask");function qe(n,e,t){L(e,r=>D("You can't use [x-".concat(e,'] without first installing the "').concat(n,'" plugin here: https://alpinejs.dev/plugins/').concat(t),r))}Fe.setEvaluator(kn);Fe.setReactivityEngine({reactive:zt,effect:Zs,release:ei,raw:F});var Ui=Fe,C=Ui;class Xi{constructor(e){this.overrides=new Map,this.config=e,this.loadLocalOverrides()}isEnabled(e){if(this.overrides.has(e))return this.overrides.get(e);const t=this.config.flags[e];return t?t.enabled?t.rolloutPercentage!==void 0?this.checkRolloutPercentage(e,t.rolloutPercentage):t.conditions?this.evaluateConditions(t.conditions):t.enabled:!1:(console.warn("Feature flag '".concat(e,"' not found. Defaulting to false.")),!1)}enable(e){this.overrides.set(e,!0),this.saveLocalOverrides()}disable(e){this.overrides.set(e,!1),this.saveLocalOverrides()}clearOverride(e){this.overrides.delete(e),this.saveLocalOverrides()}clearAllOverrides(){this.overrides.clear(),this.saveLocalOverrides()}getFlag(e){return this.config.flags[e]||null}getAllFlags(){return{...this.config.flags}}getOverrides(){return Object.fromEntries(this.overrides)}checkRolloutPercentage(e,t){if(t<=0)return!1;if(t>=100)return!0;const r=this.config.userId||this.config.sessionId||"anonymous";return this.simpleHash("".concat(e,":").concat(r))%100<t}evaluateConditions(e){return e.environment?e.environment===this.config.environment:e.userId&&this.config.userId?(Array.isArray(e.userId)?e.userId:[e.userId]).includes(this.config.userId):!0}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);t=(t<<5)-t+s,t=t&t}return Math.abs(t)}loadLocalOverrides(){if(!(typeof window>"u"))try{const e=localStorage.getItem("featureFlags_overrides");if(e){const t=JSON.parse(e);this.overrides=new Map(Object.entries(t))}}catch(e){console.warn("Failed to load feature flag overrides from localStorage:",e)}}saveLocalOverrides(){if(!(typeof window>"u"))try{const e=Object.fromEntries(this.overrides);localStorage.setItem("featureFlags_overrides",JSON.stringify(e))}catch(e){console.warn("Failed to save feature flag overrides to localStorage:",e)}}}const Wi={environment:"development",flags:{character_fetcher:{key:"character_fetcher",enabled:!0,description:"Use new CharacterFetcher service for D&D Beyond API calls",rolloutPercentage:100},modern_converter:{key:"modern_converter",enabled:!0,description:"Enable the new Alpine.js-based character converter",rolloutPercentage:100},legacy_fallback:{key:"legacy_fallback",enabled:!0,description:"Show fallback option to legacy converter"},bulk_conversion:{key:"bulk_conversion",enabled:!0,description:"Enable bulk character conversion feature",rolloutPercentage:100},advanced_mapping:{key:"advanced_mapping",enabled:!0,description:"Enable advanced field mapping configuration"},character_preview:{key:"character_preview",enabled:!0,description:"Show character preview before conversion",rolloutPercentage:100},export_formats:{key:"export_formats",enabled:!0,description:"Enable multiple export format options (JSON, PDF, etc.)",rolloutPercentage:100},multi_format_export:{key:"multi_format_export",enabled:!0,description:"Enable multi-format export with compatibility analysis",rolloutPercentage:100},performance_metrics:{key:"performance_metrics",enabled:!0,description:"Collect and display performance metrics",conditions:{environment:"development"}},debug_character_data:{key:"debug_character_data",enabled:!0,description:"Log detailed character data to console for debugging",rolloutPercentage:100},object_search_service:{key:"object_search_service",enabled:!0,description:"Use new ObjectSearch service instead of legacy getObjects() function",rolloutPercentage:100},string_sanitizer_service:{key:"string_sanitizer_service",enabled:!0,description:"Use new StringSanitizer service instead of legacy fixQuote() function",rolloutPercentage:100},safe_access_service:{key:"safe_access_service",enabled:!0,description:"Use new SafeAccess service instead of legacy safeAccess() function",rolloutPercentage:100},ability_constants:{key:"ability_constants",enabled:!0,description:"Use new AbilityConstants instead of legacy justAbilities array",rolloutPercentage:100},ability_score_processor:{key:"ability_score_processor",enabled:!0,description:"Use new AbilityScoreProcessor service instead of legacy processAbilityScoreBonuses() function",rolloutPercentage:100},debug_ability_score_processor:{key:"debug_ability_score_processor",enabled:!1,description:"Enable detailed debugging output for ability score modifier sources",conditions:{environment:"development"}},spell_slot_calculator:{key:"spell_slot_calculator",enabled:!0,description:"Use new SpellSlotCalculator service instead of legacy getSpellSlots() function",rolloutPercentage:100},debug_spell_slot_calculator:{key:"debug_spell_slot_calculator",enabled:!1,description:"Enable detailed debugging output for spell slot calculations",conditions:{environment:"development"}},inventory_processor:{key:"inventory_processor",enabled:!0,description:"Use new InventoryProcessor service instead of legacy inventory functions",rolloutPercentage:100},encumbrance_calculator:{key:"encumbrance_calculator",enabled:!0,description:"Use new EncumbranceCalculator service instead of legacy calculateEncumbrance() function",rolloutPercentage:100},inventory_processor_debug:{key:"inventory_processor_debug",enabled:!0,description:"Enable detailed debugging output for inventory processing",conditions:{environment:"development"}},encumbrance_calculator_debug:{key:"encumbrance_calculator_debug",enabled:!1,description:"Enable detailed debugging output for encumbrance calculations",conditions:{environment:"development"}},feature_processor:{key:"feature_processor",enabled:!0,description:"Use new FeatureProcessor service instead of legacy feature processing",rolloutPercentage:100},feature_processor_debug:{key:"feature_processor_debug",enabled:!1,description:"Enable detailed debugging output for feature processing",conditions:{environment:"development"}},weaponlist_debug:{key:"weaponlist_debug",enabled:!0,description:"Enable detailed debugging output for weaponlist XML generation",conditions:{environment:"development"}},spelllist_debug:{key:"spelllist_debug",enabled:!0,description:"Enable detailed debugging output for spelllist XML generation",conditions:{environment:"development"}}}},h=new Xi(Wi),Be={colors:{primary:{50:"#FDF2F5",100:"#FAE5EB",200:"#F2CCD7",300:"#E9A8B8",400:"#DD7A94",500:"#8B1538",600:"#6B1028",700:"#5A0E23",800:"#4A0C1D",900:"#3D0A18"},gold:{50:"#FEFBF0",100:"#FDF7E1",200:"#FAEFC3",300:"#F6E7A5",400:"#F1DE87",500:"#D4AF37",600:"#B8941F",700:"#9C7A18",800:"#806010",900:"#644609"},secondary:{50:"#EFF6FF",100:"#DBEAFE",200:"#BFDBFE",300:"#93C5FD",400:"#60A5FA",500:"#1E40AF",600:"#1E3A8A",700:"#1D4ED8",800:"#1E3A8A",900:"#1E3A8A"},semantic:{success:"#059669",warning:"#D97706",error:"#DC2626",info:"#0EA5E9"},neutral:{50:"#FAFAFA",100:"#F5F5F5",200:"#E5E5E5",300:"#D4D4D4",400:"#A3A3A3",500:"#737373",600:"#525252",700:"#404040",800:"#262626",900:"#171717"},dark:{600:"#475569",700:"#334155",800:"#1E293B",900:"#0F172A"}},typography:{fontFamily:{primary:"'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",display:"'Cinzel', serif",mono:"'JetBrains Mono', Consolas, 'Courier New', monospace"},fontSize:{h1:"3.5rem",h2:"2.5rem",h3:"2rem",h4:"1.5rem",h5:"1.25rem",bodyLarge:"1.125rem",body:"1rem",bodySmall:"0.875rem",caption:"0.75rem",label:"0.875rem",code:"0.875rem",button:"1rem"},fontWeight:{light:300,regular:400,medium:500,semibold:600,bold:700},lineHeight:{h1:1.2,h2:1.3,h3:1.4,h4:1.5,h5:1.6,bodyLarge:1.7,body:1.6,bodySmall:1.5,caption:1.4,label:1.3,code:1.6,button:1.2},letterSpacing:{h1:"-0.025em",h2:"-0.02em",h3:"-0.015em",h4:"-0.01em",h5:"normal",label:"0.05em"}},spacing:{xs:"0.25rem",sm:"0.5rem",md:"1rem",lg:"1.5rem",xl:"2rem","2xl":"3rem","3xl":"4rem"},animation:{duration:{micro:"150ms",local:"250ms",page:"350ms",complex:"600ms"},easing:{easeOut:"cubic-bezier(0.0, 0, 0.2, 1)",easeInOut:"cubic-bezier(0.4, 0, 0.6, 1)",sharp:"cubic-bezier(0.4, 0, 0.6, 1)",spring:{gentle:"cubic-bezier(0.16, 1, 0.3, 1)",bouncy:"cubic-bezier(0.68, -0.55, 0.265, 1.55)",firm:"cubic-bezier(0.2, 0, 0.38, 0.9)"}}},shadows:{sm:"0 2px 8px rgba(0, 0, 0, 0.05)",md:"0 4px 12px rgba(139, 21, 56, 0.2)",lg:"0 8px 24px rgba(139, 21, 56, 0.1)",xl:"0 20px 60px rgba(0, 0, 0, 0.3)"},borderRadius:{sm:"0.5rem",md:"0.75rem",lg:"1rem",xl:"1.5rem"},breakpoints:{mobile:"320px",tablet:"768px",desktop:"1024px",wide:"1440px"}};class Ar{static generateCustomProperties(e=Be){const t=[];return this.addColorTokens(t,"primary",e.colors.primary),this.addColorTokens(t,"gold",e.colors.gold),this.addColorTokens(t,"secondary",e.colors.secondary),this.addColorTokens(t,"neutral",e.colors.neutral),this.addColorTokens(t,"dark",e.colors.dark),Object.entries(e.colors.semantic).forEach(([r,s])=>{t.push("--color-".concat(r,": ").concat(s,";"))}),Object.entries(e.typography.fontFamily).forEach(([r,s])=>{t.push("--font-family-".concat(r,": ").concat(s,";"))}),Object.entries(e.typography.fontSize).forEach(([r,s])=>{t.push("--font-size-".concat(r,": ").concat(s,";"))}),Object.entries(e.typography.fontWeight).forEach(([r,s])=>{t.push("--font-weight-".concat(r,": ").concat(s,";"))}),Object.entries(e.typography.lineHeight).forEach(([r,s])=>{t.push("--line-height-".concat(r,": ").concat(s,";"))}),Object.entries(e.typography.letterSpacing).forEach(([r,s])=>{t.push("--letter-spacing-".concat(r,": ").concat(s,";"))}),Object.entries(e.spacing).forEach(([r,s])=>{t.push("--space-".concat(r,": ").concat(s,";"))}),Object.entries(e.animation.duration).forEach(([r,s])=>{t.push("--duration-".concat(r,": ").concat(s,";"))}),Object.entries(e.animation.easing).forEach(([r,s])=>{typeof s=="string"?t.push("--easing-".concat(r,": ").concat(s,";")):Object.entries(s).forEach(([i,a])=>{t.push("--easing-".concat(r,"-").concat(i,": ").concat(a,";"))})}),Object.entries(e.shadows).forEach(([r,s])=>{t.push("--shadow-".concat(r,": ").concat(s,";"))}),Object.entries(e.borderRadius).forEach(([r,s])=>{t.push("--radius-".concat(r,": ").concat(s,";"))}),Object.entries(e.breakpoints).forEach(([r,s])=>{t.push("--breakpoint-".concat(r,": ").concat(s,";"))}),":root {\n  ".concat(t.join("\n  "),"\n}")}static addColorTokens(e,t,r){Object.entries(r).forEach(([s,i])=>{e.push("--color-".concat(t,"-").concat(s,": ").concat(i,";"))})}static generateTailwindTokens(e=Be){return{colors:{primary:e.colors.primary,gold:e.colors.gold,secondary:e.colors.secondary,neutral:e.colors.neutral,dark:e.colors.dark,success:e.colors.semantic.success,warning:e.colors.semantic.warning,error:e.colors.semantic.error,info:e.colors.semantic.info},fontFamily:e.typography.fontFamily,fontSize:e.typography.fontSize,fontWeight:e.typography.fontWeight,lineHeight:e.typography.lineHeight,letterSpacing:e.typography.letterSpacing,spacing:e.spacing,transitionDuration:e.animation.duration,transitionTimingFunction:{"ease-out":e.animation.easing.easeOut,"ease-in-out":e.animation.easing.easeInOut,sharp:e.animation.easing.sharp,"spring-gentle":e.animation.easing.spring.gentle,"spring-bouncy":e.animation.easing.spring.bouncy,"spring-firm":e.animation.easing.spring.firm},boxShadow:e.shadows,borderRadius:e.borderRadius,screens:e.breakpoints}}}class Qe{constructor(e,t){this.id=e,this.animation=t}play(){this.animation.play()}pause(){this.animation.pause()}cancel(){this.animation.cancel()}finish(){this.animation.finish()}get finished(){return this.animation.finished}get playState(){return this.animation.playState}}class sn{constructor(e){this.animations=e}async playAll(){const e=this.animations.map(t=>(t.play(),t.finished));await Promise.all(e)}pauseAll(){this.animations.forEach(e=>e.pause())}cancelAll(){this.animations.forEach(e=>e.cancel())}finishAll(){this.animations.forEach(e=>e.finish())}}class Vi{constructor(e,t={}){this.element=e,this.options={duration:600,easing:"var(--easing-easeOut, ease-out)",shimmer:!0,onProgress:()=>{},onComplete:()=>{},...t},this.initializeProgressBar(),this.options.shimmer&&this.createShimmerEffect()}initializeProgressBar(){this.progressBar=this.element.querySelector(".progress-bar"),this.progressBar||(this.progressBar=document.createElement("div"),this.progressBar.className="progress-bar",this.element.appendChild(this.progressBar)),this.progressBar.style.width="0%",this.progressBar.style.height="100%",this.progressBar.style.background="var(--color-primary-500, #8B1538)",this.progressBar.style.borderRadius="inherit",this.progressBar.style.transformOrigin="left center",this.progressBar.style.willChange="width, transform"}createShimmerEffect(){this.shimmerElement=document.createElement("div"),this.shimmerElement.className="progress-shimmer",this.shimmerElement.style.position="absolute",this.shimmerElement.style.top="0",this.shimmerElement.style.left="-100%",this.shimmerElement.style.width="100%",this.shimmerElement.style.height="100%",this.shimmerElement.style.background="linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)",this.shimmerElement.style.willChange="transform",this.progressBar.style.position="relative",this.progressBar.style.overflow="hidden",this.progressBar.appendChild(this.shimmerElement)}animateToProgress(e){return new Promise(t=>{this.currentAnimation&&this.currentAnimation.cancel();const r=parseFloat(this.progressBar.style.width)||0,s=e-r;this.currentAnimation=this.progressBar.animate([{width:"".concat(r,"%")},{width:"".concat(e,"%")}],{duration:this.options.duration,easing:this.options.easing,fill:"forwards"}),this.shimmerElement&&this.shimmerElement.animate([{transform:"translateX(-100%)"},{transform:"translateX(400%)"}],{duration:this.options.duration*1.5,easing:this.options.easing,iterations:1});let i=0;const a=setInterval(()=>{i+=16.67;const o=r+s*(i/this.options.duration);this.options.onProgress(Math.min(o,e)),i>=this.options.duration&&clearInterval(a)},16);this.currentAnimation.addEventListener("finish",()=>{clearInterval(a),this.options.onComplete(),t()})})}reset(){this.currentAnimation&&this.currentAnimation.cancel(),this.progressBar.style.width="0%"}}class oe{constructor(){this.runningAnimations=new Map,this.frameCount=0,this.lastFrameTime=0,this.fpsHistory=[],this.performanceMetrics={activeAnimations:0,droppedFrames:0,averageFPS:60,memoryUsage:0},this.startPerformanceMonitoring()}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}startPerformanceMonitoring(){const e=t=>{if(this.lastFrameTime>0){const s=1e3/(t-this.lastFrameTime);this.fpsHistory.push(s),this.fpsHistory.length>60&&this.fpsHistory.shift(),this.performanceMetrics.averageFPS=this.fpsHistory.reduce((i,a)=>i+a,0)/this.fpsHistory.length,s<55&&this.performanceMetrics.droppedFrames++}this.lastFrameTime=t,this.frameCount++,requestAnimationFrame(e)};requestAnimationFrame(e)}createButtonHover(e){const t="button-hover-".concat(Date.now(),"-").concat(Math.random());e.style.willChange="transform, box-shadow";const r=e.animate([{transform:"translateY(0px)",boxShadow:"var(--shadow-md, 0 4px 12px rgba(139, 21, 56, 0.2))"},{transform:"translateY(-2px)",boxShadow:"var(--shadow-lg, 0 8px 24px rgba(139, 21, 56, 0.1))"}],{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-local").replace("ms",""))||250,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-easeOut")||"cubic-bezier(0.0, 0, 0.2, 1)",fill:"both"}),s=new Qe(t,r);return this.runningAnimations.set(t,s),r.addEventListener("finish",()=>{this.runningAnimations.delete(t),e.style.willChange="auto"}),r.addEventListener("cancel",()=>{this.runningAnimations.delete(t),e.style.willChange="auto"}),s}createButtonHoverReverse(e){const t="button-hover-reverse-".concat(Date.now(),"-").concat(Math.random());e.style.willChange="transform, box-shadow";const r=e.animate([{transform:"translateY(-2px)",boxShadow:"var(--shadow-lg, 0 8px 24px rgba(139, 21, 56, 0.1))"},{transform:"translateY(0px)",boxShadow:"var(--shadow-md, 0 4px 12px rgba(139, 21, 56, 0.2))"}],{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-local").replace("ms",""))||250,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-easeInOut")||"cubic-bezier(0.4, 0, 0.6, 1)",fill:"both"}),s=new Qe(t,r);return this.runningAnimations.set(t,s),r.addEventListener("finish",()=>{this.runningAnimations.delete(t),e.style.willChange="auto"}),s}createProgressAnimation(e,t={}){return new Vi(e,t)}createModalEntrance(e){const t=e.querySelector(".modal-backdrop"),r=e.querySelector(".modal-content");if(!t||!r)throw new Error("Modal must contain .modal-backdrop and .modal-content elements");t.style.willChange="opacity, backdrop-filter",r.style.willChange="transform, opacity";const s=t.animate([{opacity:"0",backdropFilter:"blur(0px)"},{opacity:"1",backdropFilter:"blur(4px)"}],{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-page").replace("ms",""))||350,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-easeOut")||"cubic-bezier(0.0, 0, 0.2, 1)",fill:"forwards"}),i=r.animate([{opacity:"0",transform:"scale(0.95) translateY(-20px)"},{opacity:"1",transform:"scale(1) translateY(0px)"}],{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-page").replace("ms",""))||350,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-spring-gentle")||"cubic-bezier(0.16, 1, 0.3, 1)",fill:"forwards"}),a=()=>{t.style.willChange="auto",r.style.willChange="auto"};return Promise.all([s.finished,i.finished]).then(a).catch(a),new sn([s,i])}createModalExit(e){const t=e.querySelector(".modal-backdrop"),r=e.querySelector(".modal-content");if(!t||!r)throw new Error("Modal must contain .modal-backdrop and .modal-content elements");t.style.willChange="opacity, backdrop-filter",r.style.willChange="transform, opacity";const s=r.animate([{opacity:"1",transform:"scale(1) translateY(0px)"},{opacity:"0",transform:"scale(0.95) translateY(-10px)"}],{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-local").replace("ms",""))||250,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-sharp")||"cubic-bezier(0.4, 0, 0.6, 1)",fill:"forwards"}),i=t.animate([{opacity:"1",backdropFilter:"blur(4px)"},{opacity:"0",backdropFilter:"blur(0px)"}],{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-local").replace("ms",""))||250,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-sharp")||"cubic-bezier(0.4, 0, 0.6, 1)",delay:50,fill:"forwards"}),a=()=>{t.style.willChange="auto",r.style.willChange="auto"};return Promise.all([i.finished,s.finished]).then(a).catch(a),new sn([s,i])}createCardHover(e,t=!0){const r="card-hover-".concat(Date.now(),"-").concat(Math.random());e.style.willChange="transform, box-shadow";const s=t?[{transform:"translateY(0px) scale(1)",boxShadow:"var(--shadow-sm, 0 2px 8px rgba(0, 0, 0, 0.05))"},{transform:"translateY(-4px) scale(1.02)",boxShadow:"var(--shadow-lg, 0 8px 24px rgba(139, 21, 56, 0.1))"}]:[{transform:"translateY(-4px) scale(1.02)",boxShadow:"var(--shadow-lg, 0 8px 24px rgba(139, 21, 56, 0.1))"},{transform:"translateY(0px) scale(1)",boxShadow:"var(--shadow-sm, 0 2px 8px rgba(0, 0, 0, 0.05))"}],i=e.animate(s,{duration:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--duration-local").replace("ms",""))||250,easing:getComputedStyle(document.documentElement).getPropertyValue("--easing-easeOut")||"cubic-bezier(0.0, 0, 0.2, 1)",fill:"both"}),a=new Qe(r,i);return this.runningAnimations.set(r,a),i.addEventListener("finish",()=>{this.runningAnimations.delete(r),e.style.willChange="auto"}),a}shouldAnimate(){try{return!window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch(e){return!0}}getPerformanceMetrics(){return this.performanceMetrics.activeAnimations=this.runningAnimations.size,this.performanceMetrics.memoryUsage=this.runningAnimations.size*1024,{...this.performanceMetrics}}cancelAllAnimations(){this.runningAnimations.forEach(e=>{e.cancel()}),this.runningAnimations.clear()}pauseAllAnimations(){this.runningAnimations.forEach(e=>{e.pause()})}resumeAllAnimations(){this.runningAnimations.forEach(e=>{e.play()})}}let Ze;function $r(){return Ze||(Ze=oe.getInstance()),Ze}typeof window<"u"&&(window.animationEngine=$r());class qi{constructor(e){this.options=e,this.announceQueue=[],this.isAnnouncing=!1,this.createLiveRegions()}createLiveRegions(){this.politeRegion=document.createElement("div"),this.politeRegion.setAttribute("aria-live","polite"),this.politeRegion.setAttribute("aria-atomic","true"),this.politeRegion.setAttribute("class","sr-only"),this.politeRegion.style.cssText="\n      position: absolute !important;\n      width: 1px !important;\n      height: 1px !important;\n      padding: 0 !important;\n      margin: -1px !important;\n      overflow: hidden !important;\n      clip: rect(0, 0, 0, 0) !important;\n      white-space: nowrap !important;\n      border: 0 !important;\n    ",this.assertiveRegion=document.createElement("div"),this.assertiveRegion.setAttribute("aria-live","assertive"),this.assertiveRegion.setAttribute("aria-atomic","true"),this.assertiveRegion.setAttribute("class","sr-only"),this.assertiveRegion.style.cssText=this.politeRegion.style.cssText,document.body.appendChild(this.politeRegion),document.body.appendChild(this.assertiveRegion)}announce(e,t="polite"){var s;const r=((s=this.options.announceDelays)==null?void 0:s[t])||(t==="polite"?100:0);this.announceQueue.push({text:e,priority:t,delay:r}),this.processQueue()}async processQueue(){if(!(this.isAnnouncing||this.announceQueue.length===0)){for(this.isAnnouncing=!0;this.announceQueue.length>0;){const{text:e,priority:t,delay:r}=this.announceQueue.shift();r>0&&await new Promise(i=>setTimeout(i,r));const s=t==="polite"?this.politeRegion:this.assertiveRegion;s.textContent="",await new Promise(i=>setTimeout(i,10)),s.textContent=e,await new Promise(i=>setTimeout(i,t==="polite"?500:200))}this.isAnnouncing=!1}}clear(){this.politeRegion.textContent="",this.assertiveRegion.textContent="",this.announceQueue=[],this.isAnnouncing=!1}}class Hi{constructor(){this.focusStack=[],this.focusTrappingEnabled=!1,this.focusableSelector="\n    a[href]:not([tabindex='-1']),\n    area[href]:not([tabindex='-1']),\n    input:not([disabled]):not([tabindex='-1']),\n    select:not([disabled]):not([tabindex='-1']),\n    textarea:not([disabled]):not([tabindex='-1']),\n    button:not([disabled]):not([tabindex='-1']),\n    iframe:not([tabindex='-1']),\n    [tabindex]:not([tabindex='-1']),\n    [contentEditable=true]:not([tabindex='-1']),\n    details > summary:not([tabindex='-1'])\n  ".trim().replace(/\s+/g," "),this.handleFocusTrap=e=>{var t,r;if(!(!this.focusTrappingEnabled||!this.currentTrapContainer)){if(e.key==="Escape"){const s=this.currentTrapContainer._escapeKeyAction;s&&s();return}e.key==="Tab"&&(e.shiftKey?document.activeElement===this.firstFocusableElement&&(e.preventDefault(),(t=this.lastFocusableElement)==null||t.focus()):document.activeElement===this.lastFocusableElement&&(e.preventDefault(),(r=this.firstFocusableElement)==null||r.focus()))}},this.handleFocusIn=e=>{var r;if(!this.focusTrappingEnabled||!this.currentTrapContainer)return;const t=e.target;this.currentTrapContainer.contains(t)||(e.preventDefault(),e.stopPropagation(),(r=this.firstFocusableElement)==null||r.focus())}}saveFocus(){const e=document.activeElement;e&&e!==document.body&&this.focusStack.push(e)}restoreFocus(){const e=this.focusStack.pop();if(e)try{e.focus()}catch(t){console.warn("Could not restore focus:",t)}}trapFocus(e,t={}){this.saveFocus(),this.focusTrappingEnabled=!0,this.currentTrapContainer=e;const r=this.getFocusableElements(e);if(r.length===0){console.warn("No focusable elements found in focus trap container");return}this.firstFocusableElement=r[0],this.lastFocusableElement=r[r.length-1];const s=t.initialFocus?typeof t.initialFocus=="string"?e.querySelector(t.initialFocus):t.initialFocus:this.firstFocusableElement;s&&setTimeout(()=>{s.focus({preventScroll:t.preventScroll})},0),document.addEventListener("keydown",this.handleFocusTrap),document.addEventListener("focusin",this.handleFocusIn),t.escapeKeyAction&&(e._escapeKeyAction=t.escapeKeyAction)}releaseFocusTrap(){this.focusTrappingEnabled=!1,this.currentTrapContainer=void 0,this.firstFocusableElement=void 0,this.lastFocusableElement=void 0,document.removeEventListener("keydown",this.handleFocusTrap),document.removeEventListener("focusin",this.handleFocusIn),this.restoreFocus()}getFocusableElements(e){return Array.from(e.querySelectorAll(this.focusableSelector)).filter(r=>{const s=window.getComputedStyle(r);return s.display!=="none"&&s.visibility!=="hidden"&&!r.hasAttribute("disabled")&&r.tabIndex!==-1})}setFocus(e,t={}){try{e.focus({preventScroll:t.preventScroll}),t.enhanceVisualFocus&&this.enhanceVisualFocus(e)}catch(r){console.warn("Could not set focus:",r)}}enhanceVisualFocus(e){const t=e.style.outline,r=e.style.outlineOffset;e.style.outline="3px solid var(--color-gold-500, #D4AF37)",e.style.outlineOffset="2px",setTimeout(()=>{e.style.outline=t,e.style.outlineOffset=r},2e3)}}class et{static checkColorContrast(e,t){const r=l=>{const c=l.replace("#",""),u=parseInt(c.substr(0,2),16)/255,d=parseInt(c.substr(2,2),16)/255,f=parseInt(c.substr(4,2),16)/255,g=p=>p<=.03928?p/12.92:Math.pow((p+.055)/1.055,2.4);return .2126*g(u)+.7152*g(d)+.0722*g(f)},s=r(e),i=r(t),a=Math.max(s,i),o=Math.min(s,i);return(a+.05)/(o+.05)}static hasAccessibleName(e){var t;return!!(e.getAttribute("aria-label")||e.getAttribute("aria-labelledby")||(t=e.textContent)!=null&&t.trim()||e.placeholder||e.getAttribute("title")||e.tagName==="IMG"&&e.alt||e.tagName==="INPUT"&&this.getLabelForInput(e))}static getLabelForInput(e){var r,s;if(e.id){const i=document.querySelector('label[for="'.concat(e.id,'"]'));if((r=i==null?void 0:i.textContent)!=null&&r.trim())return i.textContent.trim()}const t=e.closest("label");return(s=t==null?void 0:t.textContent)!=null&&s.trim()?t.textContent.trim():null}static isKeyboardAccessible(e){const t=e.tagName.toLowerCase();if(["a","button","input","select","textarea"].includes(t))return e.tabIndex!==-1&&!e.hasAttribute("disabled");const s=e.getAttribute("role");return s&&["button","link","menuitem","option","radio","checkbox","tab"].includes(s)?e.tabIndex>=0:!1}static auditDocument(){const e=Array.from(document.querySelectorAll("*")),t=e.filter(l=>this.isInteractiveElement(l));let r=0,s=0,i=0;t.forEach(l=>{this.hasAccessibleName(l)||r++,this.isKeyboardAccessible(l)||i++;const c=window.getComputedStyle(l),u=c.color,d=c.backgroundColor;if(u!=="rgba(0, 0, 0, 0)"&&d!=="rgba(0, 0, 0, 0)")try{this.checkColorContrast(this.rgbToHex(u),this.rgbToHex(d))<4.5&&s++}catch(f){}});const a=t.length-r-i,o=Math.round(a/Math.max(t.length,1)*100);return{totalElements:e.length,accessibleElements:a,missingLabels:r,insufficientContrast:s,keyboardInaccessible:i,complianceScore:o}}static isInteractiveElement(e){const t=["a","button","input","select","textarea"],r=["button","link","menuitem","option","radio","checkbox","tab"];return t.includes(e.tagName.toLowerCase())||e.getAttribute("role")&&r.includes(e.getAttribute("role"))||e.tabIndex>=0}static rgbToHex(e){if(e.startsWith("#"))return e;const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(!t)throw new Error("Invalid RGB color");const[,r,s,i]=t;return"#"+[r,s,i].map(a=>parseInt(a).toString(16).padStart(2,"0")).join("")}}class Gi{constructor(e={}){this.initialized=!1,this.handleGlobalKeydown=t=>{if(t.key==="Escape"){const r=document.querySelector('.modal.open, .modal[aria-hidden="false"]');if(r){const s=r.querySelector(".modal-close, [data-modal-close]");s&&s.click()}}if(t.altKey&&t.key==="1"){t.preventDefault();const r=document.querySelector('#main, main, [role="main"]');r&&this.focusManager.setFocus(r,{enhanceVisualFocus:!0})}},this.options={announceDelays:{polite:100,assertive:0},keyboardNavigation:!0,focusManagement:!0,screenReaderOptimization:!0,highContrastSupport:!0,...e},this.focusManager=new Hi,this.liveRegionManager=new qi(this.options),this.initialize()}initialize(){this.initialized||(this.addSkipLinks(),this.options.keyboardNavigation&&this.initializeKeyboardNavigation(),this.options.highContrastSupport&&this.initializeHighContrastSupport(),document.addEventListener("keydown",this.handleGlobalKeydown),this.initialized=!0)}addSkipLinks(){if(document.querySelector(".skip-link"))return;const e=document.createElement("a");e.href="#main",e.className="skip-link",e.textContent="Skip to main content",e.style.cssText="\n      position: absolute;\n      top: -40px;\n      left: 6px;\n      background: var(--color-primary-500, #8B1538);\n      color: white;\n      padding: 8px;\n      text-decoration: none;\n      border-radius: 4px;\n      z-index: 10000;\n      transition: top 0.2s ease;\n    ",e.addEventListener("focus",()=>{e.style.top="6px"}),e.addEventListener("blur",()=>{e.style.top="-40px"}),document.body.insertBefore(e,document.body.firstChild)}initializeKeyboardNavigation(){const e=document.createElement("style");e.textContent='\n      .enhanced-focus {\n        outline: 3px solid var(--color-gold-500, #D4AF37) !important;\n        outline-offset: 2px !important;\n      }\n      \n      /* Ensure focus is visible on all interactive elements */\n      button:focus-visible,\n      a:focus-visible,\n      input:focus-visible,\n      select:focus-visible,\n      textarea:focus-visible,\n      [role="button"]:focus-visible,\n      [tabindex]:focus-visible {\n        outline: 2px solid var(--color-gold-500, #D4AF37) !important;\n        outline-offset: 2px !important;\n      }\n    ',document.head.appendChild(e)}initializeHighContrastSupport(){const e=window.matchMedia("(prefers-contrast: high)"),t=r=>{document.documentElement.classList.toggle("high-contrast",r)};t(e.matches),e.addEventListener("change",r=>t(r.matches))}announce(e,t="polite"){this.liveRegionManager.announce(e,t)}trapFocus(e,t={}){this.focusManager.trapFocus(e,t)}releaseFocusTrap(){this.focusManager.releaseFocusTrap()}setFocus(e,t={}){this.focusManager.setFocus(e,t)}saveFocus(){this.focusManager.saveFocus()}restoreFocus(){this.focusManager.restoreFocus()}getAccessibilityMetrics(){return et.auditDocument()}validateElement(e){const t=[],r=et.hasAccessibleName(e),s=et.isKeyboardAccessible(e);return r||t.push("Missing accessible name (aria-label, aria-labelledby, or visible text)"),s||t.push("Not keyboard accessible (missing tabindex or disabled)"),{hasAccessibleName:r,isKeyboardAccessible:s,issues:t}}destroy(){this.liveRegionManager.clear(),this.focusManager.releaseFocusTrap(),document.removeEventListener("keydown",this.handleGlobalKeydown),this.initialized=!1}}let tt;function Mr(){return tt||(tt=new Gi),tt}typeof window<"u"&&(window.accessibilityManager=Mr());class Lr{constructor(){this.PROXY_URL="https://uakari-indigo.fly.dev/",this.DNDBEYOND_API_BASE="https://character-service.dndbeyond.com/character/v5/character/",this.REQUEST_TIMEOUT=3e4,this.MAX_RETRIES=3}validateCharacterID(e){if(!e||typeof e!="string")return{valid:!1,error:"Character ID is required"};const t=e.trim(),r=t.match(/dndbeyond\.com\/characters\/(\d+)/);return r?{valid:!0,sanitized:r[1]}:t.match(/^\d+$/)?{valid:!0,sanitized:t}:{valid:!1,error:"Invalid format. Use character ID or D&D Beyond character URL"}}async fetchCharacter(e){const t=this.validateCharacterID(e);if(!t.valid)return{success:!1,error:t.error};const r=t.sanitized;console.log("Fetching character data for ID:",r);const s="".concat(this.PROXY_URL).concat(this.DNDBEYOND_API_BASE).concat(r);console.log("Fetch URL:",s);let i=null;for(let o=1;o<=this.MAX_RETRIES;o++)try{console.log("Fetch attempt ".concat(o,"/").concat(this.MAX_RETRIES));const l=new AbortController,c=setTimeout(()=>l.abort(),this.REQUEST_TIMEOUT),u=await fetch(s,{method:"GET",headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Origin:"https://www.dndbeyond.com","X-Requested-With":"XMLHttpRequest"},signal:l.signal});if(clearTimeout(c),!u.ok)return{success:!1,error:this.getErrorMessage(u.status),statusCode:u.status};let d;try{d=await u.json()}catch(g){return{success:!1,error:"JSON parsing error: ".concat(g.message)}}let f;if(d.success&&d.data)f=d.data;else if(d.id&&d.name)f=d;else return{success:!1,error:"Invalid response format from D&D Beyond API"};return this.isValidCharacterData(f)?(console.log("Character data fetched successfully:",f.name),{success:!0,data:f}):{success:!1,error:"Invalid character data received from D&D Beyond"}}catch(l){if(i=l,console.warn("Fetch attempt ".concat(o," failed:"),l),this.isNonRetryableError(l))break;if(o<this.MAX_RETRIES){const c=Math.pow(2,o)*1e3;await new Promise(u=>setTimeout(u,c))}}return{success:!1,error:this.formatFinalError(i)}}getErrorMessage(e){switch(e){case 401:return"Character not found or not public. Ensure character visibility is set to Public.";case 403:return"Access denied. Character must be set to Public visibility.";case 404:return"Character not found. Please check the character ID.";case 429:return"Rate limit exceeded. Please wait before trying again.";case 500:case 502:case 503:return"D&D Beyond server error. Please try again later.";default:return"Unable to fetch character data (Error ".concat(e,"). Please try again.")}}isValidCharacterData(e){return e&&typeof e=="object"&&typeof e.id=="number"&&typeof e.name=="string"&&e.name.length>0}isNonRetryableError(e){return e.name==="AbortError"||e.message.includes("401")||e.message.includes("403")||e.message.includes("404")}formatFinalError(e){return e?e.name==="AbortError"?"Request timed out. Please check your connection and try again.":e.message.includes("Failed to fetch")||e.message.includes("NetworkError")?"Network error. Please check your internet connection and try again.":e.message.includes("CORS")?"CORS error. The proxy service may be temporarily unavailable.":"Network error: ".concat(e.message,". Please try again."):"Unknown error occurred while fetching character data"}async checkServiceHealth(){try{return(await fetch(this.PROXY_URL,{method:"HEAD",timeout:5e3})).ok}catch(e){return console.warn("Proxy service health check failed:",e),!1}}}const Ki=new Lr;class le{constructor(){this.alignmentConfig=null,this.abilityConfig=null,this.currencyConfig=null,this.gameRulesConfig=null}static getInstance(){return le.instance||(le.instance=new le),le.instance}async loadConfigs(){try{const[e,t,r,s]=await Promise.all([this.loadConfig("/src/config/dnd5e/alignments.json"),this.loadConfig("/src/config/dnd5e/abilities.json"),this.loadConfig("/src/config/dnd5e/currencies.json"),this.loadConfig("/src/config/dnd5e/game-rules.json")]);this.alignmentConfig=e,this.abilityConfig=t,this.currencyConfig=r,this.gameRulesConfig=s,console.log(" Game configuration loaded successfully")}catch(e){throw console.error(" Failed to load game configuration:",e),e}}async loadConfig(e){const t=await fetch(e);if(!t.ok)throw new Error("Failed to load config from ".concat(e,": ").concat(t.statusText));return await t.json()}getAlignmentName(e){if(!this.alignmentConfig)return console.warn("Alignment config not loaded, using fallback"),"True Neutral";const t=(e==null?void 0:e.toString())||"5";return this.alignmentConfig.mappings[t]||this.alignmentConfig.default}getAbilities(){return this.abilityConfig?this.abilityConfig.abilities:(console.warn("Ability config not loaded, using fallback"),[{id:1,name:"strength",displayName:"Strength",abbreviation:"STR"},{id:2,name:"dexterity",displayName:"Dexterity",abbreviation:"DEX"},{id:3,name:"constitution",displayName:"Constitution",abbreviation:"CON"},{id:4,name:"intelligence",displayName:"Intelligence",abbreviation:"INT"},{id:5,name:"wisdom",displayName:"Wisdom",abbreviation:"WIS"},{id:6,name:"charisma",displayName:"Charisma",abbreviation:"CHA"}])}calculateAbilityModifier(e){return Math.floor((e-10)/2)}getDefaultAbilityScore(){var e;return((e=this.abilityConfig)==null?void 0:e.calculations.defaultScore)||10}getCurrencies(){return this.currencyConfig?this.currencyConfig.currencies:[{name:"PP",displayName:"Platinum Pieces",value:10},{name:"GP",displayName:"Gold Pieces",value:1},{name:"EP",displayName:"Electrum Pieces",value:.5},{name:"SP",displayName:"Silver Pieces",value:.1},{name:"CP",displayName:"Copper Pieces",value:.01}]}calculateProficiencyBonus(e){return this.gameRulesConfig?e>=17?6:e>=13?5:e>=9?4:e>=5?3:2:Math.ceil(e/4)+1}getBaseArmorClass(){var e;return((e=this.gameRulesConfig)==null?void 0:e.armorClass.baseAC)||10}getDefaultSize(){var e;return((e=this.gameRulesConfig)==null?void 0:e.sizes.default)||"Medium"}getHitDiceTypes(){var e;return((e=this.gameRulesConfig)==null?void 0:e.hitDice.types)||["d6","d8","d10","d12"]}getDefaultHitDie(){var e;return((e=this.gameRulesConfig)==null?void 0:e.hitDice.default)||"d8"}isLoaded(){return!!(this.alignmentConfig&&this.abilityConfig&&this.currencyConfig&&this.gameRulesConfig)}}const I=le.getInstance();class j{static find(e,t="",r=""){if(!e||typeof e!="object")return[];const s=[],i=[e],a=new WeakSet;for(;i.length>0;){const o=i.pop();if(!(!o||typeof o!="object"||a.has(o))){a.add(o);for(const[l,c]of Object.entries(o))typeof c=="object"&&c!==null&&i.push(c),((t===""||l===t)&&(r===""||c===r)||t===l&&r===""||r===c&&t==="")&&(s.includes(o)||s.push(o))}}return s}static findAdvanced(e,t,r={}){if(!e||typeof e!="object")return[];const{maxDepth:s=50,includeArrays:i=!0,caseSensitive:a=!0,excludeKeys:o=[]}=r,l=[],c=[{obj:e,depth:0}],u=new WeakSet;for(;c.length>0;){const{obj:d,depth:f}=c.pop();if(!(!d||typeof d!="object"||u.has(d)||f>s)){u.add(d);for(const[g,p]of Object.entries(d))o.includes(g)||(typeof p=="object"&&p!==null&&(i||!Array.isArray(p))&&c.push({obj:p,depth:f+1}),this.matchesCriteria(g,p,t,a)&&(l.includes(d)||l.push(d)))}}return l}static findByEntityType(e,t){return this.find(e,"entityTypeId",t.toString())}static findByType(e,t){return this.find(e,"type",t)}static findByValue(e,t){return this.find(e,"",t)}static findByKey(e,t){return this.find(e,t,"")}static matchesCriteria(e,t,r,s){const{key:i,value:a,matchMode:o="exact"}=r;let l=!0;if(i!==void 0){const u=s?e:e.toLowerCase(),d=s?i:i.toLowerCase();switch(o){case"partial":l=u.includes(d);break;case"regex":l=new RegExp(d,s?"g":"gi").test(u);break;default:l=u===d}}let c=!0;if(a!==void 0)if(typeof t=="string"&&typeof a=="string"){const u=s?t:t.toLowerCase(),d=s?a:a.toLowerCase();switch(o){case"partial":c=u.includes(d);break;case"regex":c=new RegExp(d,s?"g":"gi").test(u);break;default:c=u===d}}else c=t===a;return l&&c}static getAllKeys(e,t=10){const r=new Set,s=[{obj:e,depth:0}],i=new WeakSet;for(;s.length>0;){const{obj:a,depth:o}=s.pop();if(!(!a||typeof a!="object"||i.has(a)||o>t)){i.add(a);for(const[l,c]of Object.entries(a))r.add(l),typeof c=="object"&&c!==null&&s.push({obj:c,depth:o+1})}}return Array.from(r).sort()}}class M{static sanitizeForXML(e,t={}){if(e==null||e==="")return"";const r=String(e),{maxLength:s=1e3,allowNewlines:i=!1,allowTabs:a=!1,preserveSpaces:o=!0,removeEventHandlers:l=!0,removeDangerousProtocols:c=!0}=t;let u=r;return c&&(u=u.replace(/javascript:/gi,"").replace(/vbscript:/gi,"").replace(/data:/gi,"")),l&&(u=u.replace(/on\w+\s*=/gi,"")),i||(u=u.replace(/\n/g," "),u=u.replace(/\r/g," ")),a||(u=u.replace(/\t/g," ")),i&&a?u=u.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""):i?u=u.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g,""):a?u=u.replace(/[\x00-\x08\x0A\x0B\x0C\x0D\x0E-\x1F\x7F]/g,""):u=u.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),u=u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/=/g,"&#x3D;").replace(/\//g,"&#x2F;"),u=u.substring(0,s),o?u.trim():u.replace(/\s+/g," ").trim()}static sanitizeWithReport(e,t={}){if(e==null||e==="")return{sanitized:"",wasModified:!1,originalLength:0,finalLength:0,removedPatterns:[]};const r=String(e),s=r.length,i=[];let a=r;/javascript:/gi.test(a)&&i.push("javascript: protocol"),/vbscript:/gi.test(a)&&i.push("vbscript: protocol"),/data:/gi.test(a)&&i.push("data: protocol"),/on\w+\s*=/gi.test(a)&&i.push("event handlers"),/[\x00-\x1F\x7F]/.test(a)&&i.push("control characters");const o=this.sanitizeForXML(e,t);return{sanitized:o,wasModified:o!==r,originalLength:s,finalLength:o.length,removedPatterns:i}}static sanitizeHTML(e,t={}){if(e==null||e==="")return"";const{maxLength:r=1e4,allowNewlines:s=!0,allowTabs:i=!1}=t;let o=String(e).substring(0,r).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x2F;/g,"/");return o=o.replace(/&rsquo;/g,"'").replace(/&lsquo;/g,"'").replace(/&rdquo;/g,'"').replace(/&ldquo;/g,'"').replace(/&ndash;/g,"-").replace(/&mdash;/g,"-").replace(/&#34;/g,'"').replace(/&nbsp;/g," "),o=o.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/\s*on\w+\s*=\s*[^>\s]*/gi,"").replace(/javascript:/gi,"").replace(/vbscript:/gi,""),s||(o=o.replace(/\n/g," ").replace(/\r/g," ")),i||(o=o.replace(/\t/g," ")),!s&&!i&&(o=o.replace(/\s+/g," ")),o.trim().substring(0,r)}static sanitizeText(e,t={}){if(e==null||e==="")return"";const{maxLength:r=1e3,allowNewlines:s=!1,allowTabs:i=!1}=t;let a=String(e);return s||(a=a.replace(/[\n\r]/g," ")),i||(a=a.replace(/\t/g," ")),s&&i?a=a.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""):s?a=a.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g,""):i?a=a.replace(/[\x00-\x08\x0A\x0B\x0C\x0D\x0E-\x1F\x7F]/g,""):a=a.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),a=a.substring(0,r),!s&&!i&&(a=a.replace(/\s+/g," ")),a.trim()}static escapeXMLAttribute(e){return e==null||e===""?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}static isXMLSafe(e){return!e||typeof e!="string"?!0:![/javascript:/gi,/vbscript:/gi,/on\w+\s*=/gi,/<script/gi,/<iframe/gi,/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/].some(r=>r.test(e))}static normalizeToASCII(e){return e==null||e===""?"":String(e).replace(/[\u2018\u2019]/g,"'").replace(/[\u201c\u201d]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/[]/g,"a").replace(/[]/g,"A").replace(/[]/g,"e").replace(/[]/g,"E").replace(/[]/g,"i").replace(/[]/g,"I").replace(/[]/g,"o").replace(/[]/g,"O").replace(/[]/g,"u").replace(/[]/g,"U").replace(/[]/g,"n").replace(/[]/g,"N").replace(/[]/g,"c").replace(/[]/g,"C")}}class O{static get(e,t,r=null,s={}){const{throwOnError:i=!1,logWarnings:a=!0,maxDepth:o=50,caseSensitive:l=!0}=s;try{if(!e||typeof e!="object"||!t||typeof t!="string")return r;const c=t.split(".");if(c.length>o){const f="Path depth exceeds maximum (".concat(o,"): ").concat(t);if(a&&console.warn(f),i)throw new Error(f);return r}let u=e,d="";for(let f=0;f<c.length;f++){const g=c[f];if(d+=(f>0?".":"")+g,u==null||typeof u!="object")return r;let p=g;if(!l&&!(g in u)){const b=Object.keys(u).find(m=>m.toLowerCase()===g.toLowerCase());b&&(p=b)}if(!(p in u))return r;u=u[p]}return u!=null?u:r}catch(c){const u="Safe access failed for path: ".concat(t);if(a&&console.warn(u,c),i)throw new Error("".concat(u,": ").concat(c instanceof Error?c.message:String(c)));return r}}static getWithResult(e,t,r={}){const{maxDepth:s=50,caseSensitive:i=!0}=r;if(!e||typeof e!="object")return{value:null,found:!1,path:t,depth:0,error:"Invalid object provided"};if(!t||typeof t!="string")return{value:null,found:!1,path:t,depth:0,error:"Invalid path provided"};try{const a=t.split(".");if(a.length>s)return{value:null,found:!1,path:t,depth:a.length,error:"Path depth exceeds maximum (".concat(s,")")};let o=e,l=0;for(const c of a){if(l++,o==null||typeof o!="object")return{value:null,found:!1,path:t,depth:l,error:"Cannot access property '".concat(c,"' on ").concat(typeof o)};let u=c;if(!i&&!(c in o)){const d=Object.keys(o).find(f=>f.toLowerCase()===c.toLowerCase());d&&(u=d)}if(!(u in o))return{value:null,found:!1,path:t,depth:l,error:"Property '".concat(c,"' not found")};o=o[u]}return{value:o,found:!0,path:t,depth:l,error:void 0}}catch(a){return{value:null,found:!1,path:t,depth:0,error:a instanceof Error?a.message:String(a)}}}static has(e,t,r={}){const s=this.getWithResult(e,t,r);return s.found&&s.value!==null&&s.value!==void 0}static getMultiple(e,t,r={}){const s={};for(const i of t)s[i]=this.get(e,i,null,r);return s}static set(e,t,r,s={}){const{maxDepth:i=50,caseSensitive:a=!0}=s;try{if(!e||typeof e!="object"||!t||typeof t!="string")return!1;const o=t.split(".");if(o.length>i)return!1;let l=e;for(let u=0;u<o.length-1;u++){const d=o[u];(!(d in l)||typeof l[d]!="object"||l[d]===null)&&(l[d]={}),l=l[d]}const c=o[o.length-1];return l[c]=r,!0}catch(o){return s.logWarnings&&console.warn("Safe set failed for path: ".concat(t),o),!1}}static delete(e,t,r={}){try{if(!e||typeof e!="object")return!1;const s=t.split("."),i=s.slice(0,-1).join("."),a=s[s.length-1];if(s.length===1)return a in e?(delete e[a],!0):!1;const o=this.get(e,i,null,r);return o&&typeof o=="object"&&a in o?(delete o[a],!0):!1}catch(s){return r.logWarnings&&console.warn("Safe delete failed for path: ".concat(t),s),!1}}static getAllPaths(e,t=10,r=""){const s=[];if(!e||typeof e!="object"||t<=0)return s;for(const[i,a]of Object.entries(e)){const o=r?"".concat(r,".").concat(i):i;if(s.push(o),typeof a=="object"&&a!==null&&t>1){const l=this.getAllPaths(a,t-1,o);s.push(...l)}}return s.sort()}}const R=["strength","dexterity","constitution","intelligence","wisdom","charisma"],an=[{id:1,name:"strength",abbreviation:"STR",description:"Measures physical power and carrying capacity"},{id:2,name:"dexterity",abbreviation:"DEX",description:"Measures agility, reflexes, and balance"},{id:3,name:"constitution",abbreviation:"CON",description:"Measures health, stamina, and vital force"},{id:4,name:"intelligence",abbreviation:"INT",description:"Measures reasoning ability, memory, and analytical thinking"},{id:5,name:"wisdom",abbreviation:"WIS",description:"Measures awareness, intuition, and insight"},{id:6,name:"charisma",abbreviation:"CHA",description:"Measures force of personality, leadership, and confidence"}],Yi=10,Ji=1,Qi=30,Zi=20;class P{static calculateModifier(e){return Math.floor((e-10)/2)}static getAbilityById(e){return an.find(t=>t.id===e)||null}static getAbilityByName(e){return an.find(t=>t.name.toLowerCase()===e.toLowerCase())||null}static getAbilityIdByName(e){const t=R.indexOf(e.toLowerCase());return t>=0?t+1:0}static getAbilityNameById(e){return R[e-1]||null}static getAbbreviation(e){const t=this.getAbilityByName(e);return t?t.abbreviation:null}static isValidScore(e,t=!0){const r=Ji,s=t?Qi:Zi;return e>=r&&e<=s}static calculateAllModifiers(e){return e.map((t,r)=>({score:t,modifier:this.calculateModifier(t)}))}static calculateSaveBonus(e,t,r){return this.calculateModifier(e)+(r?t:0)}static calculateCarryingCapacity(e,t=!1){const r=t?2:1,s=e*15*r;return{normal:e*5*r,encumbered:e*10*r,heavilyEncumbered:s,maximum:s,liftPushDrag:e*30*r}}static convertLegacyAbilities(e,t,r){const s={};return R.forEach((i,a)=>{var u,d,f;const o=((u=e==null?void 0:e[a])==null?void 0:u.value)||Yi,l=((d=t==null?void 0:t[a])==null?void 0:d.value)||0,c=(f=r==null?void 0:r[a])==null?void 0:f.value;s[i]=c!=null?c:o+l}),s}}const jt=class jt{static setDebugMode(e){this.debugEnabled=e}static debugAbilityModifierSources(e){if(!this.debugEnabled)return;if(console.group(" Detailed Ability Score Modifier Analysis"),console.log(" Base Ability Scores:"),e.stats&&Array.isArray(e.stats)?e.stats.forEach((r,s)=>{const i=R[s];console.log("  ".concat(i,": ").concat(r.value||10," (base)"))}):console.log("  No base stats found - using defaults (10)"),console.log("\n Existing Bonus Stats (from D&D Beyond):"),e.bonusStats&&Array.isArray(e.bonusStats)){let r=!1;e.bonusStats.forEach((s,i)=>{const a=R[i];s.value&&s.value>0&&(console.log("  ".concat(a,": +").concat(s.value," (pre-calculated by D&D Beyond)")),r=!0)}),r||console.log("  No existing bonus stats from D&D Beyond")}else console.log("  No existing bonus stats from D&D Beyond");if(console.log("\n Override Stats:"),e.overrideStats&&Array.isArray(e.overrideStats)){let r=!1;e.overrideStats.forEach((s,i)=>{const a=R[i];s.value!==null&&s.value!==void 0&&(console.log("  ".concat(a,": ").concat(s.value," (OVERRIDE - replaces base + bonuses)")),r=!0)}),r||console.log("  No overrides found")}else console.log("  No override stats found");const t=["race","class","background","item","feat"];t.forEach(r=>{if(console.log("\n ".concat(r.toUpperCase()," Modifiers:")),!e.modifiers||!e.modifiers[r]){console.log("  No ".concat(r," modifiers found"));return}const s=e.modifiers[r];let i=0,a=0;s.forEach((o,l)=>{if(o.type==="bonus"&&o.subType&&o.subType.endsWith("-score")){const c=o.subType.replace("-score",""),u=o.fixedValue||0;console.log("     ".concat(c,"-score: +").concat(u," ").concat(o.friendlyTypeName?"(".concat(o.friendlyTypeName,")"):"")),(o.componentId||o.componentTypeId)&&console.log("        Component: ".concat(o.componentId||"N/A"," (Type: ").concat(o.componentTypeId||"N/A",")")),(o.entityId||o.entityTypeId)&&console.log("        Entity: ".concat(o.entityId||"N/A"," (Type: ").concat(o.entityTypeId||"N/A",")")),i++}else console.log("      ".concat(o.subType||"unknown",": ").concat(o.fixedValue||0," (").concat(o.type||"unknown",")")),a++}),console.log("   Summary: ".concat(i," ability modifiers, ").concat(a," other modifiers"))}),console.log("\n Final Ability Score Breakdown:"),console.log("  [Comparing D&D Beyond pre-calculated vs manually calculated bonuses]"),R.forEach((r,s)=>{var p,b,m,y,w,_;const i=((b=(p=e.stats)==null?void 0:p[s])==null?void 0:b.value)||10,a=((y=(m=e.bonusStats)==null?void 0:m[s])==null?void 0:y.value)||0,o=(_=(w=e.overrideStats)==null?void 0:w[s])==null?void 0:_.value;let l=0;t.forEach(S=>{var v;(v=e.modifiers)!=null&&v[S]&&e.modifiers[S].forEach(x=>{if(x.type==="bonus"&&x.subType==="".concat(r,"-score")){const A=parseInt(String(x.fixedValue))||0;A>0&&(l+=A)}})});const c=o!=null?o:i+a,u=o!=null?o:i+l,d=P.calculateModifier(c),f=P.calculateModifier(u),g=a!==l?"   MISMATCH!":"";console.log("  ".concat(r.padEnd(12)," ").concat(i.toString().padStart(2)," (base) + ").concat(a.toString().padStart(2)," (D&DB) = ").concat(c.toString().padStart(2)," [").concat(d>=0?"+":"").concat(d,"]")),console.log("  ".concat(" ".padEnd(12)," ").concat(i.toString().padStart(2)," (base) + ").concat(l.toString().padStart(2)," (calc) = ").concat(u.toString().padStart(2)," [").concat(f>=0?"+":"").concat(f,"]").concat(g)),console.log("")}),console.groupEnd()}static processAbilityScoreBonuses(e){console.log("AbilityScoreProcessor: Processing ability score bonuses from all sources..."),this.debugAbilityModifierSources(e);const t=[];e.bonusStats&&[...e.bonusStats];let r=[];for(let o=1;o<=6;o++)r.push({id:o,name:null,value:0});["race","class","background","item","feat"].forEach(o=>{e.modifiers&&e.modifiers[o]&&e.modifiers[o].forEach(l=>{if(l.type==="bonus"&&l.subType&&l.subType.endsWith("-score")){const c=l.subType.replace("-score",""),u=P.getAbilityIdByName(c);if(u>0&&l.fixedValue!==null&&l.fixedValue!==void 0){const d=parseInt(String(l.fixedValue))||0;d>0&&r[u-1]&&(r[u-1].value+=d,t.push({source:o,ability:c,bonus:d}),console.log("Applied ".concat(o," bonus: +").concat(d," to ").concat(c," (ID: ").concat(u,")")))}}})});const i={};R.forEach((o,l)=>{var m,y,w;const c=l+1,u=this.getTotalAbilityScore(e,c,r),d=(m=e.stats)==null?void 0:m.find(_=>_.id===c),f=(d==null?void 0:d.value)||10,g=((y=r[l])==null?void 0:y.value)||0,p=(w=e.overrideStats)==null?void 0:w.find(_=>_.id===c),b=(p==null?void 0:p.value)||null;i[o]={base:f,bonus:g,override:b,total:u,modifier:P.calculateModifier(u)}});const a=R.map((o,l)=>{var c;return{ability:o,bonus:((c=r[l])==null?void 0:c.value)||0}}).filter(o=>o.bonus>0);return console.log("Final ability score bonuses:"),a.forEach(({ability:o,bonus:l})=>{console.log("  ".concat(o,": +").concat(l))}),{processedBonuses:r,totalScores:i,debugInfo:{appliedBonuses:t,finalBonusSummary:a}}}static getTotalAbilityScore(e,t,r){var l,c,u;let s=10;e.stats&&e.stats.length>=t&&(s=((l=e.stats[t-1])==null?void 0:l.value)||10);let i=0;const a=r||e.bonusStats;a&&a.length>=t&&(i=((c=a[t-1])==null?void 0:c.value)||0);let o=null;return e.overrideStats&&e.overrideStats.length>=t&&(o=(u=e.overrideStats[t-1])==null?void 0:u.value),o!==null?o:s+i}static processLegacyFormat(e){const t=this.processAbilityScoreBonuses(e);return R.map((r,s)=>{const i=s+1,a=t.totalScores[r],o=t.debugInfo.appliedBonuses.filter(d=>d.ability===r),l=o.filter(d=>d.source==="race").reduce((d,f)=>d+f.bonus,0),c=o.filter(d=>d.source==="feat").reduce((d,f)=>d+f.bonus,0),u=o.filter(d=>d.source==="item").reduce((d,f)=>d+f.bonus,0);return{id:i,name:r,base:(a==null?void 0:a.base)||10,racial:l,feat:c,item:u,total:(a==null?void 0:a.total)||10,modifier:(a==null?void 0:a.modifier)||0}})}static validateCharacterData(e){const t=[],r=[];return e?(!e.stats||!Array.isArray(e.stats)?r.push("Character stats array is missing or invalid - will use defaults"):e.stats.length<6&&r.push("Character stats array has ".concat(e.stats.length," entries, expected 6")),e.bonusStats&&!Array.isArray(e.bonusStats)&&r.push("Character bonusStats is not an array - will initialize"),e.overrideStats&&!Array.isArray(e.overrideStats)&&r.push("Character overrideStats is not an array"),e.modifiers&&typeof e.modifiers!="object"&&r.push("Character modifiers is not an object"),e.modifiers&&["race","class","background","item","feat"].forEach(i=>{e.modifiers[i]&&!Array.isArray(e.modifiers[i])&&r.push("Character modifiers.".concat(i," is not an array"))}),{isValid:t.length===0,issues:t,warnings:r}):(t.push("Character data is null or undefined"),{isValid:!1,issues:t,warnings:r})}};jt.debugEnabled=!1;let k=jt;const on={1:{1:2,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},2:{1:3,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},3:{1:4,2:2,3:0,4:0,5:0,6:0,7:0,8:0,9:0},4:{1:4,2:3,3:0,4:0,5:0,6:0,7:0,8:0,9:0},5:{1:4,2:3,3:2,4:0,5:0,6:0,7:0,8:0,9:0},6:{1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},7:{1:4,2:3,3:3,4:1,5:0,6:0,7:0,8:0,9:0},8:{1:4,2:3,3:3,4:2,5:0,6:0,7:0,8:0,9:0},9:{1:4,2:3,3:3,4:3,5:1,6:0,7:0,8:0,9:0},10:{1:4,2:3,3:3,4:3,5:2,6:0,7:0,8:0,9:0},11:{1:4,2:3,3:3,4:3,5:2,6:1,7:0,8:0,9:0},12:{1:4,2:3,3:3,4:3,5:2,6:1,7:0,8:0,9:0},13:{1:4,2:3,3:3,4:3,5:2,6:1,7:1,8:0,9:0},14:{1:4,2:3,3:3,4:3,5:2,6:1,7:1,8:0,9:0},15:{1:4,2:3,3:3,4:3,5:2,6:1,7:1,8:1,9:0},16:{1:4,2:3,3:3,4:3,5:2,6:1,7:1,8:1,9:0},17:{1:4,2:3,3:3,4:3,5:2,6:1,7:1,8:1,9:1},18:{1:4,2:3,3:3,4:3,5:3,6:1,7:1,8:1,9:1},19:{1:4,2:3,3:3,4:3,5:3,6:2,7:1,8:1,9:1},20:{1:4,2:3,3:3,4:3,5:3,6:2,7:2,8:1,9:1}},ea={1:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},2:{1:2,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},3:{1:3,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},4:{1:3,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},5:{1:4,2:2,3:0,4:0,5:0,6:0,7:0,8:0,9:0},6:{1:4,2:2,3:0,4:0,5:0,6:0,7:0,8:0,9:0},7:{1:4,2:3,3:0,4:0,5:0,6:0,7:0,8:0,9:0},8:{1:4,2:3,3:0,4:0,5:0,6:0,7:0,8:0,9:0},9:{1:4,2:3,3:2,4:0,5:0,6:0,7:0,8:0,9:0},10:{1:4,2:3,3:2,4:0,5:0,6:0,7:0,8:0,9:0},11:{1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},12:{1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},13:{1:4,2:3,3:3,4:1,5:0,6:0,7:0,8:0,9:0},14:{1:4,2:3,3:3,4:1,5:0,6:0,7:0,8:0,9:0},15:{1:4,2:3,3:3,4:2,5:0,6:0,7:0,8:0,9:0},16:{1:4,2:3,3:3,4:2,5:0,6:0,7:0,8:0,9:0},17:{1:4,2:3,3:3,4:3,5:1,6:0,7:0,8:0,9:0},18:{1:4,2:3,3:3,4:3,5:1,6:0,7:0,8:0,9:0},19:{1:4,2:3,3:3,4:3,5:2,6:0,7:0,8:0,9:0},20:{1:4,2:3,3:3,4:3,5:2,6:0,7:0,8:0,9:0}},ln={1:{1:2,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},2:{1:2,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},3:{1:2,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},4:{1:3,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},5:{1:3,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},6:{1:3,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},7:{1:4,2:2,3:0,4:0,5:0,6:0,7:0,8:0,9:0},8:{1:4,2:2,3:0,4:0,5:0,6:0,7:0,8:0,9:0},9:{1:4,2:2,3:0,4:0,5:0,6:0,7:0,8:0,9:0},10:{1:4,2:3,3:0,4:0,5:0,6:0,7:0,8:0,9:0},11:{1:4,2:3,3:0,4:0,5:0,6:0,7:0,8:0,9:0},12:{1:4,2:3,3:0,4:0,5:0,6:0,7:0,8:0,9:0},13:{1:4,2:3,3:2,4:0,5:0,6:0,7:0,8:0,9:0},14:{1:4,2:3,3:2,4:0,5:0,6:0,7:0,8:0,9:0},15:{1:4,2:3,3:2,4:0,5:0,6:0,7:0,8:0,9:0},16:{1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},17:{1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},18:{1:4,2:3,3:3,4:0,5:0,6:0,7:0,8:0,9:0},19:{1:4,2:3,3:3,4:1,5:0,6:0,7:0,8:0,9:0},20:{1:4,2:3,3:3,4:1,5:0,6:0,7:0,8:0,9:0}},ta={1:{warlockLevel:1,slotLevel:1,slotCount:1,shortRestRecharge:!0},2:{warlockLevel:2,slotLevel:1,slotCount:2,shortRestRecharge:!0},3:{warlockLevel:3,slotLevel:2,slotCount:2,shortRestRecharge:!0},4:{warlockLevel:4,slotLevel:2,slotCount:2,shortRestRecharge:!0},5:{warlockLevel:5,slotLevel:3,slotCount:2,shortRestRecharge:!0},6:{warlockLevel:6,slotLevel:3,slotCount:2,shortRestRecharge:!0},7:{warlockLevel:7,slotLevel:4,slotCount:2,shortRestRecharge:!0},8:{warlockLevel:8,slotLevel:4,slotCount:2,shortRestRecharge:!0},9:{warlockLevel:9,slotLevel:5,slotCount:2,shortRestRecharge:!0},10:{warlockLevel:10,slotLevel:5,slotCount:2,shortRestRecharge:!0},11:{warlockLevel:11,slotLevel:5,slotCount:3,shortRestRecharge:!0},12:{warlockLevel:12,slotLevel:5,slotCount:3,shortRestRecharge:!0},13:{warlockLevel:13,slotLevel:5,slotCount:3,shortRestRecharge:!0},14:{warlockLevel:14,slotLevel:5,slotCount:3,shortRestRecharge:!0},15:{warlockLevel:15,slotLevel:5,slotCount:3,shortRestRecharge:!0},16:{warlockLevel:16,slotLevel:5,slotCount:3,shortRestRecharge:!0},17:{warlockLevel:17,slotLevel:5,slotCount:4,shortRestRecharge:!0},18:{warlockLevel:18,slotLevel:5,slotCount:4,shortRestRecharge:!0},19:{warlockLevel:19,slotLevel:5,slotCount:4,shortRestRecharge:!0},20:{warlockLevel:20,slotLevel:5,slotCount:4,shortRestRecharge:!0}},na={bard:"full",cleric:"full",druid:"full",sorcerer:"full",wizard:"full",paladin:"half",ranger:"half",artificer:"third",fighter:"third",rogue:"third",warlock:"pact"},ra={fighter:["eldritch_knight"],rogue:["arcane_trickster"],ranger:[]},ce=class ce{static setDebugMode(e){this.debugEnabled=e}calculateSpellSlots(e,t=this.getDefaultOptions()){(ce.debugEnabled||h.isEnabled("spell_slot_calculator_debug"))&&console.log(" SpellSlotCalculator: Calculating spell slots",{classCount:e.length,classes:e.map(f=>"".concat(f.classDefinition.name).concat(f.level)),options:t});const r=this.analyzeSpellcastingClasses(e,t),s=r.filter(f=>f.casterType!=="none"),i=s.some(f=>f.isPactMagic),a=s.some(f=>!f.isPactMagic&&f.casterType!=="none");let o,l,c,u;if(i&&!a)o="pact_magic_only",l=this.getEmptySpellSlots(),c=this.calculatePactMagicSlots(r),u=0;else if(s.length===1)o="single_class",l=this.calculateSingleClassSpellSlots(s[0]),c=this.getEmptySpellSlots(),u=s[0].casterLevel;else if(s.length>1){o="multiclass";const f=this.calculateMulticlassSpellSlots(r,t);l=f.regularSpellSlots,c=f.pactMagicSlots,u=f.totalCasterLevel}else o="single_class",l=this.getEmptySpellSlots(),c=this.getEmptySpellSlots(),u=0;const d={spellSlots:l,pactMagicSlots:c,multiclassCasterLevel:u,totalCasterClasses:s.length,debugInfo:{classBreakdown:r,calculationMethod:o,casterLevelCalculation:this.buildCasterLevelCalculation(r)}};return(ce.debugEnabled||h.isEnabled("spell_slot_calculator_debug"))&&console.log(" SpellSlotCalculator: Result",{method:o,multiclassCasterLevel:u,totalCasterClasses:s.length,spellSlots:this.summarizeSpellSlots(l),pactMagic:this.summarizeSpellSlots(c)}),d}generateSpellSlotsXML(e){const t=this.generateRegularSpellSlotsXML(e.spellSlots),r=this.generatePactMagicSlotsXML(e.pactMagicSlots),s=this.combineSpellSlotXML(t,r);return{spellSlotsXML:t,pactMagicXML:r,combinedXML:s}}analyzeSpellcastingClasses(e,t){return e.map(r=>{var c;const s=r.classDefinition.name.toLowerCase(),i=na[s]||"none";let a=i;if((i==="third"||i==="none")&&(this.checkSpellcastingSubclass(r)||(a="none")),s==="ranger"&&t.handleSpelllessRanger){const u=(c=r.subclassDefinition)==null?void 0:c.name.toLowerCase().replace(/\s+/g,"_");(u==="spellless"||u==="beast_master_spellless")&&(a="none")}const o=this.calculateClassCasterLevel(r,a),l=s==="warlock";return{className:s,casterType:a,casterLevel:o,spellSlots:this.getSpellSlotsForProgression(a,r.level,s),isPactMagic:l,spellcastingAbility:this.getSpellcastingAbility(s),actualClassLevel:r.level}})}checkSpellcastingSubclass(e){var i;const t=e.classDefinition.name.toLowerCase(),r=(i=e.subclassDefinition)==null?void 0:i.name.toLowerCase().replace(/\s+/g,"_");if(!r)return!1;const s=ra[t];return s?s.length===0||s.includes(r):!1}calculateClassCasterLevel(e,t){switch(t){case"full":return e.level;case"half":return Math.floor(e.level/2);case"third":return Math.floor(e.level/3);case"pact":return 0;default:return 0}}getSpellSlotsForProgression(e,t,r){if(e==="none")return this.getEmptySpellSlots();switch(e){case"full":return on[t]||this.getEmptySpellSlots();case"half":return ea[t]||this.getEmptySpellSlots();case"third":return r==="artificer"?ln[t]||this.getEmptySpellSlots():t<3?this.getEmptySpellSlots():ln[t]||this.getEmptySpellSlots();case"pact":return this.convertPactMagicToSpellSlots(t);default:return this.getEmptySpellSlots()}}calculateSingleClassSpellSlots(e){return e.spellSlots}calculateMulticlassSpellSlots(e,t){const r=e.filter(l=>!l.isPactMagic&&l.casterType!=="none"),s=e.filter(l=>l.isPactMagic),i=r.reduce((l,c)=>l+c.casterLevel,0),a=on[i]||this.getEmptySpellSlots(),o=s.length>0?this.calculatePactMagicSlots(s):this.getEmptySpellSlots();return{regularSpellSlots:a,pactMagicSlots:o,totalCasterLevel:i}}calculatePactMagicSlots(e){const t=e.find(r=>r.className==="warlock");return!t||!t.actualClassLevel?this.getEmptySpellSlots():this.convertPactMagicToSpellSlots(t.actualClassLevel)}convertPactMagicToSpellSlots(e){const t=ta[e];if(!t)return this.getEmptySpellSlots();const r=this.getEmptySpellSlots();return r[t.slotLevel]=t.slotCount,r}generateRegularSpellSlotsXML(e){let t="";for(let r=1;r<=9;r++){const s=e[r];t+="			<spellslots".concat(r,">\n"),t+='				<max type="number">'.concat(s,"</max>\n"),t+="			</spellslots".concat(r,">\n")}return t}generatePactMagicSlotsXML(e){let t="";for(let r=1;r<=9;r++){const s=e[r];t+="			<pactmagicslots".concat(r,">\n"),t+='				<max type="number">'.concat(s,"</max>\n"),t+="			</pactmagicslots".concat(r,">\n")}return t}combineSpellSlotXML(e,t){let r="		<powermeta>\n";return r+=t,r+=e,r+="		</powermeta>",r}getSpellcastingAbility(e){return{wizard:"INT",artificer:"INT",fighter:"INT",rogue:"INT",cleric:"WIS",druid:"WIS",ranger:"WIS",bard:"CHA",sorcerer:"CHA",warlock:"CHA",paladin:"CHA"}[e]}buildCasterLevelCalculation(e){return e.map(t=>({className:t.className,level:t.casterLevel,casterType:t.casterType,contributesToCasterLevel:t.isPactMagic?0:t.casterLevel}))}getEmptySpellSlots(){return{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0}}summarizeSpellSlots(e){return Object.entries(e).filter(([r,s])=>s>0).map(([r,s])=>"".concat(r,":").concat(s)).join(", ")||"none"}getDefaultOptions(){return{includeDebugInfo:!0,strictMulticlassRules:!0,handleSpelllessRanger:!0,includePactMagicInMainSlots:!1}}static validateClassData(e){const t=[];return e.forEach((r,s)=>{var i,a;(i=r.classDefinition)!=null&&i.name||t.push("Class at index ".concat(s," missing name")),(typeof r.level!="number"||r.level<1||r.level>20)&&t.push("Class ".concat(((a=r.classDefinition)==null?void 0:a.name)||s," has invalid level: ").concat(r.level))}),{isValid:t.length===0,errors:t}}static getSpellSlotsForClass(e,t,r){const s=new ce,i={id:1,level:t,classDefinition:{id:1,name:e,canCastSpells:!0},subclassDefinition:r?{id:1,name:r}:void 0};return s.calculateSpellSlots([i]).spellSlots}static toLegacyFormat(e){return Object.entries(e).map(([t,r])=>({level:parseInt(t),slots:r}))}static validateClassInfo(e){var r;const t=[];return!e||typeof e!="object"?(t.push("Class info must be an object"),{isValid:!1,errors:t}):(Array.isArray(e)||((r=e.classDefinition)!=null&&r.name||t.push("Class definition name is required"),(typeof e.level!="number"||e.level<1||e.level>20)&&t.push("Class level must be between 1 and 20")),{isValid:t.length===0,errors:t})}};ce.debugEnabled=!1;let X=ce;class ie{constructor(e){if(this.pounds=e,e<0)throw new Error("Weight cannot be negative")}add(e){return new ie(this.pounds+e.pounds)}multiply(e){if(e<0)throw new Error("Weight multiplier cannot be negative");return new ie(this.pounds*e)}isZero(){return this.pounds===0}}class vt{constructor(e){if(this.amount=e,e<0)throw new Error("Quantity cannot be negative")}isZero(){return this.amount===0}multiply(e){return e.multiply(this.amount)}}class sa{padIndex(e){return String(e).padStart(5,"0")}generateItemXML(e,t,r=0){const s="	".repeat(3),i="	".repeat(4),a=this.padIndex(t);let o="".concat(s,"<id-").concat(a,">\n");return o+="".concat(i,'<count type="number">').concat(e.count,"</count>\n"),o+="".concat(i,'<name type="string">').concat(e.name,"</name>\n"),o+="".concat(i,'<weight type="number">').concat(e.weight,"</weight>\n"),o+="".concat(i,'<locked type="number">').concat(e.isLocked?1:0,"</locked>\n"),o+="".concat(i,'<isidentified type="number">').concat(e.isIdentified?1:0,"</isidentified>\n"),e.type&&(o+="".concat(i,'<type type="string">').concat(e.type,"</type>\n")),e.cost&&(o+="".concat(i,'<cost type="string">').concat(e.cost.value," ").concat(e.cost.denomination,"</cost>\n")),e.description&&(o+="".concat(i,'<description type="formattedtext">\n'),o+="".concat(i,"	<p>").concat(e.description,"</p>\n"),o+="".concat(i,"</description>\n")),e.properties&&e.properties.length>0&&(o+="".concat(i,'<properties type="string">').concat(e.properties.join(", "),"</properties>\n")),e.location&&(o+="".concat(i,'<location type="string">').concat(e.location,"</location>\n")),o+="".concat(s,"</id-").concat(a,">\n"),o}generateContainerXML(e,t,r,s=0){const i={id:e.id.toString(),name:e.definition.name,type:e.definition.subType||e.definition.filterType,weight:e.definition.weight,count:e.quantity,isIdentified:!0,isLocked:!1};return this.generateItemXML(i,r,s)}}class cn{constructor(e){this.xml="",this.itemCount=0,this.strategy=e}reset(){return this.xml="",this.itemCount=0,this}addInventoryHeader(){return this.xml+="	<inventorylist>\n",this}addInventoryFooter(){return this.xml+="	</inventorylist>",this}addItem(e){return this.itemCount++,this.xml+=this.strategy.generateItemXML(e,this.itemCount,0),this}build(){return{xml:this.xml,itemCount:this.itemCount}}}class ia{constructor(e=new sa){this.xmlStrategy=e,this.xmlBuilder=new cn(e)}processInventory(e,t,r=this.getDefaultOptions()){h.isEnabled("inventory_processor_debug")&&console.log(" InventoryProcessor: Processing inventory",{characterId:t,itemCount:e.length,options:r});const s=this.buildNestedStructure(e,t,r),i=this.generateInventoryXML(s,r),a=this.calculateStatistics(s),o={nestedStructure:s,xmlResult:i,statistics:a};return h.isEnabled("inventory_processor_debug")&&console.log(" InventoryProcessor: Processing complete",{totalItems:a.totalItems,containerCount:a.containerCount,xmlLength:i.xml.length}),o}buildNestedStructure(e,t,r){const s=new Map,i=new Map;e.forEach(c=>{const u=c.containerEntityId.toString();!r.includeZeroQuantityItems&&c.quantity<=0||(c.definition.isContainer&&i.set(c.id.toString(),{...c,definition:{...c.definition,isContainer:!0},contents:[],currentWeight:0}),s.has(u)||s.set(u,[]),s.get(u).push(c))});const a=t.toString(),o=s.get(a)||[];i.forEach((c,u)=>{const d=s.get(u)||[];c.contents=d,c.currentWeight=this.calculateContainerWeight(d)});const l=this.calculateTotalInventoryWeight(o,i);return{characterId:t,rootItems:o,containers:i,totalItems:e.length,totalWeight:l}}generateInventoryXML(e,t){this.xmlBuilder.reset().addInventoryHeader();let r=0,s=0,i=0;const a=[];e.rootItems.forEach(c=>{if(c.quantity<=0&&!t.includeZeroQuantityItems){s++;return}const u=this.convertItemToXMLFormat(c,t);this.xmlBuilder.addItem(u),r++,c.definition.isContainer&&(i++,c.definition.weightMultiplier===0&&a.push(c.definition.name))}),e.containers.forEach((c,u)=>{c.contents.forEach(d=>{if(d.quantity<=0&&!t.includeZeroQuantityItems){s++;return}const f=this.convertItemToXMLFormat(d,t);f.location=c.definition.name,this.xmlBuilder.addItem(f),r++})});const{xml:o,itemCount:l}=this.xmlBuilder.addInventoryFooter().build();return{xml:o,itemCount:l,totalWeight:e.totalWeight,containerCount:i,debugInfo:{processedItems:r,skippedItems:s,containerItems:i,magicContainers:a}}}convertItemToXMLFormat(e,t){const r=t.sanitizeOutput?M.sanitizeForXML(e.customName||e.definition.name):e.customName||e.definition.name,s=t.sanitizeOutput?M.sanitizeForXML(e.definition.subType||e.definition.filterType):e.definition.subType||e.definition.filterType,i={id:e.id.toString(),name:r,type:s,weight:(e.customWeight||e.definition.weight)/(e.definition.bundleSize||1),count:e.quantity,isIdentified:t.markItemsAsIdentified,isLocked:!0};return t.includeCostInformation&&e.definition.cost&&(i.cost={value:e.definition.cost.quantity,denomination:e.definition.cost.unit}),t.generateDetailedXML&&e.definition.description&&(i.description=t.sanitizeOutput?M.sanitizeHTML(e.definition.description):e.definition.description),i}convertItemsToXMLFormat(e,t){return e.filter(r=>t.includeZeroQuantityItems||r.quantity>0).map(r=>this.convertItemToXMLFormat(r,t))}calculateContainerWeight(e){return e.reduce((t,r)=>{const s=new ie(r.definition.weight||0),i=new vt(r.quantity);return t+i.multiply(s).pounds},0)}calculateTotalInventoryWeight(e,t){let r=0;return e.forEach(s=>{const i=new ie(s.definition.weight||0),a=new vt(s.quantity);r+=a.multiply(i).pounds}),r}calculateStatistics(e){return{totalItems:e.totalItems,containerCount:e.containers.size,magicContainers:Array.from(e.containers.values()).filter(t=>t.definition.weightMultiplier===0).length,totalWeight:e.totalWeight}}getDefaultOptions(){return{includeZeroQuantityItems:!1,respectContainerHierarchy:!0,generateDetailedXML:!1,sanitizeOutput:!0,includeCostInformation:!0,markItemsAsIdentified:!0}}static validateInventoryData(e){const t=[];return e.forEach((r,s)=>{(!r.id||r.id<=0)&&t.push("Item at index ".concat(s," has invalid ID: ").concat(r.id)),r.definition||t.push("Item at index ".concat(s," missing definition")),r.definition.name||t.push("Item at index ".concat(s," missing name")),typeof r.quantity!="number"&&t.push("Item ".concat(r.definition.name," has invalid quantity: ").concat(r.quantity))}),{isValid:t.length===0,errors:t}}setXMLStrategy(e){this.xmlStrategy=e,this.xmlBuilder=new cn(e)}}class un{constructor(){this.ENCUMBRANCE_MULTIPLIERS={ENCUMBERED_THRESHOLD:5,HEAVILY_THRESHOLD:10,MAXIMUM_CAPACITY:15,PUSH_DRAG_LIFT:30}}calculateEncumbrance(e,t,r={includeContainerWeights:!0,respectMagicContainers:!0,applyRacialTraits:!0}){h.isEnabled("encumbrance_calculator_debug")&&console.log(" EncumbranceCalculator: Calculating encumbrance",{characterId:e.id,inventoryItems:t.length,options:r});const s=this.calculateTotalWeight(t,e.id,r),i=this.calculateCarryingCapacity(e,r),a=this.determineEncumbranceLevel(s.totalWeight,i),{speedPenalty:o,disadvantageOnChecks:l}=this.calculatePenalties(a),c={totalWeight:s.totalWeight,carryingCapacity:{normal:i.maximum,push:i.maximum*2,lift:i.maximum*2,powerfulBuild:e.hasPowerfulBuild&&r.applyRacialTraits},encumbranceLevel:a,speedPenalty:o,disadvantageOnChecks:l};return h.isEnabled("encumbrance_calculator_debug")&&console.log(" EncumbranceCalculator: Result",{totalWeight:c.totalWeight,encumbranceLevel:c.encumbranceLevel,carryingCapacity:c.carryingCapacity,penalties:{speedPenalty:o,disadvantageOnChecks:l}}),c}calculateTotalWeight(e,t,r){let s=0;const i=[],a=this.buildContainerMultiplierMap(e);return e.forEach(o=>{if(o.quantity<=0)return;const l=new vt(o.quantity),c=new ie(o.definition.weight||0),u=o.containerEntityId.toString(),d=t.toString();let f=c.multiply(l.amount),g=!1,p;if(r.respectMagicContainers&&u!==d&&a.has(u)){const b=a.get(u);p=this.findContainerName(e,u),b===0?(f=new ie(0),g=!0):f=f.multiply(b)}s+=f.pounds,i.push({itemId:o.id,itemName:o.definition.name,weight:c.pounds,quantity:l.amount,totalWeight:f.pounds,containerName:p,magicContainer:g})}),{totalWeight:s,debugInfo:i}}buildContainerMultiplierMap(e){const t=new Map;return e.forEach(r=>{r.definition.isContainer&&r.definition.weightMultiplier!==void 0&&t.set(r.id.toString(),r.definition.weightMultiplier)}),t}findContainerName(e,t){const r=e.find(s=>s.id.toString()===t);return(r==null?void 0:r.definition.name)||"Unknown Container"}calculateCarryingCapacity(e,t){let r=e.strengthScore;return e.hasPowerfulBuild&&t.applyRacialTraits&&(r=Math.min(r*2,29)),{normal:r*this.ENCUMBRANCE_MULTIPLIERS.ENCUMBERED_THRESHOLD,encumbered:r*this.ENCUMBRANCE_MULTIPLIERS.ENCUMBERED_THRESHOLD,heavilyEncumbered:r*this.ENCUMBRANCE_MULTIPLIERS.HEAVILY_THRESHOLD,maximum:r*this.ENCUMBRANCE_MULTIPLIERS.MAXIMUM_CAPACITY}}determineEncumbranceLevel(e,t){return e>t.maximum?"overloaded":e>t.heavilyEncumbered?"heavily_encumbered":e>t.encumbered?"encumbered":"unencumbered"}calculatePenalties(e){switch(e){case"heavily_encumbered":return{speedPenalty:20,disadvantageOnChecks:!0};case"encumbered":return{speedPenalty:10,disadvantageOnChecks:!1};case"overloaded":return{speedPenalty:0,disadvantageOnChecks:!0};default:return{speedPenalty:0,disadvantageOnChecks:!1}}}getEncumbranceDebugInfo(e,t,r={includeContainerWeights:!0,respectMagicContainers:!0,applyRacialTraits:!0}){const s=this.calculateTotalWeight(t,e.id,r),i=this.calculateCarryingCapacity(e,r);return{itemBreakdown:s.debugInfo,strengthCalculation:{baseStrength:e.strengthScore,modifiers:0,finalStrength:e.strengthScore,powerfulBuild:e.hasPowerfulBuild&&r.applyRacialTraits},carryingCapacityCalculation:i}}static hasPowerfulBuild(e){var r,s;return(s=(r=e.race)==null?void 0:r.fullName)!=null&&s.toLowerCase().includes("goliath")?!0:j.find(e,"name","Powerful Build").length>0}static validateInventoryData(e){const t=[];return e.forEach((r,s)=>{(!r.id||r.id<=0)&&t.push("Item at index ".concat(s," has invalid ID: ").concat(r.id)),r.quantity<0&&t.push("Item ".concat(r.definition.name," has negative quantity: ").concat(r.quantity)),r.definition.weight<0&&t.push("Item ".concat(r.definition.name," has negative weight: ").concat(r.definition.weight))}),{isValid:t.length===0,errors:t}}}const aa={barbarian:{Rage:"resource","Unarmored Defense":"passive","Reckless Attack":"active","Danger Sense":"passive","Primal Path":"passive","Extra Attack":"passive","Fast Movement":"passive","Feral Instinct":"passive","Brutal Critical":"passive","Relentless Rage":"passive","Persistent Rage":"passive","Indomitable Might":"passive","Primal Champion":"passive"},fighter:{"Fighting Style":"passive","Second Wind":"resource","Action Surge":"resource","Martial Archetype":"passive","Extra Attack":"passive",Indomitable:"resource","Superior Critical":"passive",Survivor:"passive"},ranger:{"Favored Enemy":"passive","Natural Explorer":"passive","Fighting Style":"passive",Spellcasting:"spell","Ranger Archetype":"passive","Primeval Awareness":"active","Extra Attack":"passive","Lands Stride":"passive","Hide in Plain Sight":"active",Vanish:"active","Feral Senses":"passive","Foe Slayer":"passive"},rogue:{Expertise:"passive","Sneak Attack":"passive","Thieves Cant":"passive","Cunning Action":"active","Roguish Archetype":"passive","Uncanny Dodge":"passive",Evasion:"passive","Reliable Talent":"passive",Blindsense:"passive","Slippery Mind":"passive",Elusive:"passive","Stroke of Luck":"resource"}},oa={human:{"Extra Language":"proficiency","Extra Skill":"proficiency",Versatile:"passive"},elf:{Darkvision:"passive","Keen Senses":"proficiency","Fey Ancestry":"passive",Trance:"passive","Elf Weapon Training":"proficiency"},dwarf:{Darkvision:"passive","Dwarven Resilience":"passive","Dwarven Combat Training":"proficiency",Stonecunning:"proficiency"},halfling:{Lucky:"passive",Brave:"passive","Halfling Nimbleness":"passive"},dragonborn:{"Draconic Ancestry":"passive","Breath Weapon":"active","Damage Resistance":"passive"},gnome:{Darkvision:"passive","Gnome Cunning":"passive"},"half-elf":{Darkvision:"passive","Fey Ancestry":"passive","Skill Versatility":"proficiency"},"half-orc":{Darkvision:"passive","Relentless Endurance":"resource","Savage Attacks":"passive"},tiefling:{Darkvision:"passive","Hellish Resistance":"passive","Infernal Legacy":"spell"}};class dn{static validateClassFeature(e){const t=[];return(!e.name||e.name.trim().length===0)&&t.push("Feature name is required"),(!e.className||e.className.trim().length===0)&&t.push("Class name is required"),(typeof e.requiredLevel!="number"||e.requiredLevel<1||e.requiredLevel>20)&&t.push("Required level must be between 1 and 20"),e.type&&!["passive","active","resource","spell"].includes(e.type)&&t.push("Feature type must be passive, active, resource, or spell"),{isValid:t.length===0,errors:t}}static validateRacialTrait(e){const t=[];return(!e.name||e.name.trim().length===0)&&t.push("Trait name is required"),(!e.raceName||e.raceName.trim().length===0)&&t.push("Race name is required"),e.type&&!["passive","active","spell","proficiency"].includes(e.type)&&t.push("Trait type must be passive, active, spell, or proficiency"),{isValid:t.length===0,errors:t}}}const E=class E{constructor(){h.isEnabled("feature_processor_debug")&&(E.debugEnabled=!0)}static setDebugMode(e){this.debugEnabled=e}processCharacterFeatures(e,t=this.getDefaultOptions()){var l,c;(E.debugEnabled||h.isEnabled("feature_processor_debug"))&&console.log(" FeatureProcessor: Processing character features",{classCount:((l=e.classes)==null?void 0:l.length)||0,raceName:(c=e.race)==null?void 0:c.fullName,options:t});const r=t.includeSubclassFeatures?this.processClassFeatures(e,t):[],s=t.includeRacialTraits?this.processRacialTraits(e,t):[],i=this.groupFeaturesByClass(r),a=this.groupTraitsByRace(s),o={classFeatures:r,racialTraits:s,totalFeatures:r.length+s.length,featuresByClass:i,traitsByRace:a,debugInfo:{processingMethod:e.classes.length>1?"multiclass":"single_class",classBreakdown:this.buildClassBreakdown(e,r),raceBreakdown:this.buildRaceBreakdown(e,s),warnings:[]}};return(E.debugEnabled||h.isEnabled("feature_processor_debug"))&&console.log(" FeatureProcessor: Result",{totalFeatures:o.totalFeatures,classFeatureCount:r.length,racialTraitCount:s.length,processingMethod:o.debugInfo.processingMethod}),o}processClassFeatures(e,t){var i,a,o,l,c,u,d,f,g,p,b,m;const r=[],s=new Set;if(!e.classes||!Array.isArray(e.classes))return r;for(const y of e.classes){const w=((a=(i=y.definition)==null?void 0:i.name)==null?void 0:a.toLowerCase())||"unknown",_=y.level||1;if(E.debugEnabled&&console.log(" Processing class: ".concat(w," (level ").concat(_,")"),{hasClassFeatures:!!((o=y.definition)!=null&&o.classFeatures),classFeatureCount:((c=(l=y.definition)==null?void 0:l.classFeatures)==null?void 0:c.length)||0,hasSubclass:!!y.subclassDefinition,hasSubclassFeatures:!!((u=y.subclassDefinition)!=null&&u.classFeatures),subclassFeatureCount:((f=(d=y.subclassDefinition)==null?void 0:d.classFeatures)==null?void 0:f.length)||0,hasCustomFeatures:!!y.classFeatures,customFeatureCount:((g=y.classFeatures)==null?void 0:g.length)||0,hasGrantedFeatures:!!y.grantedClassFeatures,grantedFeatureCount:((p=y.grantedClassFeatures)==null?void 0:p.length)||0}),(b=y.definition)!=null&&b.classFeatures){E.debugEnabled&&console.log(" Processing ".concat(y.definition.classFeatures.length," class features for ").concat(w));const S=this.extractClassFeatures(y.definition.classFeatures,w,_,"class",t,void 0,s);r.push(...S)}if((m=y.subclassDefinition)!=null&&m.classFeatures){E.debugEnabled&&console.log(" Processing ".concat(y.subclassDefinition.classFeatures.length," subclass features for ").concat(w));const S=y.subclassDefinition.name,v=this.extractClassFeatures(y.subclassDefinition.classFeatures,w,_,"subclass",t,S,s);r.push(...v)}if(y.classFeatures&&Array.isArray(y.classFeatures)){E.debugEnabled&&console.log(" Processing additional classFeatures array (".concat(y.classFeatures.length," features)"));const S=this.extractClassFeatures(y.classFeatures,w,_,"class",t,void 0,s);r.push(...S)}if(y.grantedClassFeatures&&Array.isArray(y.grantedClassFeatures)){E.debugEnabled&&console.log(" Processing grantedClassFeatures array (".concat(y.grantedClassFeatures.length," features)"));const S=this.extractClassFeatures(y.grantedClassFeatures,w,_,"class",t,void 0,s);r.push(...S)}}return r}processRacialTraits(e,t){var l,c,u;const r=[],s=new Set;if(!e.race)return E.debugEnabled&&console.log("No race data found in character"),r;const i=e.race.fullName||e.race.baseName||"Unknown Race";E.debugEnabled&&(console.log(" Processing racial traits for: ".concat(i)),console.log(" Full race data structure:",JSON.stringify(e.race,null,2)),console.log(" Checking race.racialTraits:",!!e.race.racialTraits),console.log(" Checking race.traits:",!!e.race.traits),console.log(" Checking race.features:",!!e.race.features),console.log(" Checking race.raceTraits:",!!e.race.raceTraits),console.log(" Checking race.definition:",!!e.race.definition),e.race.definition&&(console.log(" Checking race.definition.racialTraits:",!!e.race.definition.racialTraits),console.log(" Checking race.definition.traits:",!!e.race.definition.traits)),console.log(" Race object keys:",Object.keys(e.race)));let a=null,o="";if(e.race.racialTraits&&Array.isArray(e.race.racialTraits)?(a=e.race.racialTraits,o="race.racialTraits"):e.race.traits&&Array.isArray(e.race.traits)?(a=e.race.traits,o="race.traits"):e.race.features&&Array.isArray(e.race.features)?(a=e.race.features,o="race.features"):(l=e.race.definition)!=null&&l.racialTraits&&Array.isArray(e.race.definition.racialTraits)?(a=e.race.definition.racialTraits,o="race.definition.racialTraits"):(c=e.race.definition)!=null&&c.traits&&Array.isArray(e.race.definition.traits)&&(a=e.race.definition.traits,o="race.definition.traits"),a&&a.length>0){E.debugEnabled&&(console.log(" Found ".concat(a.length," racial traits in ").concat(o)),console.log(" Sample trait structure:",JSON.stringify(a[0],null,2)));const d=this.extractRacialTraits(a,i,"race",t,void 0,s);r.push(...d)}else E.debugEnabled&&console.log(" No racial traits array found in any expected location");if((u=e.race.subraceDefinition)!=null&&u.racialTraits&&Array.isArray(e.race.subraceDefinition.racialTraits)){const d=e.race.subraceDefinition.name;E.debugEnabled&&console.log("Found ".concat(e.race.subraceDefinition.racialTraits.length," subrace traits for: ").concat(d));const f=this.extractRacialTraits(e.race.subraceDefinition.racialTraits,i,"subrace",t,d,s);r.push(...f)}return E.debugEnabled&&(console.log(" Final trait count: ".concat(r.length)),r.length>0&&console.log(" Extracted traits:",r.map(d=>d.name))),r}generateFeaturesXML(e,t=this.getDefaultXMLOptions()){return e.classFeatures.length>0?this.generateClassFeaturesXML(e.classFeatures,t):""}generateTraitsXML(e,t=this.getDefaultXMLOptions()){return e.racialTraits.length>0?this.generateRacialTraitsXML(e.racialTraits,t):""}extractClassFeatures(e,t,r,s,i,a,o){const l=[];for(const c of e){const u="id:".concat(c.id);if(E.debugEnabled&&console.log(" Processing feature: ".concat(c.name),{id:c.id,key:u,className:t,source:s,level:c.requiredLevel,hasSeenBefore:o==null?void 0:o.has(u)}),o&&o.has(u)){E.debugEnabled&&console.log(" Skipping duplicate feature: ".concat(c.name," (").concat(u,")"));continue}if(this.shouldSkipFeature(c.name)){E.debugEnabled&&console.log(" Skipping excluded feature: ".concat(c.name));continue}if(i.filterByLevel&&c.requiredLevel>r||c.requiredLevel>i.maxLevel)continue;o&&o.add(u);const d=this.determineFeatureType(c.name,t),f=this.determineFeatureUsage(c.name,t),g={id:c.id,name:c.name,description:i.includeDescriptions?c.description:"",requiredLevel:c.requiredLevel,className:t,subclassName:a,source:s,type:d,uses:f,mechanics:this.extractFeatureMechanics(c.name,c.description)},p=dn.validateClassFeature(g);p.isValid?l.push(g):console.warn("Invalid class feature: ".concat(g.name),p.errors)}return l}extractRacialTraits(e,t,r,s,i,a){const o=[];for(const l of e){E.debugEnabled&&console.log(" Raw trait data:",JSON.stringify(l,null,2));let c,u,d;if(l.definition)c=l.id,u=l.definition.name,d=l.definition.description;else if(l.name)c=l.id||0,u=l.name,d=l.description||"";else{E.debugEnabled&&console.log(" Skipping trait with unrecognized structure:",l);continue}const f=c?"id:".concat(c):"name:".concat(u);if(E.debugEnabled&&console.log(" Processing trait: ".concat(u),{id:c,key:f,raceName:t,source:r,hasSeenBefore:a==null?void 0:a.has(f)}),a&&a.has(f)){E.debugEnabled&&console.log(" Skipping duplicate trait: ".concat(u," (").concat(f,")"));continue}if(this.shouldSkipTrait(u)){E.debugEnabled&&console.log(" Skipping excluded trait: ".concat(u));continue}a&&a.add(f);const g=this.determineTraitType(u,t),p=this.extractTraitMechanics(u,d),b={id:c,name:u,description:s.includeDescriptions?d:"",raceName:t,suraceName:i,source:r,type:g,mechanics:p},m=dn.validateRacialTrait(b);m.isValid?(o.push(b),E.debugEnabled&&console.log(" Added trait: ".concat(u))):console.warn("Invalid racial trait: ".concat(b.name),m.errors)}return o}determineFeatureType(e,t){(!t||typeof t!="string")&&(t="unknown");const r=aa[t.toLowerCase()];return r&&r[e]?r[e]:!e||typeof e!="string"?"passive":e.toLowerCase().includes("spellcasting")?"spell":e.toLowerCase().includes("rage")||e.toLowerCase().includes("action surge")?"resource":e.toLowerCase().includes("attack")||e.toLowerCase().includes("maneuver")?"active":"passive"}determineTraitType(e,t){(!t||typeof t!="string")&&(t="unknown");const r=oa[t.toLowerCase()];return r&&r[e]?r[e]:!e||typeof e!="string"?"passive":e.toLowerCase().includes("proficiency")||e.toLowerCase().includes("training")?"proficiency":e.toLowerCase().includes("spell")||e.toLowerCase().includes("cantrip")?"spell":e.toLowerCase().includes("breath")||e.toLowerCase().includes("endurance")?"active":"passive"}determineFeatureUsage(e,t){if(!e||typeof e!="string")return;(!t||typeof t!="string")&&(t="unknown");const r=e.toLowerCase();if(r.includes("rage")&&t.toLowerCase()==="barbarian")return{type:"long_rest",amount:1,rechargeOn:"long_rest"};if(r.includes("action surge")&&t.toLowerCase()==="fighter")return{type:"short_rest",amount:1,rechargeOn:"short_rest"};if(r.includes("second wind")&&t.toLowerCase()==="fighter")return{type:"short_rest",amount:1,rechargeOn:"short_rest"}}extractFeatureMechanics(e,t){}extractTraitMechanics(e,t){const r={};if(e.toLowerCase().includes("darkvision")){const s=t.match(/(\d+)\s*feet/i);s&&(r.darkvisionRange=parseInt(s[1]))}return(e.toLowerCase().includes("fleet")||e.toLowerCase().includes("swift"))&&(r.speed=35),Object.keys(r).length>0?r:void 0}generateClassFeaturesXML(e,t){let r="";return e.forEach((s,i)=>{const a=String(i+1).padStart(5,"0"),o=t.sanitizeText?M.sanitizeForXML(s.name):s.name,l=t.sanitizeText&&s.description?M.sanitizeForXML(s.description):s.description||"";r+="      <id-".concat(a,'>\n        <locked type="number">1</locked>\n        <name type="string">').concat(o,'</name>\n        <text type="formattedtext">\n          <p>').concat(l,'</p>\n        </text>\n        <source type="string">').concat(s.className).concat(s.subclassName?" (".concat(s.subclassName,")"):"","</source>\n      </id-").concat(a,">\n")}),r}generateRacialTraitsXML(e,t){let r="";return e.forEach((s,i)=>{const a=String(i+1e3).padStart(5,"0"),o=t.sanitizeText?M.sanitizeForXML(s.name):s.name,l=t.sanitizeText&&s.description?M.sanitizeForXML(s.description):s.description||"";r+="      <id-".concat(a,'>\n        <locked type="number">1</locked>\n        <name type="string">').concat(o,'</name>\n        <text type="formattedtext">\n          <p>').concat(l,'</p>\n        </text>\n        <source type="string">').concat(s.raceName).concat(s.suraceName?" (".concat(s.suraceName,")"):"","</source>\n      </id-").concat(a,">\n")}),r}groupFeaturesByClass(e){return e.reduce((t,r)=>{const s=r.subclassName?"".concat(r.className," (").concat(r.subclassName.toLowerCase(),")"):r.className;return t[s]||(t[s]=[]),t[s].push(r),t},{})}groupTraitsByRace(e){return e.reduce((t,r)=>{const s=r.suraceName?"".concat(r.raceName.toLowerCase()," (").concat(r.suraceName.toLowerCase(),")"):r.raceName.toLowerCase();return t[s]||(t[s]=[]),t[s].push(r),t},{})}buildClassBreakdown(e,t){return e.classes.map(r=>{var s,i;return{className:((s=r.definition)==null?void 0:s.name)||"Unknown",level:r.level||1,featureCount:t.filter(a=>{var o,l;return a.className===((l=(o=r.definition)==null?void 0:o.name)==null?void 0:l.toLowerCase())}).length,subclass:(i=r.subclassDefinition)==null?void 0:i.name}})}buildRaceBreakdown(e,t){var r,s,i;return{raceName:((r=e.race)==null?void 0:r.fullName)||"Unknown Race",subraceName:(i=(s=e.race)==null?void 0:s.subraceDefinition)==null?void 0:i.name,traitCount:t.length}}getDefaultOptions(){return{includeSubclassFeatures:!0,includeRacialTraits:!0,includeDescriptions:!0,filterByLevel:!0,maxLevel:20}}getDefaultXMLOptions(){return{includeDescriptions:!0,includeUsageLimits:!0,groupBySource:!0,sanitizeText:!0}}shouldSkipFeature(e){if(!e||typeof e!="string")return!1;const t=["Proficiencies","Ability Score Increase","Core Sorcerer Traits","Metamagic Options"],r=e.toLowerCase();return t.some(s=>r.includes(s.toLowerCase()))}shouldSkipTrait(e){if(!e||typeof e!="string")return!1;const t=["Proficiencies","Ability Score Increase","Languages","Age","Size","Speed","Core Sorcerer Traits","Metamagic Options"],r=e.toLowerCase();return t.some(s=>r.includes(s.toLowerCase()))}static validateCharacterData(e){const t=[];return e?((!e.classes||!Array.isArray(e.classes))&&t.push("Character classes must be an array"),e.race||t.push("Character race is required"),{isValid:t.length===0,errors:t}):(t.push("Character data is required"),{isValid:!1,errors:t})}};E.debugEnabled=!1;let H=E;class la{constructor(){this.format="foundry-vtt-json",this.version="1.0",this.supportedFeatures=["abilities","skills","combat","spells","equipment","features","active-effects","embedded-items"]}async generateOutput(e,t){try{const r=e.characterData,s=[],i=[],a={_id:this.generateFoundryId(),name:M.sanitizeText(r.name||"Unknown Character"),type:"character",img:this.getCharacterImage(r),system:this.buildSystemData(e),items:await this.buildItems(e,t),effects:this.buildActiveEffects(e),prototypeToken:this.buildTokenData(e),ownership:{default:0},flags:{dnd5e:{},"b2fg-converter":{sourceId:r.id,convertedAt:new Date().toISOString(),converterVersion:"1.0"}}},o=M.sanitizeText(r.name||"character").replace(/[^a-zA-Z0-9_-]/g,"_"),l=r.id||"unknown",c="".concat(o,"_").concat(l,".json");return{success:!0,output:JSON.stringify(a,null,2),filename:c,mimeType:"application/json",errors:s.length>0?s:void 0,warnings:i.length>0?i:void 0}}catch(r){return{success:!1,errors:[{type:"generation_error",message:r instanceof Error?r.message:"Unknown error occurred"}]}}}buildSystemData(e){const t=e.characterData,r=e.totalLevel||this.calculateTotalLevel(t),s=e.proficiencyBonus||I.calculateProficiencyBonus(r);return{abilities:this.mapAbilities(t),attributes:this.mapAttributes(t,r,s),details:this.mapDetails(t,r),traits:this.mapTraits(t),currency:this.mapCurrency(t),skills:this.mapSkills(t,s),spells:this.mapSpellSlots(t),bonuses:this.mapBonuses(t),resources:this.mapResources(t)}}mapAbilities(e){const t={},r={1:"str",2:"dex",3:"con",4:"int",5:"wis",6:"cha"},s=O.get(e,"stats")||[];for(const i of s){const a=r[i.id];if(a){const o=i.value||10;t[a]={value:o,proficient:this.isAbilitySaveProficient(e,a),max:null,bonuses:{check:"",save:""},check:{roll:{min:null,max:null,mode:0}},save:{roll:{min:null,max:null,mode:0}}}}}for(const i of["str","dex","con","int","wis","cha"])t[i]||(t[i]={value:10,proficient:!1,max:null,bonuses:{check:"",save:""},check:{roll:{min:null,max:null,mode:0}},save:{roll:{min:null,max:null,mode:0}}});return t}mapAttributes(e,t,r){const i=(O.get(e,"stats")||[]).find(c=>c.id===3),a=(i==null?void 0:i.value)||10,o=Math.floor((a-10)/2),l=this.calculateHitPoints(e,o,t);return{init:{ability:"",roll:{min:null,max:null,mode:0},bonus:""},movement:this.mapMovement(e),attunement:{max:3},senses:this.mapSenses(e),spellcasting:this.getPrimarySpellcastingAbility(e),hp:{value:l,max:l,temp:0,tempmax:0,bonuses:{level:"",overall:""}},ac:{flat:null,calc:"default",formula:"",min:0},prof:r,spelldc:this.calculateSpellDC(e,r)}}mapDetails(e,t){var s,i;const r=O.get(e,"background.definition.name")||O.get(e,"background.name")||"";return{background:M.sanitizeText(r),originalClass:this.getPrimaryClassName(e),class:this.formatClassString(e),level:t,race:M.sanitizeText(((s=e.race)==null?void 0:s.fullName)||((i=e.race)==null?void 0:i.name)||""),alignment:I.getAlignmentName(e.alignmentId)||"",xp:{value:0,max:this.calculateXPForLevel(t+1),pct:0}}}mapTraits(e){return{size:this.mapSize(e),di:{value:[],bypasses:[],custom:""},dr:{value:[],bypasses:[],custom:""},dv:{value:[],bypasses:[],custom:""},ci:{value:[],custom:""},languages:this.mapLanguages(e),weaponProf:{value:[],custom:""},armorProf:{value:[],custom:""},toolProf:{value:[],custom:""}}}mapCurrency(e){const t=e.currencies||{};return{pp:t.pp||0,gp:t.gp||0,ep:t.ep||0,sp:t.sp||0,cp:t.cp||0}}mapSkills(e,t){const r={},s=["acr","ani","arc","ath","dec","his","ins","inti","inv","med","nat","prc","prf","per","rel","slt","ste","sur"];for(const i of s)r[i]={ability:this.getSkillAbility(i),roll:{min:null,max:null,mode:0},value:this.getSkillProficiency(e,i),bonuses:{check:"",passive:""}};return r}mapSpellSlots(e){const t={};for(let r=1;r<=9;r++)t["spell".concat(r)]={value:0,max:0,override:null};return t.pact={value:0,max:0,override:null,level:1},t}mapBonuses(e){return{mwak:{attack:"",damage:""},rwak:{attack:"",damage:""},msak:{attack:"",damage:""},rsak:{attack:"",damage:""},abilities:{check:"",save:"",skill:""},spell:{dc:""}}}mapResources(e){return{primary:{value:0,max:0,sr:!1,lr:!1,label:""},secondary:{value:0,max:0,sr:!1,lr:!1,label:""},tertiary:{value:0,max:0,sr:!1,lr:!1,label:""}}}async buildItems(e,t){var o;const r=[],s=e.characterData.inventory||[];for(const l of s)l&&l.definition&&r.push(await this.convertEquipmentItem(l));const i=((o=e.characterData.spells)==null?void 0:o.class)||[];for(const l of i)l&&l.definition&&r.push(await this.convertSpellItem(l));const a=e.characterData.classFeatures||[];for(const l of a)l&&l.definition&&r.push(await this.convertFeatureItem(l));return r}buildActiveEffects(e){return[]}buildTokenData(e){const t=e.characterData;return{name:t.name||"Unknown Character",img:this.getCharacterImage(t),width:1,height:1,scale:1,lockRotation:!1,rotation:0,vision:!0,dimSight:0,brightSight:0,sightAngle:0,dimLight:0,brightLight:0,lightAngle:0,lightAlpha:.25,disposition:1,displayName:20,displayBars:20,bar1:{attribute:"attributes.hp"},bar2:{attribute:null},flags:{}}}generateFoundryId(){return Array.from({length:16},()=>Math.floor(Math.random()*16).toString(16)).join("")}getCharacterImage(e){var t;return e.avatarUrl||((t=e.decorations)==null?void 0:t.avatarUrl)||"icons/svg/mystery-man.svg"}calculateTotalLevel(e){return(e.classes||[]).reduce((r,s)=>r+(s.level||0),0)}isAbilitySaveProficient(e,t){var i;return(((i=e.modifiers)==null?void 0:i.class)||[]).find(a=>a.type==="proficiency"&&a.subType==="".concat(t.toLowerCase(),"-saving-throws"))?1:0}calculateHitPoints(e,t,r){const s=e.baseHitPoints||r*8,i=t*r;return Math.max(1,s+i)}mapMovement(e){var s,i;const t=e.race;return{burrow:null,climb:null,fly:null,swim:null,walk:((i=(s=t==null?void 0:t.weightSpeeds)==null?void 0:s.normal)==null?void 0:i.walk)||30,units:"ft",hover:!1}}mapSenses(e){return{darkvision:null,blindsight:null,tremorsense:null,truesight:null,units:"ft",special:""}}getPrimarySpellcastingAbility(e){const t=e.classes||[];for(const r of t){const s=r.definition||r.classDefinition;if(s!=null&&s.spellcastingAbilityId)return this.abilityIdToName(s.spellcastingAbilityId)}return"int"}abilityIdToName(e){return{1:"str",2:"dex",3:"con",4:"int",5:"wis",6:"cha"}[e]||"int"}calculateSpellDC(e,t){const r=this.getPrimarySpellcastingAbility(e),s=O.get(e,"stats.".concat(r))||10,i=Math.floor((s-10)/2);return 8+t+i}getPrimaryClassName(e){var s;const t=e.classes||[];if(t.length===0)return"";const r=t.reduce((i,a)=>(a.level||0)>(i.level||0)?a:i);return((s=r.definition)==null?void 0:s.name)||r.name||""}formatClassString(e){return(e.classes||[]).map(r=>{var i;const s=((i=r.definition)==null?void 0:i.name)||r.name||"Unknown";return"".concat(s," ").concat(r.level||1)}).join(" / ")}mapSize(e){var r;const t=(r=e.race)==null?void 0:r.size;return t&&{Tiny:"tiny",Small:"sm",Medium:"med",Large:"lg",Huge:"huge",Gargantuan:"grg"}[t]||"med"}mapLanguages(e){return{value:[],custom:""}}getSkillAbility(e){return{acr:"dex",ani:"wis",arc:"int",ath:"str",dec:"cha",his:"int",ins:"wis",inti:"cha",inv:"int",med:"wis",nat:"int",prc:"wis",prf:"cha",per:"cha",rel:"int",slt:"dex",ste:"dex",sur:"wis"}[e]||"int"}getSkillProficiency(e,t){var i;return(((i=e.modifiers)==null?void 0:i.class)||[]).find(a=>{var o;return a.type==="proficiency"&&a.subType==="skill"&&((o=a.friendlySubtypeName)==null?void 0:o.toLowerCase().includes(t))})?1:0}async convertEquipmentItem(e){var t,r,s,i,a;return{_id:this.generateFoundryId(),name:M.sanitizeText(((t=e.definition)==null?void 0:t.name)||"Unknown Item"),type:this.getFoundryItemType(e),img:"icons/svg/item-bag.svg",system:{description:{value:M.sanitizeText(((r=e.definition)==null?void 0:r.description)||""),chat:"",unidentified:""},quantity:e.quantity||1,weight:((s=e.definition)==null?void 0:s.weight)||0,price:{value:((i=e.definition)==null?void 0:i.cost)||0,denomination:"gp"},equipped:e.equipped||!1,rarity:"common",identified:!0},effects:[],flags:{"b2fg-converter":{sourceId:(a=e.definition)==null?void 0:a.id,sourceType:"dndbeyond-equipment"}}}}async convertSpellItem(e){var t,r,s,i,a,o,l,c,u,d,f,g,p;return{_id:this.generateFoundryId(),name:M.sanitizeText(((t=e.definition)==null?void 0:t.name)||"Unknown Spell"),type:"spell",img:"icons/svg/book.svg",system:{description:{value:M.sanitizeText(((r=e.definition)==null?void 0:r.description)||""),chat:"",unidentified:""},level:((s=e.definition)==null?void 0:s.level)||0,school:((i=e.definition)==null?void 0:i.school)||"evo",preparation:{mode:"prepared",prepared:e.prepared||!1},components:{vocal:((o=(a=e.definition)==null?void 0:a.components)==null?void 0:o.includes("V"))||!1,somatic:((c=(l=e.definition)==null?void 0:l.components)==null?void 0:c.includes("S"))||!1,material:((d=(u=e.definition)==null?void 0:u.components)==null?void 0:d.includes("M"))||!1,ritual:((f=e.definition)==null?void 0:f.ritual)||!1,concentration:((g=e.definition)==null?void 0:g.concentration)||!1},duration:{value:null,units:"inst"},range:{value:null,long:null,units:"self"},target:{value:null,width:null,units:"",type:""},damage:{parts:[],versatile:""},save:{ability:"",dc:null,scaling:"spell"}},effects:[],flags:{"b2fg-converter":{sourceId:(p=e.definition)==null?void 0:p.id,sourceType:"dndbeyond-spell"}}}}async convertFeatureItem(e){var t,r,s;return{_id:this.generateFoundryId(),name:M.sanitizeText(((t=e.definition)==null?void 0:t.name)||"Unknown Feature"),type:"feat",img:"icons/svg/upgrade.svg",system:{description:{value:M.sanitizeText(((r=e.definition)==null?void 0:r.description)||""),chat:"",unidentified:""},requirements:"",recharge:{value:null,charged:!0},activation:{type:"",cost:null,condition:""},duration:{value:null,units:""},target:{value:null,width:null,units:"",type:""},uses:{value:null,max:"",per:null,recovery:""}},effects:[],flags:{"b2fg-converter":{sourceId:(s=e.definition)==null?void 0:s.id,sourceType:"dndbeyond-feature"}}}}getFoundryItemType(e){var r;const t=(r=e.definition)==null?void 0:r.filterType;return t==="Weapon"?"weapon":t==="Armor"?"equipment":"loot"}async validateOutput(e){try{const t=JSON.parse(e),r=[];return t.name||r.push("Missing character name"),(!t.type||t.type!=="character")&&r.push("Invalid character type"),t.system||r.push("Missing system data"),{isValid:r.length===0,errors:r.length>0?r:void 0}}catch(t){return{isValid:!1,errors:["Invalid JSON format"]}}}getDefaultOptions(){return{includeDescription:!0,includeNotes:!0,spellFormat:"individual",featureDetail:"full",imageHandling:"reference"}}async getSampleOutput(){return JSON.stringify({name:"Sample Character",type:"character",system:{abilities:{str:{value:10}},attributes:{hp:{value:8,max:8}}}},null,2)}calculateXPForLevel(e){const t=[0,300,900,2700,6500,14e3,23e3,34e3,48e3,64e3,85e3,1e5,12e4,14e4,165e3,195e3,225e3,265e3,305e3,355e3];return t[Math.min(e-1,t.length-1)]||0}}class ca{constructor(){this.formatters=new Map,this.formatInfoCache=new Map,this.initializeDefaultFormatters()}initializeDefaultFormatters(){this.register(new la)}register(e){this.formatters.set(e.format,e),this.formatInfoCache.delete(e.format),console.log(" Registered output formatter: ".concat(e.format," v").concat(e.version))}getFormatter(e){const t=this.formatters.get(e);if(!t)throw new Error("Unknown output format: ".concat(e));return t}isFormatSupported(e){return this.formatters.has(e)}getSupportedFormats(){return Array.from(this.formatters.values()).map(e=>this.getFormatInfo(e))}getFormatInfo(e){const t=this.formatInfoCache.get(e.format);if(t)return t;const r={format:e.format,name:this.getFormatDisplayName(e.format),description:this.getFormatDescription(e.format),version:e.version,supportedFeatures:e.supportedFeatures,fileExtension:this.getFileExtension(e.format),mimeType:this.getMimeType(e.format),icon:this.getFormatIcon(e.format)};return this.formatInfoCache.set(e.format,r),r}async generateOutput(e,t,r){const s=this.getFormatter(e);console.log(" Generating ".concat(e," output for character: ").concat(t.characterData.name));try{const i=await s.generateOutput(t,r);return i.success?console.log(" Successfully generated ".concat(e," output")):console.error(" Failed to generate ".concat(e," output:"),i.errors),i}catch(i){return console.error(" Error generating ".concat(e," output:"),i),{success:!1,errors:[{type:"generation_error",message:i instanceof Error?i.message:"Unknown error occurred"}]}}}validateFormatSupport(e,t){const r=this.formatters.get(e);return r?t.every(s=>r.supportedFeatures.includes(s)):!1}getFormatCompatibility(e){const t=new Map;for(const[r,s]of this.formatters){const i=this.analyzeCompatibility(e,s);t.set(r,i)}return t}analyzeCompatibility(e,t){var u,d,f;const r=e.characterData,s=[];let i=100;(r.classes||[]).length>1&&(t.supportedFeatures.includes("multiclass")||(s.push("Multiclass characters may not be fully supported"),i-=20)),(((d=(u=r.spells)==null?void 0:u.class)==null?void 0:d.length)||0)>0&&!t.supportedFeatures.includes("spells")&&(s.push("Spells may not be included"),i-=15),(((f=r.classFeatures)==null?void 0:f.length)||0)>0&&!t.supportedFeatures.includes("features")&&(s.push("Class features may be simplified"),i-=10);let c;return i>=90?c="excellent":i>=75?c="good":i>=60?c="fair":c="poor",{score:i,recommendation:c,warnings:s,dataLoss:Math.max(0,100-i)}}getFormatDisplayName(e){return{"foundry-vtt-json":"Foundry VTT","fantasy-grounds-xml":"Fantasy Grounds","roll20-json":"Roll20","generic-json":"Generic JSON"}[e]||e}getFormatDescription(e){return{"foundry-vtt-json":"JSON format for Foundry Virtual Tabletop D&D 5e system","fantasy-grounds-xml":"XML format for Fantasy Grounds Unity and Classic","roll20-json":"JSON character sheet format for Roll20","generic-json":"Raw character data in JSON format"}[e]||"Character export format"}getFileExtension(e){return{"foundry-vtt-json":".json","fantasy-grounds-xml":".xml","roll20-json":".json","generic-json":".json"}[e]||".txt"}getMimeType(e){return{"foundry-vtt-json":"application/json","fantasy-grounds-xml":"application/xml","roll20-json":"application/json","generic-json":"application/json"}[e]||"text/plain"}getFormatIcon(e){return{"foundry-vtt-json":"","fantasy-grounds-xml":"","roll20-json":"","generic-json":""}[e]||""}getAvailableFormats(){return Array.from(this.formatters.keys())}getDefaultOptions(e){return this.getFormatter(e).getDefaultOptions()}async validateOutput(e,t){return this.getFormatter(e).validateOutput(t)}}const W=new ca;console.log(" Format Registry initialized with formatters:",W.getAvailableFormats());class kr{constructor(){this.characterFetcher=new Lr,this.inventoryProcessor=new ia,this.encumbranceCalculator=new un,this.spellSlotCalculator=new X,this.featureProcessor=new H,this.initializeGameConfig()}async initializeGameConfig(){if(!I.isLoaded())try{await I.loadConfigs()}catch(e){console.warn("Failed to load game configuration, using fallback values:",e)}}async convertFromDNDBeyond(e){var r,s,i,a,o,l,c,u,d,f;const t=performance.now();try{this.reportProgress("Validating character ID",10);const g=await this.fetchCharacterData(e);if(!g.success)return{success:!1,error:g.error};const p=g.data,b=performance.now()-t;if(h.isEnabled("debug_character_data")){if(console.group(" Character Data Debug Info"),console.log(" Basic Info:",{id:p.id,name:p.name,level:this.calculateTotalLevel(p),race:((r=p.race)==null?void 0:r.fullName)||"Unknown",classes:((s=p.classes)==null?void 0:s.map(S=>{var v;return"".concat((v=S.definition)==null?void 0:v.name," ").concat(S.level)}).join(", "))||"None"}),console.log(" Stats & Bonuses:",{stats:p.stats,bonusStats:p.bonusStats,overrideStats:p.overrideStats}),console.log(" Equipment & Inventory:",{inventoryCount:((i=p.inventory)==null?void 0:i.length)||0,inventory:(a=p.inventory)==null?void 0:a.slice(0,5),hasMore:(((o=p.inventory)==null?void 0:o.length)||0)>5}),console.log(" Spells & Features:",{spellsKnown:((l=p.spells)==null?void 0:l.length)||0,classFeatures:((c=p.classes)==null?void 0:c.reduce((S,v)=>{var x;return S+(((x=v.classFeatures)==null?void 0:x.length)||0)},0))||0,raceFeatures:((d=(u=p.race)==null?void 0:u.racialTraits)==null?void 0:d.length)||0}),console.log(" Modifiers & Bonuses:",{modifiers:p.modifiers?Object.keys(p.modifiers):[],bonuses:p.bonuses?Object.keys(p.bonuses):[]}),console.log(" Full Character Object:",p),h.isEnabled("object_search_service")){console.log(" ObjectSearch Service Demo:");const S=j.findByType(p,"proficiency");console.log("Found ".concat(S.length," proficiency modifiers:"),S);const v=j.findByType(p,"feature");console.log("Found ".concat(v.length," class features:"),v.slice(0,3));const x=j.findByEntityType(p,"1446578651");console.log("Found ".concat(x.length," classes via entityTypeId:"),x);const A=j.getAllKeys(p,5);console.log("Available keys (depth 5): ".concat(A.length," total"),A.slice(0,20))}if(h.isEnabled("string_sanitizer_service")&&(console.log(" StringSanitizer Service Demo:"),[p.name||"Unknown Character",'<script>alert("XSS")<\/script>Test Name','Character "The Bold" & Strong',"javascript:alert(1)","Text with\nnewlines	and control\0chars"].forEach((v,x)=>{const A=this.sanitizeString(v),N=M.sanitizeWithReport(v);console.log("Test ".concat(x+1,":"),{original:v,sanitized:A,wasModified:N.wasModified,removedPatterns:N.removedPatterns})})),h.isEnabled("safe_access_service")){console.log(" SafeAccess Service Demo:"),["name","race.fullName","race.definition.name","classes.0.definition.name","classes.0.level","stats.0.value","nonexistent.path","race.racialTraits.0.definition.name","preferences.privacy.showStats"].forEach(A=>{const N=this.safeAccess(p,A),J=O.getWithResult(p,A);console.log("Path: ".concat(A),{value:N,found:J.found,type:typeof N,depth:J.depth})});const v=O.getMultiple(p,["name","race.fullName","classes.0.level"]);console.log("Multiple path access:",v);const x=O.getAllPaths(p,3);console.log("Available paths (depth 3): ".concat(x.length," total"),x.slice(0,15))}if(h.isEnabled("ability_constants")){console.log(" AbilityConstants Demo:");const S=this.getAbilityScores(p);console.log("Character Ability Scores:",S);const v={};if(R.forEach(x=>{const A=S[x]||10;v[x]=P.calculateModifier(A)}),console.log("Ability Modifiers:",v),console.log("Ability Mappings:",{strengthId:P.getAbilityIdByName("strength"),dexterityAbbr:P.getAbbreviation("dexterity"),constitutionById:(f=P.getAbilityById(3))==null?void 0:f.name,validScores:{normal:P.isValidScore(18,!1),withMagic:P.isValidScore(22,!0)}}),S.strength){const x=P.calculateCarryingCapacity(S.strength);console.log("Carrying Capacity (STR ".concat(S.strength,"):"),x)}}if(h.isEnabled("ability_score_processor")){console.log(" AbilityScoreProcessor Service Demo:"),h.isEnabled("debug_ability_score_processor")&&(k.setDebugMode(!0),console.log(" Debug mode enabled for ability score processing"));const S=this.processAbilityBonuses(p);console.log("Processed Ability Scores:",S.totalScores),k.setDebugMode(!1),S.debugInfo.appliedBonuses.length>0&&(console.log("Applied Bonuses:",S.debugInfo.appliedBonuses),console.log("Final Bonus Summary:",S.debugInfo.finalBonusSummary));const v=k.processLegacyFormat(p);console.log("Legacy Format Output:",v.slice(0,3)),console.log("Individual Score Calculations:"),R.forEach((A,N)=>{const J=N+1,Ae=k.getTotalAbilityScore(p,J);console.log("  ".concat(A," (ID ").concat(J,"): ").concat(Ae," (modifier: ").concat(P.calculateModifier(Ae),")"))});const x=k.validateCharacterData(p);console.log("Character Data Validation:",{isValid:x.isValid,issueCount:x.issues.length,warningCount:x.warnings.length}),x.warnings.length>0&&console.warn("Character Data Warnings:",x.warnings),x.issues.length>0&&console.error("Character Data Issues:",x.issues)}if(h.isEnabled("spell_slot_calculator")){console.log(" SpellSlotCalculator Service Demo:"),h.isEnabled("debug_spell_slot_calculator")&&(X.setDebugMode(!0),console.log(" Debug mode enabled for spell slot calculation"));const S=this.extractClassInfo(p);console.log("Extracted Classes:",S);const v=this.calculateSpellSlots(S);console.log("Calculated Spell Slots:",v.spellSlots),X.setDebugMode(!1),console.log("Caster Level Breakdown:",v.debugInfo.casterLevelCalculation),console.log("Class Breakdown:",v.debugInfo.classBreakdown),console.log("Calculation Method: ".concat(v.debugInfo.calculationMethod));const x=X.toLegacyFormat(v.spellSlots);console.log("Legacy Format Spell Slots:",x.filter(N=>N.slots>0));const A=X.validateClassInfo(S);console.log("Class Data Validation:",{isValid:A.isValid,errorCount:A.errors.length}),A.errors.length>0&&console.error("Class Data Errors:",A.errors)}console.groupEnd()}if(this.reportProgress("Parsing character data",50),h.isEnabled("debug_character_data")){const S=p.traits||{};console.log(" Personality Traits:",{personalityTraits:S.personalityTraits?"".concat(S.personalityTraits.substring(0,50),"..."):"None",ideals:S.ideals?"".concat(S.ideals.substring(0,50),"..."):"None",bonds:S.bonds?"".concat(S.bonds.substring(0,50),"..."):"None",flaws:S.flaws?"".concat(S.flaws.substring(0,50),"..."):"None"})}const m=performance.now(),y=await this.parseCharacterToXML(p),w=performance.now()-m;this.reportProgress("Generating XML",90);const _=performance.now()-t;return this.reportProgress("Conversion complete",100),{success:!0,xml:y,characterData:p,performance:{fetchTime:b,parseTime:w,totalTime:_}}}catch(g){return console.error("Conversion error:",g),{success:!1,error:g instanceof Error?g.message:"Unknown conversion error"}}}async convertCharacterData(e){const t=performance.now();try{console.log("Converting character data directly:",e.name),this.reportProgress("Initializing conversion",10),await this.initializeGameConfig(),this.reportProgress("Parsing character data",50);const r=performance.now(),s=await this.parseCharacterToXML(e),i=performance.now()-r;this.reportProgress("Conversion complete",100);const a=performance.now()-t;return{success:!0,xml:s,characterData:e,performance:{fetchTime:0,parseTime:i,totalTime:a}}}catch(r){return console.error("Character data conversion error:",r),{success:!1,error:r instanceof Error?r.message:"Unknown conversion error"}}}async fetchCharacterData(e){return h.isEnabled("character_fetcher")?(console.log("Using new CharacterFetcher service"),this.reportProgress("Fetching from D&D Beyond (new)",25),await this.characterFetcher.fetchCharacter(e)):(console.log("Using legacy character fetching"),this.reportProgress("Fetching from D&D Beyond (legacy)",25),await this.fetchCharacterLegacy(e))}async fetchCharacterLegacy(e){try{const t=this.characterFetcher.validateCharacterID(e);if(!t.valid)return{success:!1,error:t.error};const r=t.sanitized,a="".concat("https://uakari-indigo.fly.dev/").concat("https://character-service.dndbeyond.com/character/v5/character/").concat(r),o=await fetch(a,{method:"GET",headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Origin:"https://www.dndbeyond.com","X-Requested-With":"XMLHttpRequest"}});if(!o.ok){let u;switch(o.status){case 401:case 403:u="Character not found or not public. Ensure character visibility is set to Public.";break;case 404:u="Character not found. Please check the character ID.";break;default:u="Unable to fetch character data (Error ".concat(o.status,"). Please try again.")}return{success:!1,error:u,statusCode:o.status}}const l=await o.json();let c;if(l.success&&l.data)c=l.data;else if(l.id&&l.name)c=l;else return{success:!1,error:"Invalid response format from D&D Beyond API"};return!c||typeof c.id!="number"||!c.name?{success:!1,error:"Invalid character data received from D&D Beyond"}:{success:!0,data:c}}catch(t){console.error("Legacy fetch error:",t);let r="Network error occurred while fetching character data";return t instanceof Error&&(t.message.includes("Failed to fetch")||t.message.includes("NetworkError")?r="Network error. Please check your internet connection and try again.":r=t.message),{success:!1,error:r}}}async parseCharacterToXML(e){var o,l,c,u,d,f,g,p,b,m,y;console.log("parseCharacterToXML called with:",{characterId:e.id,characterName:e.name,dataKeys:Object.keys(e)});const t=this.sanitizeString(e.name||"Unknown Character"),r=e.id||0,s=this.calculateTotalLevel(e),i=I.calculateProficiencyBonus(s),a='<?xml version="1.0" encoding="UTF-8"?>\n<root version="4.7" dataversion="20241002" release="8.1|CoreRPG:7">\n  <character>\n    <name type="string">'.concat(t,'</name>\n    <gender type="string">').concat(this.sanitizeString(e.gender||""),'</gender>\n    <deity type="string">').concat(this.sanitizeString(e.faith||""),'</deity>\n    <age type="string">').concat(this.sanitizeString(e.age||""),'</age>\n    <appearance type="string">').concat(this.sanitizeString(e.hair?"Hair: ".concat(e.hair,", Eyes: ").concat(e.eyes||"",", Skin: ").concat(e.skin||""):""),'</appearance>\n    <height type="string">').concat(this.sanitizeString(e.height||""),'</height>\n    <weight type="string">').concat(this.sanitizeString(e.weight?e.weight.toString():""),'</weight>\n    <size type="string">').concat(I.getDefaultSize(),'</size>\n    <alignment type="string">').concat(this.sanitizeString(I.getAlignmentName(e.alignmentId)),'</alignment>\n    <bonds type="string">').concat(this.sanitizeString(((o=e.traits)==null?void 0:o.bonds)||""),'</bonds>\n    <flaws type="string">').concat(this.sanitizeString(((l=e.traits)==null?void 0:l.flaws)||""),'</flaws>\n    <ideals type="string">').concat(this.sanitizeString(((c=e.traits)==null?void 0:c.ideals)||""),'</ideals>\n    <personalitytraits type="string">').concat(this.sanitizeString(((u=e.traits)==null?void 0:u.personalityTraits)||""),'</personalitytraits>\n    <race type="string">').concat(this.sanitizeString(((d=e.race)==null?void 0:d.fullName)||"Unknown"),'</race>\n    <racelink type="windowreference">\n      <class>reference_race</class>\n      <recordname>reference.race.').concat(this.sanitizeString((((f=e.race)==null?void 0:f.fullName)||"unknown").toLowerCase().replace(/\s+/g,"")),'@*</recordname>\n    </racelink>\n    <background type="string">').concat(this.sanitizeString(((p=(g=e.background)==null?void 0:g.definition)==null?void 0:p.name)||""),'</background>\n    <backgroundlink type="windowreference">\n      <class>reference_background</class>\n      <recordname>reference.background.').concat(this.sanitizeString((((m=(b=e.background)==null?void 0:b.definition)==null?void 0:m.name)||"unknown").toLowerCase().replace(/\s+/g,"")),'@*</recordname>\n    </backgroundlink>\n    <level type="number">').concat(s,'</level>\n    <profbonus type="number">').concat(i,'</profbonus>\n    <notes type="string">').concat(this.generateNotesText(e,r),'</notes>\n    <perception type="number">0</perception>\n    <perceptionmodifier type="number">0</perceptionmodifier>\n    <exp type="number">').concat(e.currentXp||0,'</exp>\n    <expneeded type="number">0</expneeded>\n    \n    <!-- Abilities with proper template structure -->\n    <abilities>\n      ').concat(this.generateAbilitiesXML(e),"\n    </abilities>\n    \n    <!-- Classes with template structure -->\n    <classes>\n      ").concat(((y=e.classes)==null?void 0:y.map((w,_)=>{var S,v,x;return"<id-".concat(String(_+1).padStart(5,"0"),'>\n        <casterpactmagic type="number">0</casterpactmagic>\n        <hddie type="dice">').concat((S=w.definition)!=null&&S.hitDie?"d".concat(w.definition.hitDie):I.getDefaultHitDie(),'</hddie>\n        <hdused type="number">0</hdused>\n        <level type="number">').concat(w.level||1,'</level>\n        <name type="string">').concat(this.sanitizeString(((v=w.definition)==null?void 0:v.name)||"Unknown"),'</name>\n        <shortcut type="windowreference">\n          <class>reference_class</class>\n          <recordname>reference.class.').concat(this.sanitizeString((((x=w.definition)==null?void 0:x.name)||"unknown").toLowerCase()),"@*</recordname>\n        </shortcut>\n      </id-").concat(String(_+1).padStart(5,"0"),">")}).join("\n      "))||"","\n    </classes>\n    \n    <!-- Currency -->\n    <coins>\n      ").concat(this.generateCoinsXML(e),'\n    </coins>\n    \n    <!-- Hit Points -->\n    <hp>\n      <total type="number">').concat(this.calculateHP(e),'</total>\n      <wounds type="number">0</wounds>\n      <temporary type="number">0</temporary>\n    </hp>\n\n    <!-- Defenses -->\n    <defenses>\n      <ac>\n        ').concat(this.generateACComponents(e),"\n      </ac>\n    </defenses>\n    \n    ").concat(this.generateEncumbranceXML(e),"\n    \n    <!-- Placeholder sections for Phase 2 -->\n    <featlist>\n      ").concat(this.generateFeatsXML(e),"\n    </featlist>\n    \n    <featurelist>\n      ").concat(this.generateFeaturesXML(e),"\n    </featurelist>\n    \n    ").concat(this.generateInventoryXML(e),"\n    \n    <languagelist>\n      ").concat(this.generateLanguagesXML(e),"\n    </languagelist>\n    \n    <powergrouplist>\n      ").concat(this.generatePowerGroupXML(e),"\n    </powergrouplist>\n    \n    <skilllist>\n      ").concat(this.generateSkillsXML(e),"\n    </skilllist>\n    \n    <proficiencylist>\n      ").concat(this.generateProficienciesXML(e),"\n    </proficiencylist>\n    \n    <traitlist>\n      ").concat(this.generateTraitsXML(e),"\n    </traitlist>\n    \n    <weaponlist>\n      ").concat(this.generateWeaponsXML(e),"\n    </weaponlist>\n    \n    <powers>\n      ").concat(this.generateSpellsXML(e),"\n    </powers>\n    \n    ").concat(this.generatePowerMetaXML(e),"\n  </character>\n</root>");return console.log("Generated mock XML for character:",t),a}reportProgress(e,t,r){this.onProgress&&this.onProgress(e,t),console.log("Progress: ".concat(e," (").concat(t,"%)").concat(r?" - ".concat(r):""))}async checkServiceAvailability(){const e=h.isEnabled("character_fetcher");return{proxyService:await this.characterFetcher.checkServiceHealth(),legacyParser:typeof window<"u"&&!!window.parseCharacter,usingNewFetcher:e}}calculateTotalLevel(e){return!e.classes||!Array.isArray(e.classes)?1:e.classes.reduce((t,r)=>t+(r.level||0),0)||1}generatePowerGroupXML(e){if(!h.isEnabled("spell_slot_calculator"))return"<!-- Spell slots disabled by feature flag -->";try{const t=this.extractClassInfo(e),r=this.calculateSpellSlots(t);if(!r||!r.spellSlots)return"<!-- No spell slots calculated -->";const s=r.spellSlots,i=t.some(l=>l.classDefinition.name.toLowerCase()==="warlock"),a=Object.values(r.spellSlots).some(l=>l>0),o=Object.values(r.pactMagicSlots).some(l=>l>0);return!a&&!o?"<!-- Character has no spell slots -->":i&&o?this.generatePactMagicPowerGroupXML(e,t):this.generateRegularSpellPowerGroupXML(r.spellSlots,r.debugInfo)}catch(t){return console.error("Error generating spell slots XML:",t),"<!-- Error generating spell slots -->"}}generateRegularSpellPowerGroupXML(e,t){const r=[{key:"level1",name:"1st Level"},{key:"level2",name:"2nd Level"},{key:"level3",name:"3rd Level"},{key:"level4",name:"4th Level"},{key:"level5",name:"5th Level"},{key:"level6",name:"6th Level"},{key:"level7",name:"7th Level"},{key:"level8",name:"8th Level"},{key:"level9",name:"9th Level"}];let s="",i=1;return r.forEach(a=>{const o=e[a.key]||0;o>0&&(s+="      <id-".concat(String(i).padStart(5,"0"),'>\n        <castertype type="string">memorized</castertype>\n        <name type="string">').concat(this.sanitizeString(a.name+" Spells"),'</name>\n        <stat type="string">charisma</stat>\n        <powers>\n          <!-- Spell slots: ').concat(o," -->\n        </powers>\n      </id-").concat(String(i).padStart(5,"0"),">\n"),i++)}),s||"<!-- No spell slots available -->"}generatePactMagicPowerGroupXML(e,t){const r=t.find(i=>i.name==="warlock");return r?(this.getWarlockPactMagicSlots(r.level),'      <id-00001>\n        <castertype type="string">pact</castertype>\n        <name type="string">Pact Magic</name>\n        <stat type="string">charisma</stat>\n        <powers>\n          <!-- Warlock spells -->\n        </powers>\n      </id-00001>\n'):"<!-- No warlock class found -->"}getWarlockPactMagicSlots(e){return e>=17?{level5:4}:e>=15?{level5:3}:e>=11?{level5:2}:e>=9?{level5:2}:e>=7?{level4:2}:e>=5?{level3:2}:e>=3?{level2:2}:e>=2?{level1:2}:e>=1?{level1:1}:{}}generatePowerMetaXML(e){if(!h.isEnabled("spell_slot_calculator"))return"<!-- Spell slot meta disabled by feature flag -->";try{const t=this.extractClassInfo(e),r=this.calculateSpellSlots(t);if(!r||!r.spellSlots)return"<!-- No spell slot meta calculated -->";const s=this.spellSlotCalculator.generateSpellSlotsXML(r);return"    ".concat(s.combinedXML)}catch(t){return console.error("Failed to generate spell slot meta XML:",t),"<!-- Spell slot meta generation failed -->"}}generateSpellSlotsXML(e){if(!h.isEnabled("spell_slot_calculator"))return"<!-- Spell slots disabled by feature flag -->";try{const t=this.extractClassInfo(e),r=this.calculateSpellSlots(t);if(!r||!r.spellSlots)return"<!-- No spell slots calculated -->";const s=this.spellSlotCalculator.generateSpellSlotsXML(r),i=Object.values(r.spellSlots).some(o=>o>0),a=Object.values(r.pactMagicSlots).some(o=>o>0);return!i&&!a?"<!-- Character has no spell slots -->":s.spellSlotsXML||s.pactMagicXML}catch(t){return console.error("Failed to generate spell slots XML:",t),"<!-- Spell slots generation failed -->"}}generateAbilitiesXML(e){const t=I.getAbilities(),r=this.getAbilityScores(e);return t.map(s=>{const i=r[s.name]||I.getDefaultAbilityScore(),a=I.calculateAbilityModifier(i);return"<".concat(s.name,'>\n        <bonus type="number">').concat(a,'</bonus>\n        <save type="number">').concat(a,'</save>\n        <savemodifier type="number">0</savemodifier>\n        <saveprof type="number">0</saveprof>\n        <score type="number">').concat(i,"</score>\n      </").concat(s.name,">")}).join("\n      ")}sanitizeString(e){return h.isEnabled("string_sanitizer_service"),M.sanitizeForXML(e)}safeAccess(e,t,r=null){return h.isEnabled("safe_access_service"),O.get(e,t,r)}processAbilityBonuses(e){return h.isEnabled("ability_score_processor"),k.processAbilityScoreBonuses(e)}getAbilityScores(e){if(h.isEnabled("ability_score_processor")){const t=k.processAbilityScoreBonuses(e),r={};return R.forEach(s=>{var i;r[s]=((i=t.totalScores[s])==null?void 0:i.total)||10}),r}else{if(h.isEnabled("ability_constants"))return P.convertLegacyAbilities(e.stats||[],e.bonusStats,e.overrideStats);{const t={};return["strength","dexterity","constitution","intelligence","wisdom","charisma"].forEach((s,i)=>{var c,u,d,f,g,p;const a=((u=(c=e.stats)==null?void 0:c[i])==null?void 0:u.value)||10,o=((f=(d=e.bonusStats)==null?void 0:d[i])==null?void 0:f.value)||0,l=(p=(g=e.overrideStats)==null?void 0:g[i])==null?void 0:p.value;t[s]=l!=null?l:a+o}),t}}}enableAbilityScoreDebug(e=!0){k.setDebugMode(e),console.log(" Ability Score Processor debug mode ".concat(e?"enabled":"disabled"))}enableSpellSlotDebug(e=!0){X.setDebugMode(e),console.log(" Spell Slot Calculator debug mode ".concat(e?"enabled":"disabled"))}extractClassInfo(e){return!e.classes||!Array.isArray(e.classes)?[]:e.classes.map((t,r)=>{var o,l,c,u,d,f,g;const s=((o=t.definition)==null?void 0:o.name)||"unknown",i=t.level||1,a=(l=t.subclassDefinition)==null?void 0:l.name;return{id:((c=t.definition)==null?void 0:c.id)||r+1,level:i,classDefinition:{id:((u=t.definition)==null?void 0:u.id)||r+1,name:s,canCastSpells:((d=t.definition)==null?void 0:d.canCastSpells)||!1,spellCastingAbilityId:(f=t.definition)==null?void 0:f.spellCastingAbilityId},subclassDefinition:a?{id:((g=t.subclassDefinition)==null?void 0:g.id)||0,name:a}:void 0}})}calculateSpellSlots(e){return h.isEnabled("spell_slot_calculator")?this.spellSlotCalculator.calculateSpellSlots(e):this.spellSlotCalculator.calculateSpellSlots(e)}generateEncumbranceXML(e){try{const t=this.calculateEncumbrance(e);return t?(console.log(" Generated encumbrance XML: ".concat(t.totalWeight," lbs, ").concat(t.encumbranceLevel)),'<!-- Encumbrance -->\n    <encumbrance>\n      <encumbered type="number">'.concat(t.carryingCapacity.normal,'</encumbered>\n      <encumberedheavy type="number">').concat(t.carryingCapacity.normal*2,'</encumberedheavy>\n      <liftpushdrag type="number">').concat(t.carryingCapacity.push,'</liftpushdrag>\n      <load type="number">').concat(Math.round(t.totalWeight),'</load>\n      <max type="number">').concat(t.carryingCapacity.normal,"</max>\n    </encumbrance>")):(console.warn("No encumbrance data calculated"),'<!-- Encumbrance -->\n    <encumbrance>\n      <encumbered type="number">0</encumbered>\n      <encumberedheavy type="number">0</encumberedheavy>\n      <liftpushdrag type="number">0</liftpushdrag>\n      <load type="number">0</load>\n      <max type="number">0</max>\n    </encumbrance>')}catch(t){return console.error("Failed to generate encumbrance XML:",t),'<!-- Encumbrance generation failed -->\n    <encumbrance>\n      <encumbered type="number">0</encumbered>\n      <encumberedheavy type="number">0</encumberedheavy>\n      <liftpushdrag type="number">0</liftpushdrag>\n      <load type="number">0</load>\n      <max type="number">0</max>\n    </encumbrance>'}}generateInventoryXML(e){try{const t=this.processInventory(e);return t.xmlResult&&t.xmlResult.xml?(console.log(" Generated inventory XML: ".concat(t.statistics.totalItems," items")),t.xmlResult.xml):(console.warn("No inventory XML generated"),"<inventorylist>\n			<!-- No inventory items -->\n		</inventorylist>")}catch(t){return console.error("Failed to generate inventory XML:",t),"<inventorylist>\n			<!-- Inventory generation failed -->\n		</inventorylist>"}}generateFeaturesXML(e){if(h.isEnabled("feature_processor"))try{console.log(" Using modern FeatureProcessor service for class features"),h.isEnabled("feature_processor_debug")&&H.setDebugMode(!0);const t=this.featureProcessor.processCharacterFeatures(e),r=this.featureProcessor.generateFeaturesXML(t);if(H.setDebugMode(!1),h.isEnabled("feature_processor_debug")){console.log("Class Features Breakdown:",t.debugInfo.classBreakdown),console.log("Processing Method: ".concat(t.debugInfo.processingMethod)),console.log("Features by Class:",t.featuresByClass),console.log("Traits by Race:",t.traitsByRace);const s=H.validateCharacterData(e);console.log("Feature Data Validation:",{isValid:s.isValid,errorCount:s.errors.length}),s.errors.length>0&&console.error("Feature Data Errors:",s.errors)}return console.log(" Generated features XML: ".concat(t.totalFeatures," total features")),r}catch(t){return console.error("Failed to generate features XML:",t),"<!-- Feature processing failed -->"}else return console.log(" Using legacy feature processing (placeholder)"),"<!-- Legacy feature processing not yet implemented -->"}generateTraitsXML(e){if(h.isEnabled("feature_processor"))try{console.log(" Using modern FeatureProcessor service for racial traits"),h.isEnabled("feature_processor_debug")&&H.setDebugMode(!0);const t=this.featureProcessor.processCharacterFeatures(e),r=this.featureProcessor.generateTraitsXML(t);return H.setDebugMode(!1),h.isEnabled("feature_processor_debug")&&(console.log("Racial Traits Breakdown:",t.debugInfo.raceBreakdown),console.log("Processing Method: ".concat(t.debugInfo.processingMethod)),console.log("Traits by Race:",t.traitsByRace)),console.log(" Generated traits XML: ".concat(t.debugInfo.raceBreakdown.traitCount," total traits")),r}catch(t){return console.error("Failed to generate traits XML:",t),"<!-- Trait processing failed -->"}else return console.log(" Using legacy trait processing (placeholder)"),"<!-- Legacy trait processing not yet implemented -->"}generateWeaponsXML(e){var t,r,s,i,a,o;try{if(console.log(" Generating weapons XML"),!h.isEnabled("inventory_processor"))return console.log(" Inventory processor disabled by feature flag"),"<!-- Inventory processor disabled -->";console.log(" Character inventory data:",{hasInventory:!!e.inventory,inventoryLength:((t=e.inventory)==null?void 0:t.length)||0,inventoryType:Array.isArray(e.inventory)?"array":typeof e.inventory});const l=this.inventoryProcessor.processInventory(e.inventory||[],e.id,{includeZeroQuantityItems:!1,respectContainerHierarchy:!0,generateDetailedXML:!0,sanitizeOutput:!0,includeCostInformation:!1,markItemsAsIdentified:!0});console.log(" Inventory processing result:",{hasResult:!!l,hasNestedStructure:!!(l!=null&&l.nestedStructure),hasRootItems:!!((r=l==null?void 0:l.nestedStructure)!=null&&r.rootItems),rootItemsType:Array.isArray((s=l==null?void 0:l.nestedStructure)==null?void 0:s.rootItems)?"array":typeof((i=l==null?void 0:l.nestedStructure)==null?void 0:i.rootItems),rootItemsLength:((o=(a=l==null?void 0:l.nestedStructure)==null?void 0:a.rootItems)==null?void 0:o.length)||0});const c=[];let u=0;if(!l||!l.nestedStructure||!l.nestedStructure.rootItems)return console.log(" No inventory items found or invalid inventory structure"),"<!-- No inventory items found -->";const d=l.nestedStructure.rootItems,f=l.nestedStructure.containers,g=d.length;h.isEnabled("weaponlist_debug")&&console.log(" Processing ".concat(g," root items + ").concat(f.size," containers for weapons"));for(const m of d)if(h.isEnabled("weaponlist_debug")&&console.log(" Checking item: ".concat(m.definition.name),{filterType:m.definition.filterType,isWeapon:m.definition.filterType==="Weapon",itemType:m.definition.type,equipped:m.equipped,hasWeaponBehaviors:!!m.definition.weaponBehaviors}),this.isWeapon(m)){h.isEnabled("weaponlist_debug")&&console.log(" Found weapon: ".concat(m.definition.name));const y=this.extractWeaponData(m,u);if(y&&(c.push(y),u++,this.isThrown(m))){const w=this.extractThrownWeaponData(m,u);w&&(c.push(w),u++)}}h.isEnabled("weaponlist_debug")&&console.log(" Checking ".concat(f.size," containers for weapons")),f.forEach((m,y)=>{h.isEnabled("weaponlist_debug")&&console.log(" Checking container: ".concat(m.definition.name," with ").concat(m.contents.length," items"));for(const w of m.contents)if(h.isEnabled("weaponlist_debug")&&console.log(" Checking container item: ".concat(w.definition.name),{filterType:w.definition.filterType,isWeapon:w.definition.filterType==="Weapon",containerName:m.definition.name}),this.isWeapon(w)){h.isEnabled("weaponlist_debug")&&console.log(" Found weapon in container: ".concat(w.definition.name));const _=this.extractWeaponData(w,u);if(_&&(c.push(_),u++,this.isThrown(w))){const S=this.extractThrownWeaponData(w,u);S&&(c.push(S),u++)}}}),this.linkAmmoToWeapons(c,l.nestedStructure),this.isCharacterMonk(e)&&c.push(this.getMonkUnarmedStrike(u)),console.log(" Final weapons array length: ".concat(c.length),c);let b="";return c.forEach((m,y)=>{const w=String(y+1).padStart(5,"0");b+="      <id-".concat(w,'>\n        <attackbonus type="number">').concat(m.attackBonus,'</attackbonus>\n        <attackstat type="string">').concat(m.attackStat,'</attackstat>\n        <carried type="number">1</carried>\n        <damagelist>\n          <id-00001>\n            <bonus type="number">').concat(m.damage.bonus,'</bonus>\n            <dice type="dice">').concat(m.damage.dice,'</dice>\n            <stat type="string">').concat(m.attackStat,'</stat>\n            <type type="string">').concat(m.damage.type,'</type>\n          </id-00001>\n        </damagelist>\n        <handling type="number">0</handling>\n        <isidentified type="number">1</isidentified>\n        <name type="string">').concat(this.sanitizeString(m.name),'</name>\n        <properties type="string">').concat(this.sanitizeString(m.properties),'</properties>\n        <shortcut type="windowreference">\n          <class>item</class>\n          <recordname>').concat(m.shortcut,'</recordname>\n        </shortcut>\n        <type type="number">').concat(m.weaponType,"</type>"),m.maxAmmo!==void 0&&(b+='\n        <maxammo type="number">'.concat(m.maxAmmo,"</maxammo>")),b+="\n      </id-".concat(w,">\n")}),console.log(" Generated weapons XML: ".concat(c.length," weapons")),b}catch(l){return console.error("Failed to generate weapons XML:",l),"<!-- Weapon processing failed -->"}}generateSpellsXML(e){var t,r;try{if(console.log(" Generating spells XML"),!e.spells||!e.classSpells)return console.log(" No spell data found"),"<!-- No spells found -->";const s=[];let i=0;h.isEnabled("spelllist_debug")&&console.log(" Processing ".concat(((t=e.classSpells)==null?void 0:t.length)||0," class spell collections")),(r=e.classSpells)==null||r.forEach(l=>{var u,d;const c=this.getClassNameById(e,l.characterClassId);h.isEnabled("spelllist_debug")&&console.log(" Processing ".concat(c," spells: ").concat(((u=l.spells)==null?void 0:u.length)||0," spells")),(d=l.spells)==null||d.forEach(f=>{const g=this.extractSpellData(f,c);g&&(h.isEnabled("spelllist_debug")&&console.log(" Added ".concat(c," spell: ").concat(g.name," (Level ").concat(g.level,")")),s.push(g),i++)})}),e.spells.class&&e.spells.class.forEach(l=>{const c=this.extractSpellData(l,"Class");c&&(s.push(c),i++)}),e.spells.race&&e.spells.race.forEach(l=>{const c=this.extractSpellData(l,"Race");c&&(s.push(c),i++)}),e.spells.feat&&e.spells.feat.forEach(l=>{const c=this.extractSpellData(l,"Feat");c&&(s.push(c),i++)}),e.spells.item&&e.spells.item.forEach(l=>{const c=this.extractSpellData(l,"Item");c&&(s.push(c),i++)}),console.log(" Found ".concat(s.length," spells total"));const a=this.extractActivePowers(e);h.isEnabled("spelllist_debug")&&(console.log(" Found ".concat(a.length," active features/traits to add as powers")),a.forEach(l=>{console.log(" Feature found: ".concat(l.name," (").concat(l.source,")"))})),a.forEach(l=>s.push(l)),console.log(" Found ".concat(a.length," active features/traits to add as powers")),console.log(" Total powers (spells + features): ".concat(s.length));let o="";return s.forEach((l,c)=>{const u=String(c+1).padStart(5,"0");o+="      <id-".concat(u,">");const d=this.generateSpellActions(l);d&&(o+="\n        <actions>\n".concat(d,"        </actions>")),l.powerType==="feature"?o+='\n        <cast type="number">0</cast>\n        <description type="formattedtext">\n          <p>'.concat(this.sanitizeString(l.description),'</p>\n        </description>\n        <group type="string">').concat(this.sanitizeString(l.group),'</group>\n        <level type="number">').concat(l.level,'</level>\n        <locked type="number">1</locked>\n        <name type="string">').concat(this.sanitizeString(l.name),'</name>\n        <prepared type="number">').concat(l.prepared,'</prepared>\n        <ritual type="number">').concat(l.ritual?1:0,'</ritual>\n        <source type="string">').concat(this.sanitizeString(l.source),"</source>"):o+='\n        <castingtime type="string">'.concat(this.sanitizeString(l.castingTime),'</castingtime>\n        <components type="string">').concat(this.sanitizeString(l.components),'</components>\n        <description type="formattedtext">\n          <p>').concat(this.sanitizeString(l.description),'</p>\n        </description>\n        <duration type="string">').concat(this.sanitizeString(l.duration),'</duration>\n        <group type="string">Spells</group>\n        <level type="number">').concat(l.level,'</level>\n        <name type="string">').concat(this.sanitizeString(l.name),'</name>\n        <prepared type="number">').concat(l.prepared?1:0,'</prepared>\n        <range type="string">').concat(this.sanitizeString(l.range),'</range>\n        <ritual type="number">').concat(l.ritual?1:0,'</ritual>\n        <school type="string">').concat(this.sanitizeString(l.school),'</school>\n        <source type="string">').concat(this.sanitizeString(l.source),"</source>"),o+="\n      </id-".concat(u,">\n")}),console.log(" Generated spells XML: ".concat(s.length," spells")),o}catch(s){return console.error("Failed to generate spells XML:",s),"<!-- Spell processing failed -->"}}generateFeatsXML(e){try{console.log(" Generating feats XML");const t=e.feats||[];if(!Array.isArray(t))return console.log(" No feats array found in character data"),"<!-- No feats data found -->";if(t.length===0)return console.log(" Character has no feats"),"<!-- Character has no feats -->";let r="";return t.forEach((s,i)=>{var c,u;const a=String(i+1).padStart(5,"0"),o=((c=s.definition)==null?void 0:c.name)||s.name||"Unknown Feat",l=((u=s.definition)==null?void 0:u.description)||s.description||"";r+="      <id-".concat(a,'>\n        <locked type="number">1</locked>\n        <name type="string">').concat(this.sanitizeString(o),'</name>\n        <text type="formattedtext">\n          <p>').concat(this.sanitizeString(l),"</p>\n        </text>\n      </id-").concat(a,">\n"),o==="Medium Armor Master"?console.log(" Found Medium Armor Master feat"):o==="Alert"?console.log(" Found Alert feat"):o==="Mobile"?console.log(" Found Mobile feat"):o==="Observant"&&console.log(" Found Observant feat")}),console.log(" Generated feats XML: ".concat(t.length," feats")),r}catch(t){return console.error("Failed to generate feats XML:",t),"<!-- Feat processing failed -->"}}generateCoinsXML(e){try{console.log(" Generating coins XML");const t=e.currencies||{};Object.keys(t).length===0&&console.log(" No currency data found in character");const r=[{key:"pp",name:"PP",amount:t.pp||0},{key:"gp",name:"GP",amount:t.gp||0},{key:"ep",name:"EP",amount:t.ep||0},{key:"sp",name:"SP",amount:t.sp||0},{key:"cp",name:"CP",amount:t.cp||0}];let s="";return r.forEach((i,a)=>{const o=a+1;s+="      <slot".concat(o,'>\n        <amount type="number">').concat(i.amount,'</amount>\n        <name type="string">').concat(i.name,"</name>\n      </slot").concat(o,">\n")}),s+='      <slot6>\n        <amount type="number">0</amount>\n      </slot6>\n',console.log(" Generated coins XML:",r.map(i=>"".concat(i.name,": ").concat(i.amount)).join(", ")),s}catch(t){return console.error("Failed to generate coins XML:",t),"<!-- Coin processing failed -->"}}generateNotesText(e,t){try{console.log(" Generating character notes");let r="";if(r+="D&D Beyond Character ID: ".concat(t,"\\n"),e.notes&&typeof e.notes=="object"){const i=Object.entries(e.notes);i.length>0?(console.log(" Found ".concat(i.length," note categories")),i.forEach(([a,o])=>{if(o!=null&&o!==""){const l=a.charAt(0).toUpperCase()+a.substring(1),c=this.sanitizeString(o).trim();r+="".concat(l,": ").concat(c,"\\n"),console.log(" Added note: ".concat(l," (").concat(c.length," chars)"))}})):console.log(" Notes object exists but is empty")}else console.log(" No notes found in character data");const s=r.replace(/\\n$/,"");return console.log(" Generated notes text (".concat(s.length," chars total)")),this.sanitizeString(s)}catch(r){return console.error("Failed to generate notes text:",r),this.sanitizeString("Character converted from D&D Beyond (ID: ".concat(t,") using Modern Converter v2.0"))}}generateProficienciesXML(e){try{console.log(" Generating proficiencies XML");const t=new Set;e.modifiers&&Object.values(e.modifiers).forEach(i=>{Array.isArray(i)&&i.forEach(a=>{if(a.type==="proficiency"&&a.isGranted){const o=a.friendlySubtypeName||a.subType;!this.isSkillProficiency(a.subType)&&!this.isSavingThrowProficiency(a.subType)&&!this.isPlaceholderProficiency(o)&&t.add(o)}})});let r="",s=1;return t.forEach(i=>{const a=String(s).padStart(5,"0");r+="      <id-".concat(a,'>\n        <name type="string">').concat(i,"</name>\n      </id-").concat(a,">\n"),s++}),console.log(" Generated ".concat(t.size," proficiencies")),r}catch(t){return console.error("Error generating proficiencies XML:",t),"<!-- Error generating proficiencies -->"}}isSkillProficiency(e){return["acrobatics","animal-handling","arcana","athletics","deception","history","insight","intimidation","investigation","medicine","nature","perception","performance","persuasion","religion","sleight-of-hand","stealth","survival"].includes(e)}isSavingThrowProficiency(e){return e.includes("saving-throws")}isPlaceholderProficiency(e){return["Choose a Barbarian Skill","Choose a Sorcerer Skill Proficiency","Choose a Sorcerer Skill Proficiency "].includes(e)}processInventory(e){if(h.isEnabled("inventory_processor"))try{console.log(" Using modern InventoryProcessor service");const t=this.convertToInventoryItems(e.inventory||[]),r=e.id,s={includeZeroQuantityItems:!1,respectContainerHierarchy:!0,generateDetailedXML:!1,sanitizeOutput:h.isEnabled("string_sanitizer_service"),includeCostInformation:!0,markItemsAsIdentified:!0};return this.inventoryProcessor.processInventory(t,r,s)}catch(t){console.warn("InventoryProcessor failed, falling back to legacy:",t)}return console.log(" Using legacy inventory processing"),{nestedStructure:{characterId:e.id,rootItems:[],containers:new Map,totalItems:0,totalWeight:0},xmlResult:{xml:"<!-- Legacy inventory processing not implemented -->",itemCount:0,totalWeight:0,containerCount:0,debugInfo:{processedItems:0,skippedItems:0,containerItems:0,magicContainers:[]}},statistics:{totalItems:0,containerCount:0,magicContainers:0,totalWeight:0}}}calculateEncumbrance(e){if(h.isEnabled("encumbrance_calculator"))try{console.log(" Using modern EncumbranceCalculator service");const t={id:e.id,strengthScore:this.getAbilityScore(e,1),hasPowerfulBuild:un.hasPowerfulBuild(e)},r=this.convertToInventoryItems(e.inventory||[]),s={includeContainerWeights:!0,respectMagicContainers:!0,applyRacialTraits:!0};return this.encumbranceCalculator.calculateEncumbrance(t,r,s)}catch(t){console.warn("EncumbranceCalculator failed, falling back to legacy:",t)}return console.log(" Using legacy encumbrance calculation"),{totalWeight:0,carryingCapacity:{normal:0,push:0,lift:0,powerfulBuild:!1},encumbranceLevel:"unencumbered",speedPenalty:0,disadvantageOnChecks:!1}}convertToInventoryItems(e){return e.map(t=>({id:t.id,entityTypeId:t.entityTypeId,definition:{id:t.definition.id,name:t.definition.name,weight:t.definition.weight||0,bundleSize:t.definition.bundleSize||1,isContainer:t.definition.isContainer||!1,weightMultiplier:t.definition.weightMultiplier,filterType:t.definition.filterType,subType:t.definition.subType,description:t.definition.description,cost:t.definition.cost?{quantity:t.definition.cost.quantity,unit:t.definition.cost.unit}:void 0},quantity:t.quantity,isAttuned:t.isAttuned||!1,equipped:t.equipped||!1,containerEntityId:t.containerEntityId,charges:t.charges,customName:t.customName,customWeight:t.customWeight,customCost:t.customCost}))}getAbilityScore(e,t){var i,a;const r=(i=e.stats)==null?void 0:i.find(o=>o.id===t),s=(a=e.bonusStats)==null?void 0:a.find(o=>o.id===t);return((r==null?void 0:r.value)||10)+((s==null?void 0:s.value)||0)}generateSkillsXML(e){const t=["acrobatics","animal_handling","arcana","athletics","deception","history","insight","intimidation","investigation","medicine","nature","perception","performance","persuasion","religion","sleight_of_hand","stealth","survival"],r=["dexterity","wisdom","intelligence","strength","charisma","intelligence","wisdom","charisma","intelligence","wisdom","intelligence","wisdom","charisma","charisma","intelligence","dexterity","dexterity","wisdom"];let s="";return t.forEach((i,a)=>{const o=String(a+1).padStart(5,"0");let l=i;i.match(/^sleight/)?l="Sleight of Hand":i.includes("animal")?l="Animal Handling":l=i.split("_").map(g=>g.charAt(0).toUpperCase()+g.slice(1)).join(" ");let c=0;const u=j.find(e,"type","proficiency");u&&u.length>0&&u.some(p=>{var m;return((m=p.subType)==null?void 0:m.replace(/-/g,"_"))===i})&&(c=1);const d=j.find(e,"type","expertise");d&&d.length>0&&d.some(p=>{var m;return((m=p.subType)==null?void 0:m.replace(/-/g,"_"))===i})&&(c=2);const f=j.find(e,"type","half-proficiency");f&&f.length>0&&c===0&&f.some(p=>{var m;return((m=p.subType)==null?void 0:m.replace(/-/g,"_"))===i})&&(c=3),s+="      <id-".concat(o,">\n"),s+='        <misc type="number">0</misc>\n',s+='        <name type="string">'.concat(l,"</name>\n"),s+='        <stat type="string">'.concat(r[a],"</stat>\n"),s+='        <prof type="number">'.concat(c,"</prof>\n"),s+="      </id-".concat(o,">\n")}),s}generateLanguagesXML(e){var a;let t="";const r=new Set,s=j.find(e,"type","language");return s&&s.length>0&&s.forEach(o=>{const l=o.friendlySubtypeName||o.subType||"Unknown Language";r.add(l)}),(a=e.race)!=null&&a.racialTraits&&e.race.racialTraits.forEach(o=>{var l,c;if((c=(l=o.definition)==null?void 0:l.name)!=null&&c.toLowerCase().includes("language")){const u=o.definition.description||"";["Common","Elvish","Dwarvish","Halfling","Orcish","Gnomish","Giant","Draconic"].forEach(f=>{u.includes(f)&&r.add(f)})}}),Array.from(r).sort().forEach((o,l)=>{const c=String(l+1).padStart(5,"0");t+="      <id-".concat(c,">\n"),t+='        <name type="string">'.concat(this.sanitizeString(o),"</name>\n"),t+="      </id-".concat(c,">\n")}),t}async generateMultiFormatOutput(e,t,r){console.log(" Generating multi-format output for character: ".concat(e.name)),console.log(" Requested formats: ".concat(t.join(", ")));const s=await this.prepareProcessedCharacterData(e),i=new Map;for(const a of t)try{console.log(" Generating ".concat(a," output..."));const o=await W.generateOutput(a,s,r);i.set(a,o),o.success?console.log(" Successfully generated ".concat(a," output")):console.error(" Failed to generate ".concat(a," output:"),o.errors)}catch(o){console.error(" Error generating ".concat(a," output:"),o),i.set(a,{success:!1,errors:[{type:"generation_error",message:o instanceof Error?o.message:"Unknown error occurred"}]})}return i}async generateFormatOutput(e,t,r){console.log(" Generating ".concat(t," output for character: ").concat(e.name));const s=await this.prepareProcessedCharacterData(e);return W.generateOutput(t,s,r)}async prepareProcessedCharacterData(e){var s;const t=((s=e.classes)==null?void 0:s.reduce((i,a)=>i+(a.level||0),0))||1,r=Math.ceil(t/4)+1;return{characterData:e,totalLevel:t,proficiencyBonus:r,abilities:e.stats||null,spellSlots:null,inventory:null,features:null}}async getFormatCompatibility(e){const t=await this.prepareProcessedCharacterData(e);return W.getFormatCompatibility(t)}getAvailableFormats(){return W.getSupportedFormats()}isFormatSupported(e){return W.isFormatSupported(e)}getFormatDefaultOptions(e){return W.getDefaultOptions(e)}getFeatureFlagStatus(){return{character_fetcher:h.isEnabled("character_fetcher"),modern_converter:h.isEnabled("modern_converter"),legacy_fallback:h.isEnabled("legacy_fallback"),debug_character_data:h.isEnabled("debug_character_data"),object_search_service:h.isEnabled("object_search_service"),string_sanitizer_service:h.isEnabled("string_sanitizer_service"),safe_access_service:h.isEnabled("safe_access_service"),ability_constants:h.isEnabled("ability_constants"),ability_score_processor:h.isEnabled("ability_score_processor"),debug_ability_score_processor:h.isEnabled("debug_ability_score_processor"),spell_slot_calculator:h.isEnabled("spell_slot_calculator"),debug_spell_slot_calculator:h.isEnabled("debug_spell_slot_calculator"),inventory_processor:h.isEnabled("inventory_processor"),encumbrance_calculator:h.isEnabled("encumbrance_calculator"),inventory_processor_debug:h.isEnabled("inventory_processor_debug"),encumbrance_calculator_debug:h.isEnabled("encumbrance_calculator_debug"),feature_processor_debug:h.isEnabled("feature_processor_debug"),weaponlist_debug:h.isEnabled("weaponlist_debug")}}isWeapon(e){return e.definition.filterType==="Weapon"}isThrown(e){var r,s;return(((s=(r=e.definition.weaponBehaviors)==null?void 0:r[0])==null?void 0:s.properties)||[]).some(i=>i.toLowerCase().includes("thrown"))}extractWeaponData(e,t){var b;h.isEnabled("weaponlist_debug")&&console.log(" Extracting weapon data for: ".concat(e.definition.name));const r=(b=e.definition.weaponBehaviors)==null?void 0:b[0];let i=(r==null?void 0:r.properties)||[];i.length===0&&(i=this.inferWeaponProperties(e));const a=i.some(m=>m.toLowerCase().includes("range"))||i.some(m=>m.toLowerCase().includes("ranged"))||this.isRangedWeapon(e.definition.name),o=i.some(m=>m.toLowerCase().includes("thrown")),l=this.getWeaponAttackStat(e,a),c=0,u=this.extractWeaponDamage(e);let d=0;o?d=2:a&&(d=1);const f=String(e.id).padStart(5,"0"),g="....inventorylist.id-".concat(f),p={id:e.id,name:e.definition.name,properties:i.join(", "),attackBonus:c,attackStat:l,damage:u,weaponType:d,shortcut:g};return h.isEnabled("weaponlist_debug")&&console.log(" Extracted weapon data:",p),p}extractThrownWeaponData(e,t){const r=this.extractWeaponData(e,t);return r?{...r,weaponType:0}:null}getWeaponAttackStat(e,t){return t?"dexterity":"strength"}isCharacterMonk(e){return e.classes?e.classes.some(t=>{var r,s;return((s=(r=t.definition)==null?void 0:r.name)==null?void 0:s.toLowerCase())==="monk"}):!1}getMonkUnarmedStrike(e){return{id:999999,name:"Unarmed Strike",properties:"Monk, Unarmed",attackBonus:0,attackStat:"dexterity",damage:{dice:"1d4",bonus:0,type:"bludgeoning"},weaponType:0,shortcut:""}}linkAmmoToWeapons(e,t){h.isEnabled("weaponlist_debug")&&console.log(" Linking ammunition to ".concat(e.length," weapons"));const r=[];t.rootItems.forEach(s=>{this.isAmmunition(s)&&r.push(s)}),t.containers.forEach(s=>{s.contents.forEach(i=>{this.isAmmunition(i)&&r.push(i)})}),h.isEnabled("weaponlist_debug")&&console.log(" Found ".concat(r.length," ammunition items:"),r.map(s=>({name:s.definition.name,quantity:s.quantity,subType:s.definition.subType}))),e.forEach((s,i)=>{if(s.weaponType===2)s.maxAmmo=this.getThrownWeaponQuantity(s,t),h.isEnabled("weaponlist_debug")&&console.log(" Set thrown weapon ".concat(s.name," maxAmmo to ").concat(s.maxAmmo," (using item quantity)"));else{const a=this.findCompatibleAmmo(s,r);a&&(s.maxAmmo=a.quantity,h.isEnabled("weaponlist_debug")&&console.log(" Linked ".concat(s.name," to ").concat(a.definition.name," (").concat(a.quantity,")")))}})}getThrownWeaponQuantity(e,t){const r=e.id;for(const s of t.rootItems)if(s.id===r)return s.quantity;for(const[s,i]of t.containers)for(const a of i.contents)if(a.id===r)return a.quantity;return 1}isAmmunition(e){return e.definition.subType==="Ammunition"||e.definition.isConsumable&&e.definition.filterType==="Other Gear"}findCompatibleAmmo(e,t){const r=e.name.toLowerCase();for(const s of t){const i=s.definition.name.toLowerCase();if(r.includes("crossbow")&&i.includes("bolt")||r.includes("bow")&&i.includes("arrow")||r.includes("sling")&&(i.includes("bullet")||i.includes("stone"))||r.includes("blowgun")&&i.includes("needle"))return s}return null}inferWeaponProperties(e){var l;const t=[],r=((l=e.definition.name)==null?void 0:l.toLowerCase())||"";return this.isRangedWeapon(r)&&t.push("Ranged"),["greatsword","maul","pike","glaive","halberd","longbow","heavy crossbow"].some(c=>r.includes(c))&&t.push("Two-handed"),["dagger","dart","javelin","light hammer","sickle","scimitar","shortsword","handaxe"].some(c=>r.includes(c))&&t.push("Light"),["dagger","dart","rapier","scimitar","shortsword","whip"].some(c=>r.includes(c))&&t.push("Finesse"),["dart","javelin","light hammer","handaxe","spear","trident"].some(c=>r.includes(c))&&t.push("Thrown"),t}isRangedWeapon(e){return["bow","crossbow","dart","javelin","sling","blowgun"].some(r=>e.toLowerCase().includes(r))}extractWeaponDamage(e){var s,i;const t=(s=e.definition.weaponBehaviors)==null?void 0:s[0];if(t!=null&&t.damage)return{dice:t.damage.diceString||"1d6",bonus:t.damage.fixedValue||0,type:t.damage.damageTypeId?this.getDamageTypeName(t.damage.damageTypeId):"slashing"};if(e.definition.damage)return{dice:e.definition.damage.diceString||"1d6",bonus:e.definition.damage.fixedValue||0,type:e.definition.damage.damageTypeId?this.getDamageTypeName(e.definition.damage.damageTypeId):"slashing"};const r=((i=e.definition.name)==null?void 0:i.toLowerCase())||"";return r.includes("dagger")?{dice:"1d4",bonus:0,type:"piercing"}:r.includes("shortsword")?{dice:"1d6",bonus:0,type:"piercing"}:r.includes("longsword")?{dice:"1d8",bonus:0,type:"slashing"}:r.includes("greatsword")?{dice:"2d6",bonus:0,type:"slashing"}:r.includes("mace")?{dice:"1d6",bonus:0,type:"bludgeoning"}:r.includes("warhammer")?{dice:"1d8",bonus:0,type:"bludgeoning"}:{dice:"1d6",bonus:0,type:"slashing"}}getDamageTypeName(e){return{1:"bludgeoning",2:"piercing",3:"slashing",4:"necrotic",5:"acid",6:"cold",7:"fire",8:"lightning",9:"thunder",10:"poison",11:"psychic",12:"radiant",13:"force"}[e]||"slashing"}getClassNameById(e,t){var s,i;const r=(s=e.classes)==null?void 0:s.find(a=>a.id===t);return((i=r==null?void 0:r.definition)==null?void 0:i.name)||"Unknown"}extractSpellData(e,t){try{const r=e.definition;if(!r)return null;const s=this.formatSpellComponents(r.components||[]),i=this.formatCastingTime(r.activation),a=this.formatSpellRange(r.range),o=this.formatSpellDuration(r.duration),l=this.stripHTML(r.description||"");return{id:r.id,name:r.name,level:r.level,school:r.school||"Divination",source:t,prepared:e.prepared||!1,description:l,components:s,castingTime:i,range:a,duration:o,concentration:r.concentration||!1,ritual:r.ritual||!1,saveDc:e.overrideSaveDc||null,attackRoll:r.requiresAttackRoll||!1,requiresSavingThrow:r.requiresSavingThrow||!1,definition:r}}catch(r){return console.error("Failed to extract spell data:",r),null}}formatSpellComponents(e){const t=[];return e.includes(1)&&t.push("V"),e.includes(2)&&t.push("S"),e.includes(3)&&t.push("M"),t.join(", ")}formatCastingTime(e){if(!e)return"1 action";const t=e.activationTime||1,r=e.activationType,i={1:"action",2:"bonus action",3:"reaction",4:"minute",5:"hour",6:"no action"}[r]||"action";return t===1?"1 ".concat(i):"".concat(t," ").concat(i,"s")}formatSpellRange(e){return e?e.origin==="Self"?e.aoeType&&e.aoeValue?"Self (".concat(e.aoeValue,"-foot ").concat(e.aoeType.toLowerCase(),")"):"Self":e.rangeValue?"".concat(e.rangeValue," feet"):e.origin||"Touch":"Touch"}formatSpellDuration(e){var a;if(!e)return"Instantaneous";const t=e.durationInterval||1,r=((a=e.durationUnit)==null?void 0:a.toLowerCase())||"round",s=e.durationType;let i=t===1?"1 ".concat(r):"".concat(t," ").concat(r,"s");return s==="Concentration"&&(i="Concentration, up to ".concat(i)),i}stripHTML(e){return e.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").trim()}generateSpellActions(e){let t="",r=1;if(e.powerType==="feature")t+=this.generateFeatureAction(e,r);else{if(t+="          <id-".concat(String(r).padStart(5,"0"),'>\n            <order type="number">').concat(r,'</order>\n            <type type="string">cast</type>'),e.requiresSavingThrow||e.saveDc){t+='\n            <savemagic type="number">1</savemagic>';const o=this.determineSaveType(e);o&&(t+='\n            <savetype type="string">'.concat(o,"</savetype>"))}t+="\n          </id-".concat(String(r).padStart(5,"0"),">\n"),r++;const i=this.extractSpellDamageInfo(e);i&&(t+="          <id-".concat(String(r).padStart(5,"0"),'>\n            <damagelist>\n              <id-00001>\n                <bonus type="number">').concat(i.bonus,'</bonus>\n                <dice type="dice">').concat(i.dice,'</dice>\n                <type type="string">').concat(i.type,'</type>\n              </id-00001>\n            </damagelist>\n            <order type="number">').concat(r,'</order>\n            <type type="string">damage</type>\n          </id-').concat(String(r).padStart(5,"0"),">\n"),r++);const a=this.extractSpellHealingInfo(e);a&&(t+="          <id-".concat(String(r).padStart(5,"0"),'>\n            <order type="number">').concat(r,'</order>\n            <type type="string">heal</type>\n            <heallist>\n              <id-00001>\n                <bonus type="number">').concat(a.bonus,'</bonus>\n                <dice type="dice">').concat(a.dice,"</dice>\n              </id-00001>\n            </heallist>\n          </id-").concat(String(r).padStart(5,"0"),">\n"),r++)}return t}generateFeatureAction(e,t){var a,o;const r=((a=e.name)==null?void 0:a.toLowerCase())||"";let s="          <id-".concat(String(t).padStart(5,"0"),">");if(e.duration&&e.duration!=="Instantaneous"&&e.duration.includes("minute")){const l=((o=e.duration.match(/(\d+)/))==null?void 0:o[1])||"1";s+='\n            <durmod type="number">'.concat(l,'</durmod>\n            <durunit type="string">minute</durunit>')}let i="";return r.includes("rage")?i="Rage; ADVCHK: strength; ADVSAV: strength; DMG: 2, melee; RESIST: bludgeoning, piercing, slashing":r.includes("stone's endurance")?i="Stone's Endurance; Reduce damage by 1d12 + CON modifier":i=e.name,s+='\n            <label type="string">'.concat(i,'</label>\n            <order type="number">').concat(t,'</order>\n            <targeting type="string">self</targeting>\n            <type type="string">effect</type>\n          </id-').concat(String(t).padStart(5,"0"),">\n"),s}determineSaveType(e){var r,s;const t=((r=e.description)==null?void 0:r.toLowerCase())||"";return t.includes("dexterity saving throw")?"dexterity":t.includes("constitution saving throw")?"constitution":t.includes("wisdom saving throw")?"wisdom":t.includes("intelligence saving throw")?"intelligence":t.includes("charisma saving throw")?"charisma":t.includes("strength saving throw")?"strength":(s=e.definition)!=null&&s.saveDcAbilityId&&{1:"strength",2:"dexterity",3:"constitution",4:"intelligence",5:"wisdom",6:"charisma"}[e.definition.saveDcAbilityId]||null}extractSpellDamageInfo(e){var i,a;const t=((i=e.description)==null?void 0:i.toLowerCase())||"",r=/(\d+d\d+).*?(acid|cold|fire|lightning|thunder|poison|psychic|radiant|necrotic|force|bludgeoning|piercing|slashing)/i,s=t.match(r);return s?{dice:this.formatDiceForFantasyGrounds(s[1]),bonus:0,type:s[2].toLowerCase()}:(a=e.definition)!=null&&a.damage?{dice:this.formatDiceForFantasyGrounds(e.definition.damage.diceString||"1d6"),bonus:e.definition.damage.fixedValue||0,type:this.getDamageTypeName(e.definition.damage.damageTypeId)||"force"}:null}extractSpellHealingInfo(e){var a,o;const t=((a=e.description)==null?void 0:a.toLowerCase())||"",r=/(\d+d\d+).*?hit points/i,s=t.match(r);if(s)return{dice:this.formatDiceForFantasyGrounds(s[1]),bonus:0};const i=((o=e.name)==null?void 0:o.toLowerCase())||"";return i.includes("cure")||i.includes("heal")||i.includes("vitality")?{dice:this.formatDiceForFantasyGrounds("1d8"),bonus:0}:null}formatDiceForFantasyGrounds(e){return e.replace(/^1d/,"d")}extractActivePowers(e){var r,s,i,a,o;const t=[];return h.isEnabled("spelllist_debug")&&(console.log(" Extracting active class features and racial traits as powers"),console.log(" Character classes:",((r=e.classes)==null?void 0:r.length)||0),console.log(" Character race:",(s=e.race)==null?void 0:s.fullName)),(i=e.classes)==null||i.forEach(l=>{var u,d,f,g;const c=((u=l.definition)==null?void 0:u.name)||"Unknown";h.isEnabled("spelllist_debug")&&console.log(" Checking ".concat(c,": ").concat(((d=l.classFeatures)==null?void 0:d.length)||0," class features")),(f=l.classFeatures)==null||f.forEach(p=>{var b,m,y,w;if(h.isEnabled("spelllist_debug")&&(console.log(" Checking class feature: ".concat((b=p.definition)==null?void 0:b.name," - isActivePower: ").concat(this.isActivePower(p))),(y=(m=p.definition)==null?void 0:m.name)!=null&&y.toLowerCase().includes("rage")&&(console.log(" Raw Rage feature data:",p),console.log(" Rage feature.levelScales:",p.levelScales))),this.isActivePower(p)){const _=this.extractFeaturePowerData(p,c,e);_?(t.push(_),h.isEnabled("spelllist_debug")&&console.log(" Added ".concat(c," feature: ").concat(_.name))):h.isEnabled("spelllist_debug")&&console.log(" Failed to extract power data for: ".concat((w=p.definition)==null?void 0:w.name))}}),(g=l.subclassFeatures)==null||g.forEach(p=>{var b;if(this.isActivePower(p)){const m=((b=p.definition)==null?void 0:b.name)||c,y=this.extractFeaturePowerData(p,"".concat(c," (").concat(m,")"),e);y&&(t.push(y),h.isEnabled("spelllist_debug")&&console.log(" Added ".concat(c," subclass feature: ").concat(y.name)))}})}),(o=(a=e.race)==null?void 0:a.racialTraits)==null||o.forEach(l=>{var c;if(this.isActivePower(l)){const u=this.extractFeaturePowerData(l,"".concat(((c=e.race)==null?void 0:c.fullName)||"Racial"," Traits"),e);u&&(t.push(u),h.isEnabled("spelllist_debug")&&console.log(" Added racial trait: ".concat(u.name)))}}),t}isActivePower(e){var s;if(!(e!=null&&e.definition))return!1;if(e.limitedUse)return!0;const t=((s=e.definition.name)==null?void 0:s.toLowerCase())||"";return["rage","reckless attack","stone's endurance","form of the beast","action surge","second wind","bardic inspiration","channel divinity","wild shape","lay on hands","divine smite","sneak attack"].some(i=>t.includes(i))}extractFeaturePowerData(e,t,r){var s,i,a;try{const o=e.definition;if(!o)return null;const l=this.stripHTML(o.description||"");let c=0,u="long rest",d="action";return e.limitedUse&&(c=e.limitedUse.maxUses||1,u=e.limitedUse.resetType===1?"short rest":"long rest",e.limitedUse.actionType===3&&(d=this.determineActionTypeFromDescription(l)),h.isEnabled("spelllist_debug")&&((s=o.name)!=null&&s.toLowerCase().includes("rage"))&&console.log(" Rage limitedUse data:",e.limitedUse)),c=this.calculateScaledFeatureUses(e,r,c),h.isEnabled("spelllist_debug")&&((i=o.name)!=null&&i.toLowerCase().includes("rage"))&&console.log(" Final Rage debug:",{featureName:o.name,characterLevel:this.getCharacterLevelForFeature(e,r),originalMaxUses:((a=e.limitedUse)==null?void 0:a.maxUses)||0,finalUsesMax:c,hasLevelScales:!!e.levelScales,levelScalesData:e.levelScales}),{id:o.id,name:o.name,level:0,school:"",source:t,prepared:c,description:l,components:"",castingTime:d,range:this.determineRangeFromDescription(l),duration:this.determineDurationFromDescription(l),concentration:!1,ritual:!1,group:t,powerType:"feature",resetType:u,definition:o}}catch(o){return console.error("Failed to extract feature power data:",o),null}}determineActionTypeFromDescription(e){const t=e.toLowerCase();return t.includes("bonus action")?"bonus action":t.includes("reaction")?"reaction":t.includes("no action")?"no action":"action"}determineRangeFromDescription(e){const t=e.toLowerCase();if(t.includes("self")||t.includes("yourself"))return"Self";if(t.includes("touch"))return"Touch";const r=/(\d+)\s*feet/i,s=t.match(r);return s?"".concat(s[1]," feet"):"Self"}determineDurationFromDescription(e){const t=e.toLowerCase();return t.includes("1 minute")?"1 minute":t.includes("10 minutes")?"10 minutes":t.includes("1 hour")?"1 hour":t.includes("until")?"Until condition met":(t.includes("instantaneous"),"Instantaneous")}calculateScaledFeatureUses(e,t,r){var u,d,f;const s=this.getCharacterLevelForFeature(e,t),i=this.findClassFeatureLevelScales(e,t);if(!i||!Array.isArray(i))return h.isEnabled("spelllist_debug")&&console.log(" No level scales found for ".concat((u=e.definition)==null?void 0:u.name,", using default: ").concat(r)),r;h.isEnabled("spelllist_debug")&&(console.log(" Calculating scaled uses for ".concat((d=e.definition)==null?void 0:d.name,": character level ").concat(s)),console.log(" Level scales available:",i));const a=i.filter(g=>g.description&&!g.description.toLowerCase().includes("damage")&&!g.description.toLowerCase().includes("+")),o=a.length>0?a:i;h.isEnabled("spelllist_debug")&&a.length>0&&console.log(" Found ".concat(a.length," usage-specific level scales (filtering out damage scaling)"));const l=o.sort((g,p)=>g.level-p.level);let c=r;for(const g of l)s>=g.level&&g.fixedValue!==void 0&&g.fixedValue!==null?(c=g.fixedValue,h.isEnabled("spelllist_debug")&&console.log(" Applied level scale at level ".concat(g.level,": ").concat(c," uses (").concat(g.description||"no description",")"))):h.isEnabled("spelllist_debug")&&(s<g.level?console.log(" Skipping level ".concat(g.level," (character level ").concat(s," too low)")):(g.fixedValue===void 0||g.fixedValue===null)&&console.log(" Skipping level ".concat(g.level," (no fixedValue: ").concat(g.fixedValue,")")));return h.isEnabled("spelllist_debug")&&console.log(" Final scaled uses for ".concat((f=e.definition)==null?void 0:f.name,": ").concat(c)),c}findClassFeatureLevelScales(e,t){var r,s,i,a,o,l,c,u,d,f,g,p,b,m,y;if(!((r=e.definition)!=null&&r.id))return null;for(const w of t.classes||[]){const _=(s=w.classFeatures)==null?void 0:s.some(v=>{var x;return((x=v.definition)==null?void 0:x.id)===e.definition.id}),S=(i=w.subclassFeatures)==null?void 0:i.some(v=>{var x;return((x=v.definition)==null?void 0:x.id)===e.definition.id});if(_||S){h.isEnabled("spelllist_debug")&&console.log(" Found class ".concat((a=w.definition)==null?void 0:a.name," containing feature ").concat(e.definition.name));for(const v of w.classFeatures||[])if(((o=v.definition)==null?void 0:o.id)===e.definition.id){if(h.isEnabled("spelllist_debug")&&console.log(" Examining class feature ".concat((l=v.definition)==null?void 0:l.name,":"),{hasLevelScales:!!v.levelScales,levelScalesLength:((c=v.levelScales)==null?void 0:c.length)||0,levelScales:v.levelScales,hasDefinitionLevelScales:!!((u=v.definition)!=null&&u.levelScales),definitionLevelScales:(d=v.definition)==null?void 0:d.levelScales}),v.levelScales&&v.levelScales.length>0)return v.levelScales;if((f=v.definition)!=null&&f.levelScales&&v.definition.levelScales.length>0)return v.definition.levelScales}for(const v of w.subclassFeatures||[])if(((g=v.definition)==null?void 0:g.id)===e.definition.id){if(h.isEnabled("spelllist_debug")&&console.log(" Examining subclass feature ".concat((p=v.definition)==null?void 0:p.name,":"),{hasLevelScales:!!v.levelScales,levelScales:v.levelScales,hasDefinitionLevelScales:!!((b=v.definition)!=null&&b.levelScales),definitionLevelScales:(m=v.definition)==null?void 0:m.levelScales}),v.levelScales&&v.levelScales.length>0)return v.levelScales;if((y=v.definition)!=null&&y.levelScales&&v.definition.levelScales.length>0)return v.definition.levelScales}return h.isEnabled("spelllist_debug")&&console.log(" Found class for ".concat(e.definition.name," but no levelScales found anywhere")),null}}return h.isEnabled("spelllist_debug")&&console.log(" Could not find class containing feature ".concat(e.definition.name)),null}getCharacterLevelForFeature(e,t){var r,s,i;for(const a of t.classes||[])if((r=a.classFeatures)!=null&&r.some(o=>{var l,c;return((l=o.definition)==null?void 0:l.id)===((c=e.definition)==null?void 0:c.id)})||(s=a.subclassFeatures)!=null&&s.some(o=>{var l,c;return((l=o.definition)==null?void 0:l.id)===((c=e.definition)==null?void 0:c.id)}))return a.level||1;return((i=t.classes)==null?void 0:i.reduce((a,o)=>a+(o.level||0),0))||1}calculateHP(e){const t=e.baseHitPoints||0,r=this.calculateTotalLevel(e),s=this.getConstitutionModifier(e);return t+s*r}calculateAC(e){var a,o,l;console.log(" Calculating AC for character:",e.name);const t=((a=e.classes)==null?void 0:a.map(c=>{var u;return(u=c.definition)==null?void 0:u.name}))||[];console.log(" Character classes:",t);const r=(o=e.classes)==null?void 0:o.some(c=>{var u,d;return((d=(u=c.definition)==null?void 0:u.name)==null?void 0:d.toLowerCase())==="barbarian"}),s=(l=e.classes)==null?void 0:l.some(c=>{var u,d;return((d=(u=c.definition)==null?void 0:u.name)==null?void 0:d.toLowerCase())==="monk"});if(console.log(" Unarmored Defense checks:",{barbarian:r,monk:s}),r)try{const c=this.getAbilityScores(e);console.log(" Barbarian ability scores:",c);const u=Math.floor((c.dexterity-10)/2),d=Math.floor((c.constitution-10)/2),f=10+u+d;return console.log(" Barbarian Unarmored Defense: 10 + ".concat(u," (DEX) + ").concat(d," (CON) = ").concat(f)),f}catch(c){console.error("Error calculating Barbarian Unarmored Defense AC:",c)}if(s)try{const c=this.getAbilityScores(e);console.log(" Monk ability scores:",c);const u=Math.floor((c.dexterity-10)/2),d=Math.floor((c.wisdom-10)/2),f=10+u+d;return console.log(" Monk Unarmored Defense: 10 + ".concat(u," (DEX) + ").concat(d," (WIS) = ").concat(f)),f}catch(c){console.error("Error calculating Monk Unarmored Defense AC:",c)}const i=e.armorClass||I.getBaseArmorClass();return console.log(" Using fallback AC:",i,"(from characterData.armorClass:",e.armorClass,")"),i}getConstitutionModifier(e){try{const t=this.getAbilityScores(e);return Math.floor((t.constitution-10)/2)}catch(t){return console.error("Error calculating Constitution modifier:",t),0}}generateACComponents(e){var o,l;console.log(" Generating AC components for Fantasy Grounds");const t=(o=e.classes)==null?void 0:o.some(c=>{var u,d;return((d=(u=c.definition)==null?void 0:u.name)==null?void 0:d.toLowerCase())==="barbarian"}),r=(l=e.classes)==null?void 0:l.some(c=>{var u,d;return((d=(u=c.definition)==null?void 0:u.name)==null?void 0:d.toLowerCase())==="monk"}),s=this.getAbilityScores(e),i=Math.floor((s.dexterity-10)/2);if(t){const c=Math.floor((s.constitution-10)/2),u=10+i+c;return console.log(" Barbarian Unarmored Defense: 10 + DEX ".concat(i," + CON ").concat(c," = ").concat(u)),console.log(" Using Fantasy Grounds format: armor=0, stat2=constitution, total="+u),'\n        <armor type="number">0</armor>\n        <disstealth type="number">0</disstealth>\n        <misc type="number">0</misc>\n        <prof type="number">0</prof>\n        <shield type="number">0</shield>\n        <stat2 type="string">constitution</stat2>\n        <temporary type="number">0</temporary>\n        <total type="number">'.concat(u,"</total>")}if(r){const c=Math.floor((s.wisdom-10)/2),u=10+i+c;return console.log(" Monk AC Components: Base 10 + DEX ".concat(i," + WIS ").concat(c," = ").concat(u)),'\n        <armor type="number">10</armor>\n        <misc type="number">'.concat(c,'</misc>\n        <prof type="number">0</prof>\n        <shield type="number">0</shield>\n        <stat type="number">').concat(i,'</stat>\n        <stat2 type="string">dexterity</stat2>\n        <temporary type="number">0</temporary>\n        <total type="number">').concat(u,"</total>")}const a=e.armorClass||I.getBaseArmorClass();return console.log(" Standard AC Components, total:",a),'\n        <armor type="number">'.concat(Math.max(0,a-i),'</armor>\n        <misc type="number">0</misc>\n        <prof type="number">0</prof>\n        <shield type="number">0</shield>\n        <stat type="number">').concat(i,'</stat>\n        <stat2 type="string">dexterity</stat2>\n        <temporary type="number">0</temporary>\n        <total type="number">').concat(a,"</total>")}}const Ir=new kr,ua=Object.freeze(Object.defineProperty({__proto__:null,CharacterConverterFacade:kr,characterConverterFacade:Ir},Symbol.toStringTag,{value:"Module"}));C.store("conversionResults",{result:null,filename:"",characterName:"",convertedAt:null,get hasResult(){return this.result!==null&&this.result.trim().length>0},get resultSize(){if(!this.result)return"0 KB";const n=new Blob([this.result]).size,e=Math.round(n/1024*100)/100;return"".concat(e," KB")},setResult(n,e="Unknown Character",t){this.result=n,this.characterName=e,this.convertedAt=new Date;const r=e.replace(/[^a-zA-Z0-9_-]/g,"_");t?this.filename="".concat(r,"_").concat(t,".xml"):this.filename="".concat(r,"_character.xml"),console.log("Conversion result set:",{characterName:e,characterId:t,filename:this.filename,size:this.resultSize})},clearResult(){this.result=null,this.filename="",this.characterName="",this.convertedAt=null,console.log("Conversion result cleared")},downloadXML(){if(!this.hasResult)return console.warn("No conversion result to download"),!1;try{const n=new Blob([this.result],{type:"application/xml"}),e=URL.createObjectURL(n),t=document.createElement("a");return t.href=e,t.download=this.filename||"character.xml",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e),console.log("XML file downloaded:",this.filename),!0}catch(n){return console.error("Failed to download XML:",n),!1}}});C.store("notifications",{items:[],get hasNotifications(){return this.items.length>0},add(n,e,t=!0){const r={id:Math.random().toString(36).substr(2,9),message:n,type:e,timestamp:new Date,autoDismiss:t};if(this.items.push(r),console.log("Notification added:",r),t){const s=e==="error"?0:e==="warning"?8e3:5e3;s>0&&setTimeout(()=>{this.remove(r.id)},s)}return r},addSuccess(n,e=!0){return this.add(n,"success",e)},addError(n,e=!1){return this.add(n,"error",e)},addWarning(n,e=!0){return this.add(n,"warning",e)},addInfo(n,e=!0){return this.add(n,"info",e)},remove(n){const e=this.items.findIndex(t=>t.id===n);e!==-1&&(this.items.splice(e,1),console.log("Notification removed:",n))},clear(){this.items=[],console.log("All notifications cleared")}});C.data("characterConverter",()=>({characterId:"",fgVersion:"unity",isConverting:!1,progress:0,currentStep:"",isValidId:!0,showCharacterPreview:h.isEnabled("character_preview"),showPerformanceMetrics:h.isEnabled("performance_metrics"),enableBulkConversion:h.isEnabled("bulk_conversion"),init(){window.addEventListener("featureFlagsChanged",()=>{this.updateFeatureFlags()}),window.addEventListener("characterDataLoaded",n=>{if(n.detail&&n.detail.characterData&&n.detail.xml){console.log(" Character loaded from file, updating converter state"),this.characterId="file_".concat(n.detail.characterData.id||Date.now()),this.isValidId=!0,this.isConverting=!1,this.progress=100,this.currentStep="File conversion complete!";const e=C.store("conversionResults"),t=n.detail.characterData.id||"unknown";e.setResult(n.detail.xml,n.detail.characterName||n.detail.characterData.name,t),console.log(" Basic converter state updated after file upload:",{characterId:this.characterId,hasResult:e.hasResult})}})},validateCharacterId(){const n=this.characterId.trim();if(!n){this.isValidId=!0;return}const e=/(?:dndbeyond\.com\/characters\/|\/characters\/)(\d+)/i,t=n.match(e);if(t&&t[1]){this.characterId=t[1],this.isValidId=!0;return}const r=/^\d+$/;this.isValidId=r.test(n),this.isValidId||C.store("notifications").addError("Please enter a valid character ID or D&D Beyond character URL")},async convertCharacter(){var e,t,r,s;if(!this.characterId.trim()){C.store("notifications").addError("Please enter a character ID");return}if(this.validateCharacterId(),!this.isValidId)return;C.store("conversionResults").clearResult(),this.isConverting=!0,this.progress=0,this.currentStep="Initializing...";try{this.currentStep="Validating character ID...",this.progress=10,await this.delay(200);const i=this.characterId.trim();console.log("Converting character:",i),((e=window.featureFlags)==null?void 0:e.isEnabled("debug_character_data"))&&console.log(" Debug mode enabled - detailed character data will be logged");const o=window.characterConverterFacade;if(!o)throw new Error("CharacterConverterFacade not available");o.onProgress=(m,y)=>{this.currentStep=m,this.progress=y};const l=await o.convertFromDNDBeyond(i);if(!l.success)throw new Error(l.error||"Conversion failed");this.currentStep="Complete!",this.progress=100;const c=((t=l.characterData)==null?void 0:t.name)||"Unknown Character",u=((r=l.characterData)==null?void 0:r.id)||this.characterId;C.store("conversionResults").setResult(l.xml,c,u);const f=new CustomEvent("characterDataLoaded",{detail:{characterData:l.characterData,xml:l.xml,characterName:c}});document.dispatchEvent(f);const g=C.store("notifications"),p=(s=window.featureFlags)==null?void 0:s.isEnabled("debug_character_data");this.validateWarlockPactMagic(l,g);const b=p?'Character "'.concat(c,'" converted successfully! Check console for detailed data.'):'Character "'.concat(c,'" converted successfully!');g.addSuccess(b)}catch(i){console.error("Conversion error:",i);const a=i instanceof Error?i.message:"Unknown error occurred";C.store("notifications").addError("Conversion failed: ".concat(a)),this.currentStep="Error occurred",this.progress=0}finally{this.isConverting=!1}},resetForm(){this.characterId="",this.fgVersion="unity",this.isConverting=!1,this.progress=0,this.currentStep="",this.isValidId=!0,C.store("conversionResults").clearResult(),C.store("notifications").clear(),console.log("Character converter form reset")},downloadResult(){const e=C.store("conversionResults").downloadXML(),t=C.store("notifications");e?t.addSuccess("XML file downloaded successfully!"):t.addError("Failed to download XML file")},updateFeatureFlags(){this.showCharacterPreview=h.isEnabled("character_preview"),this.showPerformanceMetrics=h.isEnabled("performance_metrics"),this.enableBulkConversion=h.isEnabled("bulk_conversion")},delay(n){return new Promise(e=>setTimeout(e,n))},validateWarlockPactMagic(n,e){if(!n.success||!n.characterData||!n.xml)return;const r=(n.characterData.classes||[]).find(f=>{var g,p;return((p=(g=f.definition)==null?void 0:g.name)==null?void 0:p.toLowerCase())==="warlock"});if(!r)return;const s=r.level,i=n.characterData.name||"Unknown",a=n.xml;let o={};s>=17?o={level5:4}:s>=15?o={level5:3}:s>=11?o={level5:2}:s>=9?o={level5:2}:s>=7?o={level4:2}:s>=5?o={level3:2}:s>=3?o={level2:2}:s>=2?o={level1:2}:s>=1&&(o={level1:1});const l=/<pactmagicslots(\d+)><max type="number">(\d+)<\/max>/g,c=[...a.matchAll(l)];let u=[],d=!1;if(c.length>0)if(c.forEach(f=>{const g=f[1],p=f[2];if(p!=="0"){u.push("L".concat(g,": ").concat(p));const b="level".concat(g);o[b]&&parseInt(p)===o[b]&&(d=!0)}}),d)e.addInfo(" Warlock validated: Level ".concat(s," ").concat(i," correctly has pact magic slots (").concat(u.join(", "),")"));else{const f=Object.entries(o).map(([g,p])=>"L".concat(g.replace("level",""),": ").concat(p)).join(", ");e.addWarning(" Warlock issue: Level ".concat(s," ").concat(i," has unexpected pact magic slots. Found: ").concat(u.join(", "),", Expected: ").concat(f))}else{const f=/<spellslots(\d+)><max type="number">(\d+)<\/max>/g,p=[...a.matchAll(f)].filter(b=>b[2]!=="0").map(b=>"L".concat(b[1],": ").concat(b[2]));p.length>0?e.addError(" Warlock error: Level ".concat(s," ").concat(i," has regular spell slots instead of pact magic (").concat(p.join(", "),")")):e.addError(" Warlock error: Level ".concat(s," ").concat(i," has no spell slots generated"))}},showFormatSelector(){window.dispatchEvent(new CustomEvent("showFormatSelector"))}}));C.data("enhancedCharacterConverter",()=>({characterId:"",fgVersion:"unity",isConverting:!1,progress:0,currentStep:"",characterData:null,isValidId:!0,showCharacterPreview:h.isEnabled("character_preview"),showPerformanceMetrics:h.isEnabled("performance_metrics"),enableBulkConversion:h.isEnabled("bulk_conversion"),enableMultiFormat:h.isEnabled("multi_format_export"),showFormatSelection:!1,formatSelectionAnalyzed:!1,init(){window.addEventListener("featureFlagsChanged",()=>{this.updateFeatureFlags()}),window.addEventListener("characterDataLoaded",n=>{if(n.detail&&n.detail.characterData&&(console.log(" Enhanced converter: Character data loaded"),this.onCharacterDataLoaded(n.detail.characterData),n.detail.xml)){this.characterId="file_".concat(n.detail.characterData.id||Date.now()),this.isValidId=!0,this.isConverting=!1,this.progress=100,this.currentStep="File conversion complete!",this.characterData=n.detail.characterData;const e=C.store("conversionResults"),t=n.detail.characterData.id||"unknown";e.setResult(n.detail.xml,n.detail.characterName||n.detail.characterData.name,t),this.enableMultiFormat&&setTimeout(()=>{this.triggerFormatAnalysis()},100),console.log(" Enhanced converter state updated after file upload:",{characterId:this.characterId,hasCharacterData:!!this.characterData,hasResult:e.hasResult,enableMultiFormat:this.enableMultiFormat})}}),console.log(" Enhanced Character Converter initialized"),console.log("Multi-format support:",this.enableMultiFormat?"enabled":"disabled")},validateCharacterId(){const n=this.characterId.trim();if(!n){this.isValidId=!0;return}const e=/(?:dndbeyond\.com\/characters\/|\/characters\/)(\d+)/i,t=n.match(e);if(t&&t[1]){this.characterId=t[1],this.isValidId=!0;return}const r=/^\d+$/,s=/^file_/;this.isValidId=r.test(n)||s.test(n),this.isValidId||C.store("notifications").addError("Please enter a valid character ID or D&D Beyond character URL")},async convertCharacter(){var t,r,s,i;if(!this.characterId.trim()){C.store("notifications").addError("Please enter a character ID");return}if(this.validateCharacterId(),!this.isValidId)return;const n=this.characterId.trim();if(n.startsWith("file_")){C.store("notifications").addInfo("Character from file is already converted! Use the download button or choose export formats.");return}const e=C.store("conversionResults");e.clearResult(),this.isConverting=!0,this.progress=0,this.currentStep="Initializing...";try{this.currentStep="Validating character ID...",this.progress=10,await this.delay(200),console.log("Converting character:",n),((t=window.featureFlags)==null?void 0:t.isEnabled("debug_character_data"))&&console.log(" Debug mode enabled - detailed character data will be logged");const o=window.characterConverterFacade;if(!o)throw new Error("CharacterConverterFacade not available");o.onProgress=(p,b)=>{this.currentStep=p,this.progress=b};const l=await o.convertFromDNDBeyond(n);if(!l.success)throw new Error(l.error||"Conversion failed");this.characterData=l.characterData,this.onCharacterDataLoaded(l.characterData),this.currentStep="Complete!",this.progress=100;const c=((r=l.characterData)==null?void 0:r.name)||"Unknown Character",u=((s=l.characterData)==null?void 0:s.id)||this.characterId;e.setResult(l.xml,c,u);const d=C.store("notifications"),f=(i=window.featureFlags)==null?void 0:i.isEnabled("debug_character_data");this.validateWarlockPactMagic(l,d);const g=f?'Character "'.concat(c,'" converted successfully! Check console for detailed data.'):'Character "'.concat(c,'" converted successfully!');d.addSuccess(g),this.enableMultiFormat&&await this.triggerFormatAnalysis()}catch(a){console.error("Conversion error:",a);const o=a instanceof Error?a.message:"Unknown error occurred";C.store("notifications").addError("Conversion failed: ".concat(o)),this.currentStep="Error occurred",this.progress=0}finally{this.isConverting=!1}},async triggerFormatAnalysis(){if(!(!this.characterData||!this.enableMultiFormat))try{console.log(" Triggering format compatibility analysis...");const n=new CustomEvent("characterDataLoaded",{detail:{characterData:this.characterData}});window.dispatchEvent(n),await this.delay(500),this.formatSelectionAnalyzed=!0,C.store("notifications").addInfo("Format compatibility analysis complete. You can now export to multiple formats.")}catch(n){console.error("Format analysis failed:",n)}},showFormatSelector(){var n;if(!this.enableMultiFormat){C.store("notifications").addInfo("Multi-format export is not enabled. Please enable the feature flag to access format selection.");return}if(!this.characterData){C.store("notifications").addError("Please convert a character first before selecting export formats.");return}window.dispatchEvent(new CustomEvent("showFormatSelector")),window.dispatchEvent(new CustomEvent("characterDataLoaded",{detail:{characterData:this.characterData}})),console.log(" Simple format selector triggered with character data:",(n=this.characterData)==null?void 0:n.name)},hideFormatSelector(){this.showFormatSelection=!1,console.log(" Format selector closed")},onCharacterDataLoaded(n){var e,t;console.log(" Character data loaded for format analysis:",{name:n.name,level:this.calculateTotalLevel(n),classes:((e=n.classes)==null?void 0:e.length)||0,race:(t=n.race)==null?void 0:t.fullName})},resetForm(){this.characterId="",this.fgVersion="unity",this.isConverting=!1,this.progress=0,this.currentStep="",this.isValidId=!0,this.characterData=null,this.showFormatSelection=!1,this.formatSelectionAnalyzed=!1,C.store("conversionResults").clearResult(),C.store("notifications").clear();const t=document.querySelector('[x-data*="formatSelector"]');t&&t.formatSelector&&t.formatSelector.reset(),console.log(" Enhanced character converter form reset")},downloadResult(){const e=C.store("conversionResults").downloadXML(),t=C.store("notifications");e?t.addSuccess("Fantasy Grounds XML file downloaded successfully!"):t.addError("Failed to download Fantasy Grounds XML file")},updateFeatureFlags(){this.showCharacterPreview=h.isEnabled("character_preview"),this.showPerformanceMetrics=h.isEnabled("performance_metrics"),this.enableBulkConversion=h.isEnabled("bulk_conversion"),this.enableMultiFormat=h.isEnabled("multi_format_export"),console.log(" Feature flags updated:",{characterPreview:this.showCharacterPreview,performanceMetrics:this.showPerformanceMetrics,bulkConversion:this.enableBulkConversion,multiFormat:this.enableMultiFormat})},delay(n){return new Promise(e=>setTimeout(e,n))},calculateTotalLevel(n){return(n.classes||[]).reduce((t,r)=>t+(r.level||0),0)},validateWarlockPactMagic(n,e){if(!n.success||!n.characterData||!n.xml)return;const r=(n.characterData.classes||[]).find(f=>{var g,p;return((p=(g=f.definition)==null?void 0:g.name)==null?void 0:p.toLowerCase())==="warlock"});if(!r)return;const s=r.level,i=n.characterData.name||"Unknown",a=n.xml;let o={};s>=17?o={level5:4}:s>=15?o={level5:3}:s>=11?o={level5:2}:s>=9?o={level5:2}:s>=7?o={level4:2}:s>=5?o={level3:2}:s>=3?o={level2:2}:s>=2?o={level1:2}:s>=1&&(o={level1:1});const l=/<pactmagicslots(\d+)><max type="number">(\d+)<\/max>/g,c=[...a.matchAll(l)];let u=[],d=!1;if(c.length>0)if(c.forEach(f=>{const g=f[1],p=f[2];if(p!=="0"){u.push("L".concat(g,": ").concat(p));const b="level".concat(g);o[b]&&parseInt(p)===o[b]&&(d=!0)}}),d)e.addInfo(" Warlock validated: Level ".concat(s," ").concat(i," correctly has pact magic slots (").concat(u.join(", "),")"));else{const f=Object.entries(o).map(([g,p])=>"L".concat(g.replace("level",""),": ").concat(p)).join(", ");e.addWarning(" Warlock issue: Level ".concat(s," ").concat(i," has unexpected pact magic slots. Found: ").concat(u.join(", "),", Expected: ").concat(f))}else{const f=/<spellslots(\d+)><max type="number">(\d+)<\/max>/g,p=[...a.matchAll(f)].filter(b=>b[2]!=="0").map(b=>"L".concat(b[1],": ").concat(b[2]));p.length>0?e.addError(" Warlock error: Level ".concat(s," ").concat(i," has regular spell slots instead of pact magic (").concat(p.join(", "),")")):e.addError(" Warlock error: Level ".concat(s," ").concat(i," has no spell slots generated"))}}}));C.data("modernizationStatus",()=>({showStatus:!1,features:[{name:"Build System",status:"completed",description:"TypeScript + Vite + Tailwind CSS"},{name:"Feature Flags",status:"completed",description:"Runtime feature toggles with admin panel"},{name:"Alpine.js Framework",status:"completed",description:"Modern reactive UI components"},{name:"Character Converter",status:"in_progress",description:"Modern replacement for legacy converter"},{name:"Dependency Injection",status:"completed",description:"Decoupled service architecture with IoC container"},{name:"Character Parser",status:"completed",description:"Modernized parsing with services and level scaling"},{name:"Error Handling",status:"completed",description:"Comprehensive error management and validation"},{name:"Performance Metrics",status:"completed",description:"Conversion performance tracking and optimization"}],getOverallProgress(){const n=this.features.filter(s=>s.status==="completed").length,e=this.features.filter(s=>s.status==="in_progress").length,t=n+e*.5;return Math.round(t/this.features.length*100)},getStatusColor(n){switch(n){case"completed":return"text-green-400";case"in_progress":return"text-yellow-400";case"pending":return"text-red-400";default:return"text-gray-400"}},getStatusIcon(n){switch(n){case"completed":return"fas fa-check";case"in_progress":return"fas fa-clock";case"pending":return"fas fa-times";default:return"fas fa-question"}}}));document.addEventListener("keydown",n=>{if(n.ctrlKey&&n.shiftKey&&n.key==="M"){n.preventDefault();const e=document.querySelector('[x-data*="modernizationStatus"]');if(e){const t=C.$data(e);t.showStatus=!t.showStatus}}});C.data("featureFlagAdmin",()=>({flags:{},overrides:{},showAdmin:!1,init(){this.refreshFlags(),document.addEventListener("keydown",n=>{n.ctrlKey&&n.shiftKey&&n.key==="F"&&(n.preventDefault(),this.showAdmin=!this.showAdmin)})},toggleFlag(n){const e=this.getFlagStatus(n);e==="overridden"?h.clearOverride(n):e==="enabled"?h.disable(n):h.enable(n),this.refreshFlags(),window.dispatchEvent(new CustomEvent("featureFlagsChanged",{detail:{flagKey:n,newStatus:this.getFlagStatus(n)}}))},clearOverride(n){h.clearOverride(n),this.refreshFlags(),window.dispatchEvent(new CustomEvent("featureFlagsChanged",{detail:{flagKey:n,newStatus:this.getFlagStatus(n)}}))},clearAllOverrides(){h.clearAllOverrides(),this.refreshFlags(),window.dispatchEvent(new CustomEvent("featureFlagsChanged",{detail:{action:"clearAll"}}))},refreshFlags(){this.flags=h.getAllFlags(),this.overrides=h.getOverrides()},getFlagStatus(n){return this.overrides.hasOwnProperty(n)?"overridden":h.isEnabled(n)?"enabled":"disabled"},getFlagDisplayClass(n){const e=this.getFlagStatus(n),t="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium";switch(e){case"enabled":return"".concat(t," bg-green-800 text-green-200");case"disabled":return"".concat(t," bg-red-800 text-red-200");case"overridden":return"".concat(t," bg-yellow-800 text-yellow-200");default:return"".concat(t," bg-gray-800 text-gray-200")}}}));function fn(){return[{id:"basic-info",title:"Basic Information",icon:"",expanded:!0,description:"Name, race, class, and level"},{id:"stats",title:"Ability Scores",icon:"",expanded:!1,description:"STR, DEX, CON, INT, WIS, CHA scores and modifiers"},{id:"skills",title:"Skills & Proficiencies",icon:"",expanded:!1,description:"Skill bonuses and proficiency status"},{id:"features",title:"Features & Traits",icon:"",expanded:!1,description:"Class features, racial traits, and special abilities"},{id:"equipment",title:"Equipment & Inventory",icon:"",expanded:!1,description:"Weapons, armor, and carried items"},{id:"spells",title:"Spells & Magic",icon:"",expanded:!1,description:"Known spells and spell slots"}]}C.data("simpleCharacterDisclosure",()=>({sections:fn(),init(){console.log(" Simple Character Disclosure initialized"),window.addEventListener("characterDataLoaded",n=>{var e;(e=n.detail)!=null&&e.characterData&&this.updateSectionsWithCharacterData(n.detail.characterData)})},toggleSection(n){const e=this.sections.find(t=>t.id===n);e&&(e.expanded=!e.expanded,console.log(" Section ".concat(e.expanded?"expanded":"collapsed",": ").concat(n)))},updateSectionsWithCharacterData(n){const e=this.sections.map(t=>{switch(t.id){case"basic-info":return{...t,badge:n.name?"":"?",description:n.name?"".concat(n.name," - Level ").concat(this.calculateTotalLevel(n)):"Character basic information"};case"stats":return{...t,badge:n.stats?"6":"0",description:"Ability scores and modifiers"};case"skills":return{...t,badge:n.skills?Object.keys(n.skills).length.toString():"0",description:"Skills and proficiency bonuses"};case"features":return{...t,badge:n.features?n.features.length.toString():"0",description:"Class features and racial traits"};case"equipment":return{...t,badge:n.inventory?n.inventory.length.toString():"0",description:"Equipment and inventory items"};case"spells":const r=n.spells&&n.spells.length>0;return{...t,badge:r?n.spells.length.toString():"0",description:r?"Known spells and casting":"No spells available"};default:return t}});this.sections=e,console.log(" Character sections updated with data")},calculateTotalLevel(n){return!n.classes||!Array.isArray(n.classes)?1:n.classes.reduce((e,t)=>e+(t.level||0),0)},createCharacterSections(n){return fn().map(e=>{switch(e.id){case"basic-info":return{...e,badge:n.name?"":"?",expanded:!0};default:return e}})}}));console.log(" Simple Character Disclosure component registered");function da(n){var o;const e=[],t=[];let r=0;const s=10;n.name?r++:e.push("Character name is missing"),(o=n.race)!=null&&o.fullName?r++:e.push("Character race is missing"),n.classes&&n.classes.length>0?r++:e.push("Character class is missing"),n.stats&&Object.keys(n.stats).length>=6?r++:e.push("Ability scores are incomplete"),n.hitPointsMax>0?r++:t.push("Hit points may be incorrect"),n.proficiencyBonus>0?r++:t.push("Proficiency bonus may be missing"),n.armorClass>0?r++:t.push("Armor class calculation may be missing"),n.savingThrows?r++:t.push("Saving throw information may be incomplete"),n.skills&&Object.keys(n.skills).length>0?r++:t.push("Skill information may be incomplete"),n.inventory&&n.inventory.length>0?r++:t.push("Equipment information may be incomplete");const i=Math.round(r/s*100);return{isValid:e.length===0&&i>=70,completeness:i,issues:e,warnings:t}}C.data("simpleCharacterPreview",()=>({characterData:null,xmlData:null,validationStatus:{isValid:!1,completeness:0,issues:[],warnings:[]},showValidation:!0,init(){console.log(" Simple Character Preview initialized"),window.addEventListener("characterDataLoaded",n=>{var e;(e=n.detail)!=null&&e.characterData&&(this.updateCharacterData(n.detail.characterData),this.xmlData=n.detail.xml||null)})},updateCharacterData(n){var e,t,r,s;if(this.characterData=n,this.validationStatus=this.validateCharacter(n),!this.xmlData&&window.Alpine){const i=window.Alpine.store("conversionResults");i!=null&&i.xmlContent&&(this.xmlData=i.xmlContent,console.log(" XML data retrieved from store:",this.xmlData.length+" characters"))}console.log(" Character preview updated:",{name:n.name,completeness:this.validationStatus.completeness+"%",valid:this.validationStatus.isValid,hasXml:!!this.xmlData}),console.log(" Ability Score Data Structure:",{stats:n.stats,bonusStats:n.bonusStats,overrideStats:n.overrideStats,strStat:(e=n.stats)==null?void 0:e[0],strBonus:(t=n.bonusStats)==null?void 0:t[0],strOverride:(r=n.overrideStats)==null?void 0:r[0]}),console.log(" Using XML data source values:",{hp:this.getCalculatedHP(),ac:this.getCalculatedAC(),classes:this.getFormattedClasses()});try{const i=k.processAbilityScoreBonuses(n);console.log(" AbilityScoreProcessor Results (XML source):",i),console.log(" Strength from processor:",(s=i.totalScores.strength)==null?void 0:s.total)}catch(i){console.log("Error with AbilityScoreProcessor:",i)}},validateCharacter(n){return n?da(n):{isValid:!1,completeness:0,issues:["No character data available"],warnings:[]}},getCompletenessColor(n){return n>=90?"text-green-500":n>=70?"text-yellow-500":n>=50?"text-orange-500":"text-red-500"},getValidationIcon(n){return n?"":""},formatCharacterLevel(n){if(!n||!n.classes||!Array.isArray(n.classes))return"Level 1";const e=n.classes.reduce((t,r)=>t+(r.level||0),0);return"Level ".concat(e)},formatCharacterRace(n){if(!n||!n.race)return"Unknown Race";const e=n.race.fullName||n.race.baseName||"Unknown";return n.race.subRaceName&&n.race.subRaceName!==n.race.baseName?"".concat(n.race.subRaceName," ").concat(n.race.baseName):e},formatCharacterClasses(n){var e,t;if(!n||!n.classes||!Array.isArray(n.classes))return"No Class";if(n.classes.length===1){const r=n.classes[0],s=((e=r.definition)==null?void 0:e.name)||"Unknown Class",i=(t=r.subclassDefinition)==null?void 0:t.name;return i?"".concat(s," (").concat(i,")"):s}else return n.classes.map(r=>{var i;const s=((i=r.definition)==null?void 0:i.name)||"Unknown";return"".concat(s," ").concat(r.level)}).join(" / ")},extractXmlStat(n,e){if(!n)return"0";const t=new RegExp("<".concat(e,'><score type="number">(\\d+)</score>'),"i"),r=n.match(t);return r?r[1]:"0"},extractXmlValue(n,e,t){if(!n)return"0";const r=new RegExp("<".concat(e,"><").concat(t,' type="number">(\\d+)</').concat(t,">"),"i"),s=n.match(r);return s?s[1]:"0"},getCalculatedStat(n,e){var i;if(!n||!this.characterData)return 0;try{const a=k.processAbilityScoreBonuses(this.characterData),l=["strength","dexterity","constitution","intelligence","wisdom","charisma"][e];if(l&&a.totalScores[l])return a.totalScores[l].total}catch(a){console.error("Error using AbilityScoreProcessor:",a)}const t=n.value||10,r=(i=this.characterData.bonusStats)==null?void 0:i.find(a=>a.id===n.id),s=(r==null?void 0:r.value)||0;return t+s},getCalculatedHP(){if(!this.characterData)return 0;const n=this.characterData.baseHitPoints||0,e=this.calculateTotalLevel(),t=this.getConstitutionModifier();return n+t*e},calculateTotalLevel(){var n;return!((n=this.characterData)!=null&&n.classes)||!Array.isArray(this.characterData.classes)?1:this.characterData.classes.reduce((e,t)=>e+(t.level||0),0)||1},getConstitutionModifier(){var n;if(!this.characterData)return 0;try{const t=((n=k.processAbilityScoreBonuses(this.characterData).totalScores.constitution)==null?void 0:n.total)||10;return Math.floor((t-10)/2)}catch(e){return console.error("Error calculating Constitution modifier:",e),0}},getCalculatedAC(){var e,t,r;if(!this.characterData)return 10;if((e=this.characterData.classes)==null?void 0:e.some(s=>{var i,a;return((a=(i=s.definition)==null?void 0:i.name)==null?void 0:a.toLowerCase())==="barbarian"}))try{const s=k.processAbilityScoreBonuses(this.characterData),i=Math.floor((((t=s.totalScores.dexterity)==null?void 0:t.total)-10)/2)||0,a=Math.floor((((r=s.totalScores.constitution)==null?void 0:r.total)-10)/2)||0;return 10+i+a}catch(s){console.error("Error calculating Unarmored Defense AC:",s)}return this.characterData.armorClass||10},getCalculatedSpeed(){var t,r,s,i;if(!this.characterData)return 30;const n=((s=(r=(t=this.characterData.race)==null?void 0:t.weightSpeeds)==null?void 0:r.normal)==null?void 0:s.walk)||30;let e=0;return(i=this.characterData.modifiers)!=null&&i.bonus&&this.characterData.modifiers.bonus.forEach(a=>{a.subType==="speed"&&a.value&&(e+=a.value)}),n+e},getCalculatedProficiencyBonus(){return this.characterData&&this.characterData.proficiencyBonus||2},getFormattedClasses(){return this.formatCharacterClasses(this.characterData)}}));console.log(" Simple Character Preview component registered");const fa="modulepreload",pa=function(n,e){return new URL(n,e).href},pn={},ga=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),l=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(t.map(c=>{if(c=pa(c,r),c in pn)return;pn[c]=!0;const u=c.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(!!r)for(let p=a.length-1;p>=0;p--){const b=a[p];if(b.href===c&&(!u||b.rel==="stylesheet"))return}else if(document.querySelector('link[href="'.concat(c,'"]').concat(d)))return;const g=document.createElement("link");if(g.rel=u?"stylesheet":fa,u||(g.as="script"),g.crossOrigin="",g.href=c,l&&g.setAttribute("nonce",l),document.head.appendChild(g),u)return new Promise((p,b)=>{g.addEventListener("load",p),g.addEventListener("error",()=>b(new Error("Unable to preload CSS for ".concat(c))))})}))}function i(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return s.then(a=>{for(const o of a||[])o.status==="rejected"&&i(o.reason);return e().catch(i)})};function gn(){const e=W.getSupportedFormats().map(t=>{let r="good",s="Standard compatibility";switch(t.format){case"foundry-vtt-json":r="good",s="Most features supported, some manual setup may be required";break;default:r="good",s="Compatible with standard character features";break}return{id:t.format,name:t.name,description:t.description,icon:t.icon,compatibility:r,available:!0,message:s,formatInfo:t}});return e.unshift({id:"fantasy-grounds-xml",name:"Fantasy Grounds",description:"Unity & Classic compatible XML format (primary)",icon:"",compatibility:"excellent",available:!0,message:"Fully supported with complete feature set - our primary output format"}),e}function ha(n,e){return n?e.map(t=>{var a,o;let r=t.compatibility,s=t.message,i=t.available;if(t.formatInfo)try{const l={characterData:n,abilities:n.stats||{},totalLevel:((a=n.classes)==null?void 0:a.reduce((d,f)=>d+(f.level||0),0))||1},u=W.getFormatCompatibility(l).get(t.id);u&&(r=u.recommendation,u.warnings.length>0&&(s=u.warnings[0]))}catch(l){console.warn("Failed to analyze compatibility for ".concat(t.id,":"),l)}if(!t.formatInfo||r===t.compatibility){const l=((o=n.classes)==null?void 0:o.reduce((d,f)=>d+(f.level||0),0))||1,c=n.spells&&n.spells.length>0,u=n.classes&&n.classes.length>1;switch(t.id){case"fantasy-grounds-xml":break;case"foundry-vtt-json":c&&l>10?(r="good",s="High-level spellcaster - may need manual spell setup"):u&&(r="good",s="Multiclass character - verify class features");break}}return{...t,compatibility:r,available:i,message:s}}):e}C.data("simpleFormatSelector",()=>({characterData:null,availableFormats:gn(),selectedFormats:["fantasy-grounds-xml"],isAnalyzing:!1,showFormatModal:!1,conversionResults:{},init(){console.log(" Simple Format Selector initialized"),window.addEventListener("characterDataLoaded",n=>{var e;(e=n.detail)!=null&&e.characterData&&this.analyzeFormats(n.detail.characterData)}),window.addEventListener("showFormatSelector",()=>{this.showFormatModal=!0})},analyzeFormats(n){console.log(" analyzeFormats called with character data:",n==null?void 0:n.name,n==null?void 0:n.id),console.log(" Character data keys:",Object.keys(n||{})),this.characterData=n,this.isAnalyzing=!0,setTimeout(()=>{this.availableFormats=ha(n,gn()),this.isAnalyzing=!1,console.log(" Format compatibility analysis complete:",{character:n.name,formats:this.availableFormats.length,availableFormatIds:this.availableFormats.map(e=>e.id)}),console.log(" Character data stored:",!!this.characterData)},300)},toggleFormat(n){const e=this.selectedFormats.indexOf(n);e===-1?this.selectedFormats.push(n):this.selectedFormats.splice(e,1),console.log(" Format selection updated:",this.selectedFormats)},selectRecommendedFormats(){this.selectedFormats=this.availableFormats.filter(n=>n.compatibility==="excellent"||n.compatibility==="good").map(n=>n.id),console.log(" Recommended formats selected:",this.selectedFormats)},clearSelection(){this.selectedFormats=[],console.log(" Format selection cleared")},async convertToSelectedFormats(){var e,t;if(this.selectedFormats.length===0){console.warn("No formats selected for conversion");return}if(!this.characterData){console.error(" No character data available for conversion"),C.store("notifications").addError("No character data available for conversion");return}const n=C.store("notifications");try{console.log(" Converting to selected formats:",this.selectedFormats),console.log(" Character data available:",!!this.characterData),console.log(" Character data preview:",(e=this.characterData)==null?void 0:e.name,(t=this.characterData)==null?void 0:t.id),console.log(" Importing CharacterConverterFacade...");const{CharacterConverterFacade:r}=await ga(async()=>{const{CharacterConverterFacade:o}=await Promise.resolve().then(()=>ua);return{CharacterConverterFacade:o}},void 0,import.meta.url);console.log(" CharacterConverterFacade imported"),console.log(" Creating converter instance...");const s=new r;console.log(" Converter created");const i=this.selectedFormats.filter(o=>o!=="fantasy-grounds-xml"),a=this.selectedFormats.includes("fantasy-grounds-xml");if(console.log(" Registry formats to process:",i),console.log(" Include Fantasy Grounds:",a),i.length>0){console.log(" Starting multi-format conversion for:",i);try{const o=await s.generateMultiFormatOutput(this.characterData,i);console.log(" Multi-format conversion completed, results:",o.size);for(const[l,c]of o)if(console.log(" Processing result for ".concat(l,":"),c.success),c.success&&c.output){const u=this.availableFormats.find(d=>d.id===l);u?(this.conversionResults[l]={data:c.output,filename:c.filename||"".concat(this.getCharacterFilename(),".").concat(this.getFormatExtension(l)),format:u},console.log(" Successfully stored result for ".concat(l))):console.warn(" Format definition not found for ".concat(l))}else console.error(" Failed to convert to ".concat(l,":"),c.errors),n.addError("Failed to convert to ".concat(l))}catch(o){throw console.error(" Multi-format conversion threw error:",o),o}}if(a){const o=this.availableFormats.find(l=>l.id==="fantasy-grounds-xml");o&&await this.simulateConversion("fantasy-grounds-xml",o)}n.addSuccess("Successfully converted to ".concat(this.selectedFormats.length," format(s)!"))}catch(r){console.error("Conversion error:",r),n.addError("Failed to convert to selected formats")}},async simulateConversion(n,e){if(n!=="fantasy-grounds-xml"){console.warn("simulateConversion should only be used for Fantasy Grounds XML");return}await new Promise(i=>setTimeout(i,500));const t=C.store("conversionResults"),r=t.result||"<character>No data</character>",s=t.filename||"".concat(this.getCharacterFilename(),".xml");this.conversionResults[n]={data:r,filename:s,format:e},console.log(" ".concat(e.name," conversion complete"))},downloadFormat(n){const e=this.conversionResults[n];if(!e){console.warn("No conversion result found for format:",n);return}try{const t=n.includes("json")?"application/json":"application/xml",r=new Blob([e.data],{type:t}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download=e.filename,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),console.log(" Downloaded:",e.filename),C.store("notifications").addSuccess("Downloaded ".concat(e.format.name," file: ").concat(e.filename))}catch(t){console.error("Download failed:",t),C.store("notifications").addError("Failed to download ".concat(e.format.name," file"))}},closeModal(){this.showFormatModal=!1,console.log(" Format selector modal closed")},getCompatibilityColor(n){switch(n){case"excellent":return"text-green-600";case"good":return"text-blue-600";case"fair":return"text-yellow-600";case"poor":return"text-red-600";default:return"text-gray-600"}},getCompatibilityMessage(n){switch(n){case"excellent":return"Full compatibility";case"good":return"Very good compatibility";case"fair":return"Basic compatibility";case"poor":return"Limited compatibility";default:return"Unknown compatibility"}},getCharacterFilename(){if(!this.characterData)return"character_unknown";const n=(this.characterData.name||"character").replace(/[^a-zA-Z0-9_-]/g,"_"),e=this.characterData.id||"unknown";return"".concat(n,"_").concat(e)},getFormatExtension(n){const e=this.availableFormats.find(t=>t.id===n);if(e!=null&&e.formatInfo)return e.formatInfo.fileExtension.replace(".","");switch(n){case"fantasy-grounds-xml":return"xml";default:return"json"}}}));console.log(" Simple Format Selector component registered");class ma{constructor(){this.maxFileSize=5*1024*1024,this.allowedMimeTypes=["application/json","text/xml","application/xml"],this.maxProcessingTime=3e4,this.maxStringLength=1e4,this.maxArrayLength=1e3,this.maxObjectDepth=15}async processFile(e){try{const t=await this.validateFile(e);if(!t.valid)return{success:!1,errors:t.errors};const r=await this.readFileContentSecurely(e),s=await this.sanitizeContent(r,e.type),i=this.validateSecurity(s);if(!i.safe)return{success:!1,errors:["Security validation failed: ".concat(i.threats.join(", "))]};const a=await this.parseCharacterDataSecurely(s,e.type);return{success:!0,characterData:a,sourceType:this.determineSourceType(e,a),filename:this.sanitizeFilename(e.name)}}catch(t){return console.error("File processing error:",t),{success:!1,errors:["Processing failed: ".concat(this.sanitizeErrorMessage(t.message))]}}}async validateFile(e){const t=[];e.size>this.maxFileSize&&t.push("File too large. Maximum size: ".concat(this.maxFileSize/1024/1024,"MB")),e.size===0&&t.push("File is empty"),this.allowedMimeTypes.includes(e.type)||t.push("Unsupported file type: ".concat(e.type||"unknown",". Supported types: JSON, XML"));const r=this.getFileExtension(e.name);return[".json",".xml"].includes(r)||t.push("Unsupported file extension: ".concat(r,". Allowed: .json, .xml")),this.isValidFilename(e.name)||t.push("Invalid filename. Filenames cannot contain path traversal or special characters."),{valid:t.length===0,errors:t}}async readFileContentSecurely(e){return new Promise((t,r)=>{const s=new FileReader,i=setTimeout(()=>{s.abort(),r(new Error("File reading timeout"))},this.maxProcessingTime);s.onload=a=>{var l;clearTimeout(i);const o=(l=a.target)==null?void 0:l.result;if(!o||o.length===0){r(new Error("File content is empty"));return}t(o)},s.onerror=()=>{clearTimeout(i),r(new Error("Failed to read file"))},s.readAsText(e,"utf-8")})}async sanitizeContent(e,t){let r=e.replace(/\0/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"");return t==="application/json"?r=this.sanitizeJsonContent(r):t.includes("xml")&&(r=this.sanitizeXmlContent(r)),r}sanitizeJsonContent(e){return e.replace(/<script[^>]*>.*?<\/script>/gi,"").replace(/javascript:/gi,"").replace(/data:text\/html/gi,"").replace(/vbscript:/gi,"")}sanitizeXmlContent(e){return e.replace(/<!DOCTYPE[^>]*>/gi,"").replace(/<\?.*?\?>/g,t=>t.includes("xml version")?t:"").replace(/<!ENTITY[^>]*>/gi,"").replace(/<script[^>]*>.*?<\/script>/gi,"").replace(/javascript:/gi,"").replace(/vbscript:/gi,"")}validateSecurity(e){const t=[],r=[{pattern:/<script[^>]*>.*?<\/script>/gi,threat:"Script injection"},{pattern:/javascript:/gi,threat:"JavaScript URL"},{pattern:/vbscript:/gi,threat:"VBScript URL"},{pattern:/data:text\/html/gi,threat:"HTML data URL"},{pattern:/<!ENTITY/gi,threat:"XML entity declaration"},{pattern:/SYSTEM\s+['"]/gi,threat:"XML external entity"},{pattern:/%00/g,threat:"Null byte injection"}];for(const{pattern:s,threat:i}of r)s.test(e)&&t.push(i);return this.detectStructureBomb(e)&&t.push("Potential structure bomb (excessive nesting or size)"),{safe:t.length===0,threats:t}}detectStructureBomb(e){try{let t=0,r=0,s=0,i=0,a=!1;for(let o=0;o<e.length;o++){const l=e[o];if(l==="{"||l==="["||l==="<"?(r++,l==="["&&(a=!0,i=0)):l==="}"||l==="]"||l===">"?(r--,l==="]"&&(s=Math.max(s,i),a=!1)):l===","&&a&&i++,t=Math.max(t,r),t>25||s>1e4)return!0}return!1}catch(t){return!0}}async parseCharacterDataSecurely(e,t){try{if(t==="application/json"){const r=JSON.parse(e,this.jsonReviver.bind(this));return this.validateCharacterStructure(r)}else if(t.includes("xml")){const s=new DOMParser().parseFromString(e,"text/xml");if(s.querySelector("parsererror"))throw new Error("Invalid XML structure");return this.convertXmlToCharacterData(s)}throw new Error("Unsupported file type for parsing")}catch(r){throw new Error("Failed to parse file: ".concat(r.message))}}jsonReviver(e,t){if(!["__proto__","constructor","prototype"].includes(e))return typeof t=="string"?this.sanitizeStringValue(t):t}sanitizeStringValue(e){return e.length>this.maxStringLength&&(e=e.substring(0,this.maxStringLength)),e.replace(/<script[^>]*>.*?<\/script>/gi,"").replace(/javascript:/gi,"").replace(/data:text\/html/gi,"").replace(/vbscript:/gi,"")}validateCharacterStructure(e){const t=this.validateDataStructure(e);if(!t.valid)throw new Error("Invalid data structure: ".concat(t.error));if(!e||typeof e!="object")throw new Error("Invalid character data structure");let r=e;e.success&&e.data&&typeof e.data=="object"&&(r=e.data,console.log(" Detected D&D Beyond API response wrapper, extracting character data"));const s=["id","name"];for(const i of s)if(!(i in r))throw new Error("Missing required field: ".concat(i));if(typeof r.id!="number"&&typeof r.id!="string")throw new Error("Invalid character ID format");if(typeof r.name!="string"||r.name.trim().length===0)throw new Error("Invalid character name");return r}validateDataStructure(e,t=0){if(t>this.maxObjectDepth)return{valid:!1,error:"Object structure too deep"};if(Array.isArray(e)){if(e.length>this.maxArrayLength)return{valid:!1,error:"Array too large"};for(const r of e){const s=this.validateDataStructure(r,t+1);if(!s.valid)return s}}else if(typeof e=="object"&&e!==null){if(Object.keys(e).length>1e3)return{valid:!1,error:"Object has too many properties"};for(const[s,i]of Object.entries(e)){if(!this.isValidPropertyName(s))return{valid:!1,error:"Invalid property name: ".concat(s)};const a=this.validateDataStructure(i,t+1);if(!a.valid)return a}}else if(typeof e=="string"&&e.length>this.maxStringLength)return{valid:!1,error:"String value too long"};return{valid:!0}}convertXmlToCharacterData(e){var i,a;const t=e.querySelector("character");if(!t)throw new Error("Invalid Fantasy Grounds XML: missing character element");const r=((a=(i=t.querySelector("name"))==null?void 0:i.textContent)==null?void 0:a.trim())||"Unknown Character";return{id:Date.now(),name:r,sourceType:"fantasy-grounds-xml"}}determineSourceType(e,t){return e.type.includes("xml")?"fantasy-grounds-xml":t.classes&&t.stats&&t.race?"dndbeyond-json":"custom-json"}isValidPropertyName(e){return["__proto__","constructor","prototype"].includes(e)||e.length>200?!1:![/javascript:/i,/vbscript:/i,/data:/i,/<script/i,/eval\(/i,/function\(/i,/\0/,/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/].some(s=>s.test(e))}isValidFilename(e){return e.includes("..")||e.includes("/")||e.includes("\\")?!1:![/^(con|prn|aux|nul|com[1-9]|lpt[1-9])(\.|$)/i,/[<>:"|?*]/,/^\./,/^$/].some(r=>r.test(e))}sanitizeFilename(e){return e.replace(/[^a-zA-Z0-9._-]/g,"_").substring(0,100)}sanitizeErrorMessage(e){return e.replace(/[<>]/g,"").substring(0,200)}getFileExtension(e){const t=e.lastIndexOf(".");return t===-1?"":e.substring(t).toLowerCase()}}const ya=new ma;C.data("fileUploader",()=>({isDragging:!1,isProcessing:!1,uploadProgress:0,currentStep:"",selectedFile:null,fileName:"",fileSize:"",fileType:"",processResult:null,showValidationDetails:!1,init(){console.log(" File Uploader component initialized"),document.addEventListener("dragover",n=>n.preventDefault()),document.addEventListener("drop",n=>n.preventDefault())},handleDragOver(n){n.preventDefault(),n.stopPropagation()},handleDragEnter(n){n.preventDefault(),n.stopPropagation(),this.isDragging=!0},handleDragLeave(n){n.preventDefault(),n.stopPropagation(),(!n.currentTarget||!n.currentTarget.contains(n.relatedTarget))&&(this.isDragging=!1)},async handleDrop(n){var t;n.preventDefault(),n.stopPropagation(),this.isDragging=!1;const e=(t=n.dataTransfer)==null?void 0:t.files;if(e&&e.length>0){const r=e[0];await this.processFile(r)}},async handleFileSelect(n){const e=n.target;if(e.files&&e.files.length>0){const t=e.files[0];await this.processFile(t)}},async processFile(n){try{this.processResult=null,this.selectedFile=n,this.fileName=n.name,this.fileSize=this.formatFileSize(n.size),this.fileType=n.type||"unknown",this.isProcessing=!0,this.uploadProgress=0,this.currentStep="Validating file...",console.log(" Processing file:",{name:n.name,size:n.size,type:n.type}),this.currentStep="Validating file properties...",this.uploadProgress=20,await this.delay(200),this.currentStep="Running security checks...",this.uploadProgress=40,await this.delay(300),this.currentStep="Processing file content...",this.uploadProgress=60,await this.delay(200),this.currentStep="Parsing character data...",this.uploadProgress=80;const e=await ya.processFile(n);this.processResult=e,this.currentStep="Processing complete!",this.uploadProgress=100,await this.delay(300);const t=C.store("notifications");if(e.success&&e.characterData){this.currentStep="Converting to Fantasy Grounds XML...",this.uploadProgress=90,await this.delay(200);try{const r=window.characterConverterFacade;if(!r)throw new Error("CharacterConverterFacade not available");const s=await r.convertCharacterData(e.characterData);if(!s.success||!s.xml)throw new Error(s.error||"Failed to convert character to XML");this.currentStep="Complete!",this.uploadProgress=100,await this.delay(300);const i=e.characterData.name||"Unknown Character",a=e.characterData.id||"unknown";C.store("conversionResults").setResult(s.xml,i,a);const l=new CustomEvent("characterDataLoaded",{detail:{characterData:e.characterData,xml:s.xml,characterName:i}});if(document.dispatchEvent(l),this.$dispatch)console.log(" Dispatching file-converted event to parent"),this.$dispatch("file-converted",{characterData:e.characterData,xml:s.xml,characterName:i,characterId:"file_".concat(e.characterData.id||Date.now())});else{console.log(" $dispatch not available, trying direct access");const c=document.querySelector('[x-data*="enhancedCharacterConverter"]');if(c&&c._x_dataStack){const u=c._x_dataStack[0];u&&(console.log(" Directly updating parent converter component"),u.characterId="file_".concat(e.characterData.id||Date.now()),u.isValidId=!0,u.isConverting=!1,u.progress=100,u.currentStep="File conversion complete!",u.characterData=e.characterData)}}t.addSuccess(' Character "'.concat(i,'" converted successfully!')),console.log(" File processed and converted successfully:",{character:e.characterData.name,source:e.sourceType,filename:e.filename})}catch(r){console.error(" XML conversion failed:",r);const s=r instanceof Error?r.message:"Conversion failed";t.addError(" File processed but conversion failed: ".concat(s)),this.currentStep="Conversion error",this.uploadProgress=80}}else{const r=e.errors?e.errors.join("; "):"Unknown error";t.addError(" File processing failed: ".concat(r)),console.error(" File processing failed:",e.errors)}e.warnings&&e.warnings.length>0&&e.warnings.forEach(r=>{t.addWarning(" ".concat(r))})}catch(e){console.error("File processing error:",e);const t=C.store("notifications"),r=e instanceof Error?e.message:"Unknown error occurred";t.addError("File processing failed: ".concat(r)),this.currentStep="Error occurred",this.uploadProgress=0,this.processResult={success:!1,errors:[r]}}finally{this.isProcessing=!1}},clearFile(){this.selectedFile=null,this.fileName="",this.fileSize="",this.fileType="",this.processResult=null,this.uploadProgress=0,this.currentStep="",this.showValidationDetails=!1;const n=document.querySelector("#file-input");n&&(n.value=""),console.log(" File uploader cleared")},formatFileSize(n){if(n===0)return"0 Bytes";const e=1024,t=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(n)/Math.log(e));return parseFloat((n/Math.pow(e,r)).toFixed(2))+" "+t[r]},getFileIcon(n){return n.includes("json")?"":n.includes("xml")?"":""},getValidationIcon(n){return n?"":""},showHelp(){C.store("notifications").addInfo("\n       <strong>File Upload Help:</strong><br>\n       Supported formats: JSON (.json), XML (.xml)<br>\n       Maximum file size: 5MB<br>\n       Drag & drop or click to select files<br>\n       Files are processed with comprehensive security validation<br>\n       D&D Beyond JSON and Fantasy Grounds XML formats supported\n    ")},delay(n){return new Promise(e=>setTimeout(e,n))}}));console.log(" File Uploader component registered");console.log("D&D Beyond to Fantasy Grounds Converter v2.0 - Phase 2 Integration");console.log("Design System & Progressive Disclosure & Multi-Format Export Initialized");const ba=async()=>{try{const n=Ar.generateCustomProperties(Be);if(!document.getElementById("design-tokens")){const s=document.createElement("style");s.id="design-tokens",s.textContent=n,document.head.appendChild(s),console.log(" Design tokens injected successfully")}const t=$r();console.log(" Animation engine initialized");const r=Mr();return console.log(" Accessibility infrastructure initialized"),r.announce("Design system loaded successfully","polite"),Promise.resolve()}catch(n){throw console.error(" Design system initialization failed:",n),n}};typeof window<"u"&&(window.featureFlags=h,window.characterFetcher=Ki,window.characterConverterFacade=Ir,window.gameConfigService=I,window.ObjectSearch=j,window.StringSanitizer=M,window.SafeAccess=O,window.AbilityScoreUtils=P,window.AbilityScoreProcessor=k,window.SpellSlotCalculator=X,window.designTokens=Be,window.CSSTokenGenerator=Ar);document.addEventListener("DOMContentLoaded",async()=>{console.log(" Initializing modern D&D converter...");try{await ba(),console.log(" Initializing Phase 2 systems...");try{await I.loadConfigs(),console.log(" Game configuration loaded successfully")}catch(n){console.warn(" Failed to load game configuration, using fallbacks:",n)}if(C.start(),console.log(" Alpine.js started"),h.isEnabled("performance_metrics")){if(console.log(" Performance metrics enabled"),!document.querySelector(".performance-dashboard")){const n=document.createElement("div");n.className="performance-dashboard",n.innerHTML='\n          <div class="performance-metrics">\n            <div class="metric-item metric-good">\n              <div class="metric-name">FPS</div>\n              <div class="metric-value">60</div>\n            </div>\n            <div class="metric-item metric-good">\n              <div class="metric-name">Memory</div>\n              <div class="metric-value">25MB</div>\n            </div>\n          </div>\n        ',document.body.appendChild(n)}console.log("Active feature flags:",Object.entries(h.getAllFlags()).filter(([n])=>h.isEnabled(n)).map(([n])=>n))}console.log(" Enhanced converter initialization complete!"),console.log(" Phase 2 Integration Status:"),console.log("   Design Token System"),console.log("   Animation Engine (60fps hardware acceleration)"),console.log("   Accessibility Infrastructure (WCAG AA)"),console.log("   Performance Monitoring"),console.log("   Progressive Disclosure System"),console.log("   Character Preview with Validation"),console.log("   Multi-Format Export Selection"),console.log("   Enhanced User Experience Workflow"),window.accessibilityManager&&window.accessibilityManager.announce("D&D Beyond to Fantasy Grounds converter loaded successfully. Enhanced accessibility and animation features are now available.","polite")}catch(n){console.error(" Critical initialization failure:",n);const e=document.createElement("div");e.className="alert alert-error",e.innerHTML='\n      <div class="alert-content">\n        <div class="alert-title">Initialization Error</div>\n        <div class="alert-message">Some advanced features may not be available. Please refresh the page.</div>\n      </div>\n    ',document.body.insertBefore(e,document.body.firstChild);try{C.start(),console.log(" Alpine.js started in fallback mode")}catch(t){console.error(" Alpine.js failed to start:",t)}}});
