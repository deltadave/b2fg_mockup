-- 
-- Please see the license.html file included with this distribution for 
-- attribution and copyright information.
--

ARTIFICER_SPELLS = {{2,2,0,0,0,0,0,0,0,0,0}, {2,2,0,0,0,0,0,0,0,0,0}, {2,3,0,0,0,0,0,0,0,0,0}, {2,3,0,0,0,0,0,0,0,0,0}, {2,4,2,0,0,0,0,0,0,0,0}, {2,4,2,0,0,0,0,0,0,0,0}, {2,4,3,0,0,0,0,0,0,0,0}, {2,4,3,0,0,0,0,0,0,0,0}, {2,4,3,2,0,0,0,0,0,0,0}, {3,4,3,2,0,0,0,0,0,0,0}, {3,4,3,3,0,0,0,0,0,0,0}, {3,4,3,3,0,0,0,0,0,0,0}, {3,4,3,3,1,0,0,0,0,0,0,0}, {4,4,3,3,1,0,0,0,0,0,0}, {4,4,3,3,2,0,0,0,0,0,0}, {4,4,3,3,2,0,0,0,0,0,0}, {4,4,3,3,3,1,0,0,0,0,0}, {4,4,3,3,3,1,0,0,0,0,0}, {4,4,3,3,3,2,0,0,0,0,0}, {4,4,3,3,3,2,0,0,0,0,0}};
BARD_SPELLS = {{2,2,0,0,0,0,0,0,0,0,4},{2,3,0,0,0,0,0,0,0,0,5},{2,4,2,0,0,0,0,0,0,0,6},{3,4,3,0,0,0,0,0,0,0,7},{3,4,3,2,0,0,0,0,0,0,8},{3,4,3,3,0,0,0,0,0,0,9},{3,4,3,3,1,0,0,0,0,0,10},{3,4,3,3,2,0,0,0,0,0,11},{3,4,3,3,2,0,0,0,0,0,12},{3,4,3,3,3,1,0,0,0,0,14},{4,4,3,3,3,2,0,0,0,0,15},{4,4,3,3,3,2,1,0,0,0,15},{4,4,3,3,3,2,1,0,0,0,16},{4,4,3,3,3,2,1,1,0,0,18},{4,4,3,3,3,2,1,1,0,0,19},{4,4,3,3,3,2,1,1,1,0,19},{4,4,3,3,3,2,1,1,1,1,20},{4,4,3,3,3,3,1,1,1,1,22},{4,4,3,3,3,3,1,1,1,1,22},{4,4,3,3,3,3,2,2,1,1,22}};
CLERIC_SPELLS = {{3,2,0,0,0,0,0,0,0,0,0}, {3,3,0,0,0,0,0,0,0,0,0}, {3,4,2,0,0,0,0,0,0,0,0}, {4,4,3,0,0,0,0,0,0,0,0}, {4,4,3,2,0,0,0,0,0,0,0}, {4,4,3,3,0,0,0,0,0,0,0}, {4,4,3,3,1,0,0,0,0,0,0}, {4,4,3,3,2,0,0,0,0,0,0}, {4,4,3,3,3,1,0,0,0,0.0}, {5,4,3,3,3,2,0,0,0,0,0}, {5,4,3,3,3,2,1,0,0,0,0}, {5,4,3,3,3,2,1,0,0,0,0}, {5,4,3,3,3,2,1,1,0,0,0}, {5,4,3,3,3,2,1,1,0,0,0}, {5,4,3,3,3,2,1,1,1,0,0}, {5,4,3,3,3,2,1,1,1,0,0}, {5,4,3,3,3,2,1,1,1,1,0}, {5,4,3,3,3,3,1,1,1,0}, {5,4,3,3,3,3,2,1,1,1,0}, {5,4,3,3,3,3,2,2,1,1,0}};
PALADIN_SPELLS = {{-1,0,0,0,0,0,0,0,0,0,0}, {-1,2,0,0,0,0,0,0,0,0,0}, {-1,3,0,0,0,0,0,0,0,0,0}, {-1,3,0,0,0,0,0,0,0,0,0}, {-1,4,2,0,0,0,0,0,0,0,0}, {-1,4,2,0,0,0,0,0,0,0,0}, {-1,4,3,0,0,0,0,0,0,0,0}, {-1,4,3,0,0,0,0,0,0,0,0}, {-1,4,3,2,0,0,0,0,0,0,0}, {-1,4,3,2,0,0,0,0,0,0,0}, {-1,4,3,3,0,0,0,0,0,0,0}, {-1,4,3,3,0,0,0,0,0,0,0}, {-1,4,3,3,1,0,0,0,0,0,0}, {-1,4,3,3,1,0,0,0,0,0,0}, {-1,4,3,3,2,0,0,0,0,0,0}, {-1,4,3,3,2,0,0,0,0,0,0}, {-1,4,3,3,3,1,0,0,0,0,0}, {-1,4,3,3,3,1,0,0,0,0,0}, {-1,4,3,3,3,2,0,0,0,0,0}, {-1,4,3,3,3,2,0,0,0,0,0}};
RANGER_SPELLS = {{-1,0,0,0,0,0,0,0,0,0,0}, {-1,2,0,0,0,0,0,0,0,0,2}, {-1,3,0,0,0,0,0,0,0,0,3}, {-1,3,0,0,0,0,0,0,0,0,3}, {-1,4,2,0,0,0,0,0,0,0,4}, {-1,4,2,0,0,0,0,0,0,0,4}, {-1,4,3,0,0,0,0,0,0,0,5}, {-1,4,3,0,0,0,0,0,0,0,5}, {-1,4,3,2,0,0,0,0,0,0,6}, {-1,4,3,2,0,0,0,0,0,0,6}, {-1,4,3,3,0,0,0,0,0,0,7}, {-1,4,3,3,0,0,0,0,0,0,7}, {-1,4,3,3,1,0,0,0,0,0,8}, {-1,4,3,3,1,0,0,0,0,0,8}, {-1,4,3,3,2,0,0,0,0,0,9}, {-1,4,3,3,2,0,0,0,0,0,9}, {-1,4,3,3,3,1,0,0,0,0,10}, {-1,4,3,3,3,1,0,0,0,0,10}, {-1,4,3,3,3,2,0,0,0,0,11}, {-1,4,3,3,3,2,0,0,0,0,11}};
SORCERER_SPELLS = {{4,2,0,0,0,0,0,0,0,0,2}, {4,3,0,0,0,0,0,0,0,0,3}, {4,4,2,0,0,0,0,0,0,0,4}, {5,4,3,0,0,0,0,0,0,0,5}, {5,4,3,2,0,0,0,0,0,0,6}, {5,4,3,3,0,0,0,0,0,0,7}, {5,4,3,3,1,0,0,0,0,0,8}, {5,4,3,3,2,0,0,0,0,0,9}, {5,4,3,3,3,1,0,0,0,0,10}, {6,4,3,3,3,2,0,0,0,0,11}, {6,4,3,3,3,2,1,0,0,0,12}, {6,4,3,3,3,2,1,0,0,0,12}, {6,4,3,3,3,2,1,1,0,0,13}, {6,4,3,3,3,2,1,1,0,0,13}, {6,4,3,3,3,2,1,1,1,0,14}, {6,4,3,3,3,2,1,1,1,0,14}, {6,4,3,3,3,2,1,1,1,1,15}, {6,4,3,3,3,3,1,1,1,15}, {6,4,3,3,3,3,2,1,1,1,15}, {6,4,3,3,3,3,2,2,1,1,15}};
WARLOCK_SPELLS = {{2,2,1,1,0},{2,3,2,1,2},{2,4,2,2,2},{3,5,2,2,2},{3,6,2,3,3},{3,7,2,3,3},{3,8,2,4,4},{3,9,2,4,4},{3,10,2,5,5},{4,10,2,5,5},{4,11,3,5,5},{4,11,3,5,6},{4,12,3,5,6},{4,12,3,5,6},{4,13,3,5,7},{4,13,3,5,7},{4,14,4,5,7},{4,14,4,5,8},{4,15,4,5,8},{4,15,4,5,8}};
WIZARD_SPELLS = {{3,2,0,0,0,0,0,0,0,0,0}, {3,3,0,0,0,0,0,0,0,0,0}, {3,4,2,0,0,0,0,0,0,0,0}, {4,4,3,0,0,0,0,0,0,0,0}, {4,4,3,2,0,0,0,0,0,0,0}, {4,4,3,3,0,0,0,0,0,0,0}, {4,4,3,3,1,0,0,0,0,0,0}, {4,4,3,3,2,0,0,0,0,0,0}, {4,4,3,3,3,1,0,0,0,0,0}, {5,4,3,3,3,2,0,0,0,0,0}, {5,4,3,3,3,2,1,0,0,0,0}, {5,4,3,3,3,2,1,0,0,0,0}, {5,4,3,3,3,2,1,1,0,0,0,0}, {5,4,3,3,3,2,1,1,0,0,0}, {5,4,3,3,3,2,1,1,1,0,0}, {5,4,3,3,3,2,1,1,1,0,0}, {5,4,3,3,3,2,1,1,1,1,0}, {5,4,3,3,3,3,1,1,1,1,0}, {5,4,3,3,3,3,2,1,1,1,0}, {5,4,3,3,3,3,2,2,1,1,0}};
KNIGHT_SPELLS = {{0,0,0,0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0,0,0,0}, {2,2,0,0,0,0,0,0,0,0,3}, {2,3,0,0,0,0,0,0,0,0,4}, {2,3,0,0,0,0,0,0,0,0,4}, {2,3,0,0,0,0,0,0,0,0,4}, {2,4,2,0,0,0,0,0,0,0,5}, {2,4,2,0,0,0,0,0,0,0,6}, {2,4,2,0,0,0,0,0,0,0,6}, {3,4,3,0,0,0,0,0,0,0,7}, {3,4,3,0,0,0,0,0,0,0,8}, {3,4,3,0,0,0,0,0,0,0,8}, {3,4,3,2,0,0,0,0,0,0,9}, {3,4,3,2,0,0,0,0,0,0,10}, {3,4,3,2,0,0,0,0,0,0,10}, {3,4,3,3,0,0,0,0,0,0,11}, {3,4,3,3,0,0,0,0,0,0,11}, {3,4,3,3,0,0,0,0,0,0,11}, {3,4,3,3,1,0,0,0,0,0,12}, {3,4,3,3,1,0,0,0,0,0,13}};
TRICKSTER_SPELLS = {{0,0,0,0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0,0,0,0}, {3,2,0,0,0,0,0,0,0,0,3}, {3,3,0,0,0,0,0,0,0,0,4}, {3,3,0,0,0,0,0,0,0,0,4}, {3,3,0,0,0,0,0,0,0,0,4}, {3,4,2,0,0,0,0,0,0,0,5}, {3,4,2,0,0,0,0,0,0,0,6}, {3,4,2,0,0,0,0,0,0,0,6}, {4,4,3,0,0,0,0,0,0,0,7}, {4,4,3,0,0,0,0,0,0,0,8}, {4,4,3,0,0,0,0,0,0,0,8}, {4,4,3,2,0,0,0,0,0,0,9}, {4,4,3,2,0,0,0,0,0,0,10}, {4,4,3,2,0,0,0,0,0,0,10}, {4,4,3,3,0,0,0,0,0,0,11}, {4,4,3,3,0,0,0,0,0,0,11}, {4,4,3,3,0,0,0,0,0,0,11}, {4,4,3,3,1,0,0,0,0,0,12}, {4,4,3,3,1,0,0,0,0,0,13}};
MULTICLASS_SPELLS = {{0,2,0,0,0,0,0,0,0,0,0}, {0,3,0,0,0,0,0,0,0,0,2}, {0,4,2,0,0,0,0,0,0,0,3}, {0,4,3,0,0,0,0,0,0,0,3}, {0,4,3,2,0,0,0,0,0,0,4}, {0,4,3,3,0,0,0,0,0,0,4}, {0,4,3,3,1,0,0,0,0,0,5}, {0,4,3,3,2,0,0,0,0,0,5}, {0,4,3,3,3,1,0,0,0,0,6}, {0,4,3,3,3,2,0,0,0,0,6}, {0,4,3,3,3,2,1,0,0,0,7}, {0,4,3,3,3,2,1,0,0,0,7}, {0,4,3,3,3,2,1,1,0,0,8}, {0,4,3,3,3,2,1,1,0,0,8}, {0,4,3,3,3,2,1,1,1,0,9}, {0,4,3,3,3,2,1,1,1,0,9}, {0,4,3,3,3,2,1,1,1,1,10}, {0,4,3,3,3,3,1,1,1,1,10}, {0,4,3,3,3,3,2,1,1,1,11}, {0,4,3,3,3,3,2,2,1,1,11}};

function onInit()
	local sMainClass = "";
	if CampaignRegistry.charwizard.classes then
		sMainClass = string.upper(CampaignRegistry.charwizard.classes[1].name);
	end
	-- Add Spells
	setSpellClasses();	
	if CampaignRegistry.charwizard.classes and sMainClass ~= "" then
		getSpellsAvailable(sMainClass);
	end
	if sMainClass == "PALADIN" or sMainClass == "RANGER" then
		createSpellList(1);
		window.button_spelllevel_1.setFrame("buttondown", 5,5,5,5);
		window.cantrip_button.setFrame("buttondisabled", 5,5,5,5);		
	else
		createSpellList(0);	
		window.cantrip_button.setFrame("buttondown", 5,5,5,5);
	end
end

function createSpellList(nLevel, sClasses)
	closeAll();
	local aSpells = {};
	local aSpellCheck = {};	
	local wndSummary = Interface.findWindow("charwizard", "");
	local aSummaryClassList = wndSummary.summary.subwindow.summary_class.getWindows();
	local aSummarySpecList = wndSummary.summary.subwindow.summary_specialization.getWindows();	
	local sSpecName = "";
	local sSpellLower = "";
	local nClassLevel = 0;
	local bSpec = true;
	if sClasses and sClasses ~= "" then
		sClasses = StringManager.capitalize(string.lower(sClasses));
	else
		for _,vClass in pairs(aSummaryClassList) do
			sClasses = StringManager.capitalize(vClass.classname.getValue():lower());
		end
	end
	for _,vSpecName in pairs(aSummarySpecList) do
		if string.lower(vSpecName.classlevel.getValue()) == string.lower(sClasses) then
			sSpecName = vSpecName.classname.getValue();
		end
	end
	if CampaignRegistry.charwizard.classes then
		for _,vClass in pairs(CampaignRegistry.charwizard.classes) do
			if string.upper(vClass.name) == string.upper(sClasses) then
				nClassLevel = tonumber(vClass.level);
			end
		end
	end

	-- Get Spell Specialization 
	if CampaignRegistry.charwizard.classes then	
		if wndSummary.isSpellCaster(string.upper(sClasses), nClassLevel) then
			local aMappings = LibraryData.getMappings("spell");
			for _,vMapping in ipairs(aMappings) do
				for _,vSpell in pairs(DB.getChildrenGlobal(vMapping)) do	
					local bInclude = false;
					local sSpellLevel = DB.getValue(vSpell, "level", "");
					local sSpellSource = DB.getValue(vSpell, "source", "");
					local aSpellSources = StringManager.split(sSpellSource, ",");
					sSpellLower = StringManager.trim(DB.getValue(vSpell, "name", "")):lower();

					local sSpellGroup = "";
					if sClasses == "" then
						sSpellGroup = "Class Not Selected";
					else
						sSpellGroup = sClasses;
					end
					
					if sClasses == "Fighter" then
						for _,vCRClass in pairs(CampaignRegistry.charwizard.classes) do
							if vCRClass.name == "fighter" and vCRClass.spec == "eldritch knight" then						
								sClasses = "Eldritch Knight";
							end
						end
					end
					if sClasses == "Rogue" then
						for _,vCRClass in pairs(CampaignRegistry.charwizard.classes) do
							if vCRClass.name == "rogue" and vCRClass.spec == "arcane trickster" then						
								sClasses = "Arcane Trickster";
							end
						end
					end
					
					for i = 1,#aSpellSources do
						local sSourceName = string.gsub(aSpellSources[i], "^%s*", "");
						if sSpecName ~= "" and string.match(string.lower(string.gsub(sSourceName, " ", "")), string.lower(string.gsub(sSpecName, " ", ""))) then
							sSpellGroup = StringManager.capitalizeAll(string.lower(sSpecName));
							bInclude = true;
						elseif string.gsub(sSourceName, " ", "") == sClasses then
							bInclude = true;
							sSpellGroup = StringManager.capitalizeAll(string.lower(sClasses));
						end
						if sClasses == "Sorcerer" then
							for _,vCRClass in pairs(CampaignRegistry.charwizard.classes) do
								if vCRClass.name == "sorcerer" and vCRClass.spec == "divine soul" then
									if string.gsub(sSourceName, " ", "") == "Cleric" then
										bInclude = true;
										sSpellGroup = StringManager.capitalizeAll(string.lower(vCRClass.spec));
									end
								end
							end
						end	
					end

					local sSpellLink = vSpell.getPath();

					if not StringManager.contains(aSpellCheck, sSpellLower) then
						if sSpellLevel == nLevel then
							if bInclude then
								table.insert(aSpellCheck, sSpellLower);

								local w = createWindow();
								local sSpellCapitalized = StringManager.capitalizeAll(sSpellLower);
								w.name.setValue(sSpellCapitalized);

								w.group.setValue(sSpellGroup);
								
								w.source.setValue(sSpellSource);
								if sSpellLevel == 0 then
									w.displaylevel.setValue("Cantrip");
								else
									w.displaylevel.setValue(sSpellLevel);
								end
								w.level.setValue(tonumber(sSpellLevel));
								w.link.setValue("reference_spell", sSpellLink);
							end
						end
					end
				end
			end
			if CampaignRegistry.charwizard.background and CampaignRegistry.charwizard.background.spells then
				local aMappings = LibraryData.getMappings("spell");
				for i=1,6 do
					if (i - 1) == nLevel then
						local aLevelSpells = CampaignRegistry.charwizard.background.spells[nLevel]
						for j=1,#aLevelSpells do
							if not StringManager.contains(aSpellCheck, aLevelSpells[j]) then
								for _,vMapping in ipairs(aMappings) do
									for _,vSpell in pairs(DB.getChildrenGlobal(vMapping)) do
										if aLevelSpells[j] == StringManager.trim(DB.getValue(vSpell, "name", "")):lower() then
											local w = createWindow();
											w.name.setValue(StringManager.capitalizeAll(aLevelSpells[j]));
											w.displaylevel.setValue(nLevel)
											if nLevel == 0 then
												w.displaylevel.setValue("Cantrip");
											end
											w.level.setValue(tonumber(nLevel));
											w.group.setValue(CampaignRegistry.charwizard.background.spells.name);
											w.link.setValue("reference_spell", vSpell.getPath());
										end
									end
								end
							end
						end
					end
				end
			end
			--[[ Additional Spells Class Option
			if CampaignRegistry.charwizard.tashaoptions then
				for _,vAdditionalSpells in pairs(CampaignRegistry.charwizard.tashaoptions) do
					if vAdditionalSpells.name:match("additional") then
					end
				end
			end
			]]
			applySort();
		end
	end
end

function setSpellClasses()
	window.spellclass.closeAll();
	local sMainClass = "";
	if CampaignRegistry.charwizard.classes then
		sMainClass = string.upper(CampaignRegistry.charwizard.classes[1].name);
	end
	local wndSummary = Interface.findWindow("charwizard", "");
	local aClassList = wndSummary.summary.subwindow.summary_class.getWindows();
	local wndClassList = {};
	for _,v in pairs(aClassList) do
		wndClassList = window.spellclass.createWindow();
		wndClassList.bname.setText(v.classname.getValue());
		wndClassList.name.setValue(v.classname.getValue());		
		wndClassList.shortcut.setValue(v.classlink.getValue());
		wndClassList.level.setValue(v.classlevel.getValue());
	end
	
	for _,vWindowClass in pairs(window.spellclass.getWindows()) do
		if vWindowClass.name.getValue() == sMainClass then
			vWindowClass.bname.setFrame("buttondown", 4, 4, 4, 4);
			vWindowClass.toggle.setValue(1);
		end
	end	
	applySort();
end

function getArtificerSpells()
end

function getSpellsAvailable(sClassName)
	-- Populate Available Spells per Class
	local wndSummary = Interface.findWindow("charwizard", "");

	local aSlots = {};
	local aImpSlots = {};	
	local sClassRecord = "";
	local sImpClassRecord = "";	
	local sCantrips = "";
	local sSpells = "";
	local nImpCantrips = 0;
	local nImpSpells = 0;	
	local nClassLevel = 0;
	local nImpClassLevel = 0;	
	local bImport = false;

	local nCantripsSelected, nSpellsSelected = window.selectedspells.getSelectedSpellCount(sClassName)

	if CampaignRegistry.charwizard.import then
		bImport = true;
	end

	if CampaignRegistry.charwizard.classes then
		for _,vClass in pairs(CampaignRegistry.charwizard.classes) do
			if vClass.name == string.lower(sClassName) then
				nClassLevel = tonumber(vClass.level);
				sClassRecord = vClass.record;
			end
		end
	end

	if bImport then
		if CampaignRegistry.charwizard.impclasses then
			for _,vImpClass in pairs(CampaignRegistry.charwizard.impclasses) do
				if vImpClass.name == string.lower(sClassName) then
					nImpClassLevel = tonumber(vImpClass.level);
					sImpClassRecord = vImpClass.record;
				end
			end
		end
	end

	if sClassName == "FIGHTER" then
		for _,vSpecName in pairs(wndSummary.summary.subwindow.summary_specialization.getWindows()) do
			if vSpecName.classname.getValue() == "ELDRITCH KNIGHT" then
				sClassName = "ELDRITCH KNIGHT";
			end
		end
	elseif sClassName == "ROGUE" then
		for _,vSpecName in pairs(wndSummary.summary.subwindow.summary_specialization.getWindows()) do
			if vSpecName.classname.getValue() == "ARCANE TRICKSTER" then
				sClassName = "ARCANE TRICKSTER";
			end
		end		
	end
	if sClassName == "BARD" or sClassName == "SORCERER" then
		if sClassName == "BARD" then
			sCantrips = BARD_SPELLS[nClassLevel][1];
			sSpells = BARD_SPELLS[nClassLevel][11];
			aSlots = BARD_SPELLS[nClassLevel];
		else
			sCantrips = SORCERER_SPELLS[nClassLevel][1];
			sSpells = SORCERER_SPELLS[nClassLevel][11];
			aSlots = SORCERER_SPELLS[nClassLevel];				
		end			
		if bImport then
			if sImpClassName == "BARD" then
				nImpCantrips = BARD_SPELLS[nImpClassLevel][1];
				nImpSpells = BARD_SPELLS[nImpClassLevel][11];
				aImpSlots = BARD_SPELLS[nImpClassLevel];
			else
				nImpCantrips = SORCERER_SPELLS[nImpClassLevel][1];
				nImpSpells = SORCERER_SPELLS[nImpClassLevel][11];
				aImpSlots = SORCERER_SPELLS[nImpClassLevel];
			end
		end
		window.cantrips_available.setValue((sCantrips - nImpCantrips) - nCantripsSelected .. "/" .. sCantrips);
		window.spells_available.setValue((sSpells - nImpSpells) - nSpellsSelected .. "/" .. sSpells);
	elseif sClassName == "ARTIFICER" then
		local nAbilityBonus = getSpellBonus("genval4", "int");
		sCantrips = ARTIFICER_SPELLS[nClassLevel][1];
		aSlots = ARTIFICER_SPELLS[nClassLevel];
		sSpells = tonumber(math.floor(nClassLevel / 2)) + nAbilityBonus;
		if sSpells < 1 then
			sSpells = 1;
		end			
		window.cantrips_available.setValue(sCantrips - nCantripsSelected .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);
	elseif sClassName == "CLERIC" or sClassName == "DRUID" then
		local nAbilityBonus = getSpellBonus("genval5", "wis");
		sCantrips = CLERIC_SPELLS[nClassLevel][1];
		aSlots = CLERIC_SPELLS[nClassLevel];
		if sClassName == "DRUID" then
			sCantrips = tonumber(sCantrips) - 1;
			aSlots = CLERIC_SPELLS[nClassLevel];				
		end
		sSpells = tonumber(nClassLevel) + nAbilityBonus;
		if sSpells < 1 then
			sSpells = 1;
		end			
		window.cantrips_available.setValue(sCantrips - nCantripsSelected .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);
	elseif sClassName == "PALADIN" then
		local nAbilityBonus = getSpellBonus("genval6", "cha");
		sCantrips = 0;
		sSpells = math.floor(nClassLevel / 2) + nAbilityBonus;
		if sSpells < 1 then
			sSpells = 1;
		end
		if nClassLevel < 2 then
			sSpells = 0;
		end
		window.cantrips_available.setValue(sCantrips .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);
		aSlots = PALADIN_SPELLS[nClassLevel];			
	elseif sClassName == "RANGER" then
		sCantrips = 0;
		sSpells = RANGER_SPELLS[nClassLevel][11];
		window.cantrips_available.setValue(sCantrips .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);
		aSlots = RANGER_SPELLS[nClassLevel];			
	elseif sClassName == "WIZARD" then
		sCantrips = WIZARD_SPELLS[nClassLevel][1];
		sSpells = ((nClassLevel - 1) * 2) + 6;
		window.cantrips_available.setValue(sCantrips - nCantripsSelected .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);
		aSlots = WIZARD_SPELLS[nClassLevel];
	elseif sClassName == "ELDRITCH KNIGHT" or sClassName == "ARCANE TRICKSTER" then
		if sClassName == "ELDRITCH KNIGHT" then
			sCantrips = KNIGHT_SPELLS[nClassLevel][1];
			sSpells = KNIGHT_SPELLS[nClassLevel][11];
			aSlots = KNIGHT_SPELLS[nClassLevel];
		else
			sCantrips = TRICKSTER_SPELLS[nClassLevel][1];
			sSpells = TRICKSTER_SPELLS[nClassLevel][11];
			aSlots = TRICKSTER_SPELLS[nClassLevel];				
		end
		window.cantrips_available.setValue(sCantrips - nCantripsSelected .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);			
	elseif sClassName == "WARLOCK" then
		sCantrips = WARLOCK_SPELLS[nClassLevel][1];
		sSpells = WARLOCK_SPELLS[nClassLevel][2];
		window.cantrips_available.setValue(sCantrips - nCantripsSelected .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells - nSpellsSelected .. "/" .. sSpells);
		aSlots = WARLOCK_SPELLS[nClassLevel];
	else
		sCantrips = 0;
		sSpells = 0;
		window.cantrips_available.setValue(sCantrips .. "/" .. sCantrips);
		window.spells_available.setValue(sSpells .. "/" .. sSpells);			
	end

	if sClassName ~= "" then
		if sClassName ~= "WARLOCK" then
			local nMaxSpellLevel = -1;
			for i = 1,#aSlots do
				if aSlots[i] ~= 0 and i < 10 then
					nMaxSpellLevel = nMaxSpellLevel + 1
				end
			end
			for _,vClass in pairs(CampaignRegistry.charwizard.classes) do
				if vClass.name == string.lower(sClassName) or vClass.spec == string.lower(sClassName) then
					vClass.maxspelllevel = nMaxSpellLevel;
				end
			end
			if #CampaignRegistry.charwizard.classes > 1 then
				nClassLevel = wndSummary.calcSpellcastingLevel()
				aSlots = MULTICLASS_SPELLS[nClassLevel];
			end
			for i=1,9 do
				window["slots_available_" .. i].setValue(aSlots[i+1]);
				if (aSlots[i+1] == 0 and #CampaignRegistry.charwizard.classes == 1) or (i > nMaxSpellLevel and #CampaignRegistry.charwizard.classes > 1) then
					window["button_spelllevel_" .. i].setEnabled(false);
					window["button_spelllevel_" .. i].setFrame("buttondisabled", 5,5,5,5);
			
				else
					window["button_spelllevel_" .. i].setEnabled(true);
					window["button_spelllevel_" .. i].setFrame("buttonup", 5,5,5,5);
					window["slots_available_" .. i].setVisible(true);
					window["label_slots_available_" .. i].setVisible(true);
				end
				if aSlots[i+1] == 0 then
					window["slots_available_" .. i].setVisible(false);
					window["label_slots_available_" .. i].setVisible(false);				
				else
					window["slots_available_" .. i].setVisible(true);
					window["label_slots_available_" .. i].setVisible(true);
				end
			end
		else
			for i=1,9 do
				if aSlots[4] >= i then
					window["button_spelllevel_" .. i].setEnabled(true);				
					window["slots_available_" .. i].setValue(aSlots[3]);
					window["slots_available_" .. i].setVisible(true);
					window["label_slots_available_" .. i].setVisible(true);
					window["button_spelllevel_" .. i].setFrame("buttonup", 5,5,5,5);					
				else
					window["button_spelllevel_" .. i].setEnabled(false);
					window["slots_available_" .. i].setVisible(false);
					window["label_slots_available_" .. i].setVisible(false);
					window["button_spelllevel_" .. i].setFrame("buttondisabled", 5,5,5,5);				
				end
			end		
		end
	end
end

function getSpellBonus(sBonus, sRaceBonus)
	local nAbilityBonus = 0;
	local nStatScore = CampaignRegistry.charwizard.abilities[sBonus];
	local nRaceScore = CampaignRegistry.charwizard.race.abilities[sRaceBonus];
	if nStatScore and nRaceScore then
		nStatScore = nStatScore + nRaceScore;
		if nStatScore < 0 then
			nStatScore = 0;
		end
		nAbilityBonus = math.floor((nStatScore - 10) / 2);
	elseif nStatScore then
		if nStatScore < 0 then
			nStatScore = 0;
		end			
		nAbilityBonus = math.floor((nStatScore - 10) / 2);
	end
	return nAbilityBonus;
end