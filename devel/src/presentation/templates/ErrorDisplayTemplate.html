<!-- 
  ErrorDisplay Component Template
  
  User-friendly error display with recovery actions and feedback mechanisms.
  Integrates with the centralized ErrorService for comprehensive error handling.
-->
<div 
  x-data="errorDisplayComponent" 
  x-show="isVisible" 
  x-transition:enter="transition ease-out duration-300" 
  x-transition:enter-start="opacity-0 transform scale-95" 
  x-transition:enter-end="opacity-100 transform scale-100" 
  x-transition:leave="transition ease-in duration-200" 
  x-transition:leave-start="opacity-100 transform scale-100" 
  x-transition:leave-end="opacity-0 transform scale-95"
  class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50"
  role="dialog"
  aria-modal="true"
  aria-labelledby="error-title"
  data-error-focus
  tabindex="-1"
>
  <div 
    class="relative w-full max-w-2xl max-h-screen overflow-y-auto bg-white rounded-lg shadow-xl"
    @click.stop
  >
    <!-- Error Header -->
    <div 
      class="flex items-start justify-between p-6 pb-4"
      :class="getSeverityClass(currentError?.severity)"
    >
      <div class="flex items-center space-x-3">
        <!-- Severity Icon -->
        <div 
          class="flex-shrink-0 text-2xl"
          x-text="getSeverityIcon(currentError?.severity)"
        ></div>
        
        <!-- Error Title and Category -->
        <div>
          <h2 
            id="error-title" 
            class="text-lg font-semibold text-gray-900"
            x-text="currentError?.title || 'Unknown Error'"
          ></h2>
          <p 
            class="text-sm text-gray-600"
            x-text="getCategoryDescription(currentError?.category)"
          ></p>
        </div>
      </div>
      
      <!-- Severity Badge -->
      <div class="flex items-center space-x-2">
        <span 
          class="px-2 py-1 text-xs font-medium rounded-full bg-white bg-opacity-20"
          x-text="errorSeverityText"
        ></span>
        
        <!-- Close Button -->
        <button
          @click="hideError()"
          class="p-1 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 rounded-full"
          aria-label="Close error dialog"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Error Content -->
    <div class="px-6 pb-6 space-y-4">
      <!-- Main Error Message -->
      <div class="prose prose-sm max-w-none">
        <p 
          class="text-gray-700 leading-relaxed"
          x-text="currentError?.message"
        ></p>
      </div>
      
      <!-- Error Details (Expandable) -->
      <div x-show="currentError && (hasTechnicalDetails || currentError.characterId)">
        <button
          @click="toggleExpanded()"
          class="flex items-center space-x-2 text-sm font-medium text-gray-600 hover:text-gray-900 focus:outline-none focus:underline"
          :aria-expanded="isExpanded"
        >
          <svg 
            class="w-4 h-4 transform transition-transform duration-200"
            :class="{ 'rotate-90': isExpanded }"
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
          <span>Show Details</span>
        </button>
        
        <div 
          x-show="isExpanded" 
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          class="mt-3 p-4 bg-gray-50 rounded-lg space-y-3"
        >
          <!-- Character Information -->
          <div x-show="currentError?.characterId">
            <h4 class="text-sm font-medium text-gray-900 mb-2">Character Information</h4>
            <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
              <dt class="text-gray-500">Character ID:</dt>
              <dd class="font-mono text-gray-900" x-text="currentError?.characterId"></dd>
              <dt class="text-gray-500" x-show="currentError?.characterName">Character Name:</dt>
              <dd class="text-gray-900" x-text="currentError?.characterName" x-show="currentError?.characterName"></dd>
            </dl>
          </div>
          
          <!-- Technical Details -->
          <div x-show="hasTechnicalDetails && showTechnicalDetails">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-medium text-gray-900">Technical Details</h4>
              <button
                @click="toggleTechnicalDetails()"
                class="text-xs text-gray-500 hover:text-gray-700 focus:outline-none focus:underline"
              >
                Hide
              </button>
            </div>
            <pre 
              class="text-xs text-gray-700 bg-gray-100 p-3 rounded border overflow-x-auto"
              data-technical-details
              x-text="currentError?.technicalDetails"
            ></pre>
          </div>
          
          <div x-show="hasTechnicalDetails && !showTechnicalDetails">
            <button
              @click="toggleTechnicalDetails()"
              class="text-sm text-gray-600 hover:text-gray-900 focus:outline-none focus:underline"
            >
              Show Technical Details
            </button>
          </div>
          
          <!-- Error Metadata -->
          <div class="text-xs text-gray-500 space-y-1">
            <div>Error ID: <span class="font-mono" x-text="currentError?.id"></span></div>
            <div>Timestamp: <span x-text="formatTimestamp(currentError?.timestamp)"></span></div>
            <div x-show="currentError?.step">Step: <span x-text="currentError?.step"></span></div>
            <div x-show="currentError?.component">Component: <span x-text="currentError?.component"></span></div>
          </div>
        </div>
      </div>
      
      <!-- Recovery Actions -->
      <div x-show="hasRecoveryActions && !isRecovering" class="space-y-3">
        <h3 class="text-sm font-medium text-gray-900">Try These Solutions:</h3>
        
        <div class="grid gap-2">
          <template x-for="action in availableActions" :key="action">
            <button
              @click="performRecoveryAction(action)"
              :data-recovery-action="action"
              class="flex items-center justify-between w-full p-3 text-left bg-blue-50 hover:bg-blue-100 focus:bg-blue-100 border border-blue-200 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              :disabled="isRecovering"
            >
              <div class="flex items-center space-x-3">
                <span class="text-lg" x-text="getRecoveryActionIcon(action)"></span>
                <span class="text-sm font-medium text-blue-900" x-text="getRecoveryActionLabel(action)"></span>
              </div>
              
              <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          </template>
        </div>
      </div>
      
      <!-- Recovery Progress -->
      <div x-show="isRecovering" class="flex items-center justify-center p-8">
        <div class="flex items-center space-x-3">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <span class="text-sm text-gray-600">Attempting recovery...</span>
        </div>
      </div>
      
      <!-- Recovery Results -->
      <div x-show="recoveryResults.length > 0" class="space-y-2">
        <h4 class="text-sm font-medium text-gray-900">Recovery Results:</h4>
        
        <template x-for="result in recoveryResults" :key="result.action">
          <div 
            class="p-3 rounded-lg border"
            :class="{
              'bg-green-50 border-green-200': result.success,
              'bg-red-50 border-red-200': !result.success
            }"
          >
            <div class="flex items-center space-x-2">
              <span 
                class="text-sm"
                :class="{
                  'text-green-600': result.success,
                  'text-red-600': !result.success
                }"
                x-text="result.success ? '✅' : '❌'"
              ></span>
              <span 
                class="text-sm font-medium"
                :class="{
                  'text-green-900': result.success,
                  'text-red-900': !result.success
                }"
                x-text="getRecoveryActionLabel(result.action)"
              ></span>
            </div>
            <p 
              class="mt-1 text-sm"
              :class="{
                'text-green-700': result.success,
                'text-red-700': !result.success
              }"
              x-text="result.message"
            ></p>
          </div>
        </template>
      </div>
      
      <!-- User Feedback Section -->
      <div x-show="canShowFeedback" class="border-t pt-4">
        <div x-show="!showFeedbackForm">
          <button
            @click="toggleFeedbackForm()"
            class="text-sm text-gray-600 hover:text-gray-900 focus:outline-none focus:underline"
          >
            💬 Report this issue or suggest improvements
          </button>
        </div>
        
        <div x-show="showFeedbackForm" class="space-y-3">
          <h4 class="text-sm font-medium text-gray-900">Help us improve:</h4>
          
          <textarea
            x-model="userFeedbackText"
            data-feedback-textarea
            placeholder="Describe what you were trying to do or suggest how we could make this better..."
            class="w-full p-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
            rows="3"
            maxlength="1000"
          ></textarea>
          
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500" x-text="`${userFeedbackText.length}/1000 characters`"></span>
            
            <div class="flex space-x-2">
              <button
                @click="toggleFeedbackForm(); userFeedbackText = ''"
                class="px-3 py-1 text-sm text-gray-600 hover:text-gray-900 focus:outline-none focus:underline"
              >
                Cancel
              </button>
              <button
                @click="submitFeedback()"
                :disabled="!userFeedbackText.trim()"
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Send Feedback
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer Actions -->
    <div class="flex items-center justify-end px-6 py-4 bg-gray-50 rounded-b-lg space-x-3">
      <button
        @click="hideError()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 border border-gray-300 rounded-md"
      >
        Close
      </button>
      
      <div x-show="hasRecoveryActions && !isRecovering">
        <button
          @click="performRecoveryAction(availableActions[0])"
          x-show="availableActions.length > 0"
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md"
          x-text="'Try ' + getRecoveryActionLabel(availableActions[0])"
        ></button>
      </div>
    </div>
  </div>
</div>

<!-- Global Error Display Container -->
<div id="global-error-display" x-data="createErrorDisplay()">
  <!-- The error display component will be rendered here when needed -->
</div>

<style>
/* Custom styles for error display */
.error-display-enter {
  opacity: 0;
  transform: scale(0.95);
}

.error-display-enter-active {
  transition: opacity 300ms ease-out, transform 300ms ease-out;
}

.error-display-enter-to {
  opacity: 1;
  transform: scale(1);
}

.error-display-leave {
  opacity: 1;
  transform: scale(1);
}

.error-display-leave-active {
  transition: opacity 200ms ease-in, transform 200ms ease-in;
}

.error-display-leave-to {
  opacity: 0;
  transform: scale(0.95);
}

/* Focus management */
.error-display [data-error-focus]:focus {
  outline: 2px solid var(--color-primary-500);
  outline-offset: 2px;
}

/* Responsive adjustments */
@media (max-width: 640px) {
  .error-display .max-w-2xl {
    max-width: calc(100vw - 2rem);
    margin: 1rem;
  }
  
  .error-display .grid-cols-2 {
    grid-template-columns: 1fr;
  }
}
</style>